<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arribos a Cedis — base+fecha+no — v3-tabla-2x-fixed — cajas/tarimas — cajas/tarimas v3.2 — admin-orden-fit — admin-desc-fix — tablero-detalle-acciones — req123 — backmenu+libdate</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#111826;
      --fg:#e8eef6;
      --muted:#9fb0c3;
      --line:#223044;
      --accent:#ff8a00;

      /* Colores tipo Excel de tus capturas */
      --st-pend:#C6E0B4;         /* pendiente fumigación */
      --st-hold:#B7B7B7;         /* no descargar */
      --st-cuar:#FFF2CC;         /* cuarentena */
      --st-rech:#FF0000;         /* rechazado / fumigación crítica */
      --st-proc:#FFC000;         /* en proceso */
      --st-ok:#92D050;           /* concluida / liberado */
      --st-rep:#F4B6E3;          /* reportado */
      --st-esp:#D9E1F2;          /* espera (neutro) */
    }
html,body{overflow-y:auto;overflow-x:hidden;}

    html,body{height:100%;}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;}

    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 16px;border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, rgba(17,24,38,0.95), rgba(11,15,20,0.85));
      position:sticky;top:0;z-index:20;gap:14px;
    }
    .brand{display:flex;align-items:center;gap:14px;min-width:260px;}
    .brand img{height:102px;width:auto;filter:drop-shadow(0 2px 10px rgba(0,0,0,0.35));}
    .brand b{display:block;font-size:56px;letter-spacing:0.2px;line-height:1;}

    .tabs{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .tab{border:1px solid var(--line);background:transparent;color:var(--fg);padding:8px 12px;border-radius:12px;cursor:pointer;font-weight:800;font-size:14px;}
    .tab.active{background:var(--panel);border-color:#2a3a52;}

    .right{display:flex;align-items:center;gap:12px;justify-content:flex-end;}
    .chip{background:#162235;border:1px solid var(--line);padding:7px 10px;border-radius:999px;color:var(--muted);font-size:12px;}
    .clock{font-variant-numeric:tabular-nums;color:var(--muted);font-size:13px;white-space:nowrap;}

    .wrap{max-width:1600px;margin:0 auto;padding:14px 16px;}

    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px;}
    .input, select{background:var(--panel);border:1px solid var(--line);color:var(--fg);padding:9px 10px;border-radius:12px;outline:none;}
    .btn{background:var(--accent);border:0;color:#111;font-weight:900;padding:9px 12px;border-radius:12px;cursor:pointer;}
    .btn.secondary{background:transparent;border:1px solid var(--line);color:var(--fg);font-weight:800;}
    .btn.danger{background:#e74c3c;color:#fff;}

    .kpis{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 12px 0;}
    .kpis .chip b{color:var(--fg)}

        .tableWrap{width:100%;border:1px solid var(--line);border-radius:14px;overflow:visible;background:rgba(17,24,38,0.6);}
    .table{width:100%;border-collapse:separate;border-spacing:0;overflow:visible;border-radius:0;border:0;background:transparent;}
    .table thead th{
      position:sticky;top:0;
      background:rgba(17,24,38,0.98);
      border-bottom:1px solid var(--line);
      text-align:left;font-size:12px;color:var(--muted);
      padding:8px 10px;letter-spacing:0.08em;text-transform:uppercase;
      z-index:10;cursor:pointer;user-select:none;
      white-space:nowrap;
    }
    .table tbody td{padding:5px 10px;border-bottom:1px solid rgba(34,48,68,0.65);vertical-align:top;font-size:12px;line-height:1.25;}
    .table tbody tr:hover td{background:rgba(255,255,255,0.03);}

    /* Column sizing tweaks */
    .table th[data-key="cedis"], .table td[data-key="cedis"]{white-space:nowrap;width:1%;}
    .table th[data-key="contenedor"], .table td[data-key="contenedor"]{width:25ch;max-width:25ch;}
    .table td[data-key="contenedor"]{white-space:normal;}
    .clamp2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;word-break:break-word;}
    .clamp3{display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;word-break:break-word;white-space:normal;}
    /* INDICACIÓN: 2 renglones (forzados) y ancho proporcional */
    #boardView th[data-key="indicacion"], #boardView td[data-key="indicacion"]{
      white-space: normal !important;
      width: var(--indW, 28ch);
      max-width: var(--indW, 28ch);
    }
    #boardView td[data-key="indicacion"] .ind2{
      display:block;
      line-height:1.15;
    }
    #boardView td[data-key="indicacion"] .ind2 > span{
      display:block;                 /* 2 renglones exactos */
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* FECHA siempre activa (no desmarcable) */
    #cols input[data-locked="1"]{ cursor:not-allowed; opacity:.75; }



    .mono{font-variant-numeric:tabular-nums;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,monospace;}

    .status-block{display:inline-block;padding:7px 10px;border-radius:8px;font-weight:1000;text-transform:uppercase;color:#111;}
    .st-reportado{background:var(--st-rep);} 
    .st-espera{background:var(--st-esp);} 
    .st-hold{background:var(--st-hold);} 
    .st-pend{background:var(--st-pend);} 
    .st-cuar{background:var(--st-cuar);} 
    .st-proceso{background:var(--st-proc);} 
    .st-ok{background:var(--st-ok);} 
    .st-rech{background:var(--st-rech);color:#fff;} 

    .muted{color:var(--muted);} 

    .hidden{display:none !important;}

    .card{background:rgba(17,24,38,0.6);border:1px solid var(--line);border-radius:14px;padding:14px;}
    .grid{display:grid;gap:12px;}

    .dash2x2{grid-template-columns: 1fr 1fr;}
    .dashKpiGrid{display:grid;grid-template-columns: repeat(2, 1fr);gap:10px;}
    .dashKpiTile{background:rgba(255,255,255,0.04);border:1px solid rgba(34,48,68,0.7);border-radius:14px;padding:12px;}
    .dashKpiNum{font-size:26px;font-weight:1000;letter-spacing:0.2px;font-variant-numeric:tabular-nums;}
    .dashKpiLabel{margin-top:2px;font-size:12px;color:var(--muted);font-weight:800;text-transform:uppercase;letter-spacing:0.4px;}
    .two{grid-template-columns: 1.15fr 0.85fr;}
    @media (max-width: 1100px){
      .two{grid-template-columns: 1fr;}
      .dash2x2{grid-template-columns: 1fr;}
      .brand img{height:70px;}
      .brand b{font-size:36px;}
    }

    /* Modal detalle */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:40;display:flex;align-items:center;justify-content:center;padding:16px;}
    .modal{width:min(720px, 96vw);background:rgba(17,24,38,0.98);border:1px solid var(--line);border-radius:16px;box-shadow:0 20px 80px rgba(0,0,0,0.55);}
    .modal .hd{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--line);gap:10px;}
    .modal .bd{padding:12px 14px;}
    .modal .bd .row{display:grid;grid-template-columns: 160px 1fr;gap:10px;padding:6px 0;border-bottom:1px solid rgba(34,48,68,0.55);}
    .modal .bd .row:last-child{border-bottom:none;}
    .modal .bd .k{color:var(--muted);font-size:12px;}
    .modal .bd .v{font-size:13px;}

    /* Columnas: ocultar */
    .hidden-col{display:none;}
  
    /* Admin layout refinements */
    .admin-two{grid-template-columns: 1.75fr 0.55fr;}
    @media (max-width: 1100px){
      .admin-two{grid-template-columns: 1fr;}
    }
    .compact{padding:10px;}
    .concepts-card #statusHelp{font-size:11px;line-height:1.35;max-height:230px;overflow:auto;padding-right:6px;}
    .admin-session{padding:8px 10px !important;}
    .admin-row{padding:10px;margin-bottom:8px;}

    /* Subvistas: Por llegar / Histórico */
    .subview-head{display:flex;justify-content:space-between;gap:10px;align-items:flex-end;flex-wrap:wrap;margin-bottom:10px}
    .subview-head .h1{font-size:18px;font-weight:900;margin:0}
    .subview-head .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .subview-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .filtersRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .colsCardSmall{padding:10px;margin-top:8px}
    .admin-row-top{display:flex;gap:10px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;}
    .admin-controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .admin-controls select{min-width:220px;}
    .admin-info{flex:1;min-width:260px;}
    .admin-title{font-weight:1000}
    .admin-meta{font-size:12px;line-height:1.35;}
    .admin-meta .mono{font-variant-numeric:tabular-nums;}
    .admin-status{margin-left:auto;}
    /* Auth modal */
    .modal.auth{width:min(680px, 96vw);}


    .btn.tiny{padding:7px 10px;border-radius:10px;font-size:12px;font-weight:800;}

/* --- Ajuste: tabla más compacta + letras 2x con auto-escala por columnas visibles --- */
:root{ --tblScale: 2; }
.table thead th, .table tbody td{
  font-size: calc(12px * var(--tblScale));
}
.table thead th{ padding: 4px 6px; letter-spacing: 0.06em; }
.table tbody td{ padding: 4px 6px; line-height: 1.15; }
/* ----------------------------------------------------------------------------------- */


/* --- Ajuste: TABLERO sin barras visibles + auto-fit a pantalla --- */
.tableWrap{
  overflow:auto;
  scrollbar-width:none;
  -ms-overflow-style:none;
}
.tableWrap::-webkit-scrollbar{
  width:0; height:0; display:none;
}
#table{ width:100%; }
/* --------------------------------------------------------------- */


/* --- REQ#2 TABLERO: auto-ajuste a pantalla (sin scroll de página, sin barras visibles) --- */
:root{ --tblScale: 2; }
#boardView{min-height:calc(100vh - 90px);height:auto;overflow:visible;}
#boardView .tableWrap{
  overflow:auto;
  scrollbar-width:none;
  -ms-overflow-style:none;
}
#boardView .tableWrap::-webkit-scrollbar{ width:0; height:0; display:none; }

#boardView #table{ width:100%; table-layout:auto; }
#boardView #table thead th, #boardView #table tbody td{
  font-size: calc(12px * var(--tblScale));
  text-align:center;
  vertical-align:middle;
  white-space:nowrap;
}
#boardView #table thead th{ padding: 4px 6px; letter-spacing:0.06em; }
#boardView #table tbody td{ padding: 4px 6px; line-height:1.1; }
/* -------------------------------------------------------------------- */

/* --- REQ#3 ADMIN: mostrar conceptos completos (sin scroll) --- */
#adminView #statusHelp{
  max-height:none !important;
  overflow:visible !important;
}
/* ----------------------------------------------------------- */

/* --- REQ#3 ADMIN: solo captura + conceptos (oculta Unidades/Historial) --- */
#adminView .unitsCard, #adminView .historyCard{ display:none !important; }
/* ----------------------------------------------------------------------- */


/* Multi-select filter (Estatus) */
.ms{position:relative;display:inline-block;}
.msBtn{cursor:pointer;white-space:nowrap;}
.msMenu{position:absolute;top:calc(100% + 8px);left:0;min-width:260px;max-height:320px;overflow:auto;
  background:#0e1727;border:1px solid rgba(255,255,255,.12);border-radius:12px;box-shadow:0 16px 40px rgba(0,0,0,.45);
  padding:10px;z-index:50;}
.msMenu.hidden{display:none;}
.msHead{display:flex;gap:8px;justify-content:space-between;margin-bottom:8px;}
.msAction{flex:1;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:var(--fg);
  border-radius:10px;padding:6px 8px;font-weight:700;cursor:pointer;}
.msList{display:flex;flex-direction:column;gap:6px;}
.msItem{display:flex;gap:10px;align-items:center;padding:6px 8px;border-radius:10px;cursor:pointer;
  background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);}
.msItem:hover{background:rgba(255,255,255,.06);}
.msItem input{transform:scale(1.15);}


/* --- PANTALLA view styles --- */
#screenView{ padding-top: 0; }
#screenView .tableWrap{ overflow:hidden; }
#tableScreen{ width:100%; table-layout:auto; }
#tableScreen thead th, #tableScreen tbody td{ text-align:center; white-space:nowrap; }
/* --------------------------- */


    .screenHeader{display:flex;justify-content:space-between;align-items:flex-end;gap:16px;padding:10px 12px;border:1px solid rgba(255,255,255,0.07);border-radius:14px;background:rgba(18,26,38,0.55);backdrop-filter: blur(10px);margin-top:10px}
    .screenTitle{display:flex;flex-direction:column;gap:2px}
    .screenH1{font-size:22px;font-weight:800;letter-spacing:0.02em}
    .screenSubtitle{font-size:12px;opacity:0.8;letter-spacing:0.18em}
    .screenMeta{display:flex;flex-wrap:wrap;justify-content:flex-end;gap:8px;align-items:center}


  /* RESUMEN */
  #summaryWrap .table th, #summaryWrap .table td{ white-space:nowrap; }
  #summaryWrap .table td:first-child{ white-space:nowrap; }
  .sumRowTop td{ border-top:2px solid rgba(255,255,255,.12); }

/* --- REQ#4 TABLERO: mostrar barra horizontal (sin ocultar scrollbars) --- */
#boardView .tableWrap{ overflow:auto !important; scrollbar-width:auto !important; -ms-overflow-style:auto !important; padding-bottom:10px; }
#boardView .tableWrap::-webkit-scrollbar{ height:12px !important; width:12px !important; display:block !important; }
#boardView #table{ width:max-content !important; min-width:100% !important; }
#boardView #table thead th, #boardView #table tbody td{ white-space:nowrap; }

/* --- REQ#6 TABLERO: Indicación en 3 renglones (más esbelta) --- */
#boardView td[data-key="indicacion"]{ text-align:left; }
#screenView td[data-key="indicacion"]{ text-align:left; }

/* --- REQ#8 RESUMEN: sombrear encabezados por estatus (mismos colores del tablero) --- */
#tableSummary thead th.sumHdr{ color:#111; font-weight:900; }
#tableSummary thead th.sumHdr.st-reportado{ background: var(--st-rep); }
#tableSummary thead th.sumHdr.st-pend{ background: var(--st-pend); }
#tableSummary thead th.sumHdr.st-ok{ background: var(--st-ok); }
#tableSummary thead th.sumHdr.st-proceso{ background: var(--st-proc); }
#tableSummary thead th.sumHdr.st-espera{ background: var(--st-esp); }
#tableSummary thead th.sumHdr.st-hold{ background: var(--st-hold); }
#tableSummary thead th.sumHdr.st-cuar{ background: var(--st-cuar); }
#tableSummary thead th.sumHdr.st-rech{ background: var(--st-rech); color:#fff; }

    /* ---- ASISTENCIA (ADMIN) ---- */
    #attendanceCard .table thead th{font-size:12px;letter-spacing:0.02em;}
    #attendanceCard .table tbody td{padding-top:10px;padding-bottom:10px;vertical-align:middle;}
    #attendanceCard .att-name{font-weight:800;}
    #attendanceCard .att-time{width:140px;}
    #attendanceCard .att-present{display:flex;align-items:center;gap:10px;}
    #attendanceCard .att-audit-item{display:flex;gap:10px;align-items:flex-start;padding:8px 10px;border:1px solid var(--line);border-radius:12px;background:rgba(17,24,38,0.35);margin-bottom:8px;}
    #attendanceCard .att-audit-item .when{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:12px;opacity:.9;min-width:132px}
    #attendanceCard .att-audit-item .msg{font-size:12px;line-height:1.35}

    /* SVA: tabla a ancho completo */
    #wrapSVA{overflow-x:auto;}
    #wrapSVA .table{width:100%;}

  
    /* SVA: barra horizontal visible + tabla ancho completo */
    #svaView .tableWrap{ overflow:auto !important; padding-bottom:10px; scrollbar-width:auto !important; -ms-overflow-style:auto !important; }
    #svaView .tableWrap::-webkit-scrollbar{ height:12px !important; width:12px !important; display:block !important; }
    #svaView #svaTable{ width:max-content; min-width:100%; table-layout:auto; }
    #svaView .svaDetails summary{ cursor:pointer; }
    #svaView .svaMaqItem{display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-top:6px}
    #svaView .svaMaqItem .chip{cursor:default}
    .svaFocus{outline:2px solid rgba(255,153,0,.65); box-shadow:0 0 0 4px rgba(255,153,0,.12);}


/* ===== SVA: scrollbar horizontal dedicado ===== */
.svaTableWrapOuter{ position: relative; }
#svaTableWrap{ overflow-x:auto; overflow-y:visible; }
#svaTable{ width:100%; min-width: 1600px; }
#svaTable th, #svaTable td{ white-space:nowrap; }
#svaTable td[data-key="indicacion"]{ white-space:normal; min-width:260px; max-width:520px; }
.svaHScroll{
  overflow-x:auto;
  overflow-y:hidden;
  height:14px;
  margin-top:6px;
  border-radius:10px;
  background: rgba(255,255,255,.04);
  border: 1px solid rgba(255,255,255,.06);
}
.svaHScrollInner{ height:1px; }
.svaMaqItem{ display:flex; gap:6px; align-items:center; flex-wrap:wrap; margin-bottom:6px; }
#svaView .btn.tiny{ padding:6px 10px; font-size:12px; }

</style>
</head>
<body>
  <div class="topbar" id="topbar">
    <div class="brand">
      <img alt="Logo" src="data:image/png;base64,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" />
      <div>
        <b>Arribos a Cedis</b>
      </div>
    </div>

    <div class="tabs">
      <button class="tab" id="tabSummary">RESUMEN</button>
      <div class="tabCol">
      <button class="tab active" id="tabBoard">TABLERO</button>
      <button class="btn secondary tiny" id="btnExport" title="Exportar tabla a Excel">EXPORTAR</button>
      </div>
      <button class="tab" id="tabDashboard">DASHBOARD</button>
      <button class="tab" id="tabScreen">PANTALLA</button>
      <button class="tab" id="tabAdmin">ADMIN</button>
      <button class="tab" id="tabSVA">SVA</button>
      <button class="tab" id="tabLogistica">LOGÍSTICA</button>
    </div>

    <div class="right">
      <button class="btn secondary" id="btnCloud">Nube</button>
      <div class="chip" id="chipCloud">Nube: —</div>
      <div class="chip" id="chipMode">Modo: Tablero</div>
      <div class="clock" id="clock">--</div>
    </div>
  </div>

  <div class="wrap">

    <section id="boardView">
      <div class="controls">
        <input class="input" id="q" placeholder="Buscar: contenedor / cedis / andén / responsable" style="flex:1;min-width:240px" />

        <div class="ms" id="cedisMs"><button id="cedisBtn" class="input msBtn" type="button">CEDIS: Todos ▾</button><div id="cedisMenu" class="msMenu hidden" role="menu" aria-label="Filtro CEDIS"></div></div><!-- keep legacy select hidden for compatibility (not used) --><select id="cedis" class="hidden"><option value=""></option></select>

        <div class="ms" id="estatusMs"><button id="estatusBtn" class="input msBtn" type="button">Estatus: Todos ▾</button><div id="estatusMenu" class="msMenu hidden" role="menu" aria-label="Filtro Estatus"></div></div>

        <div class="dateRange"><span class="muted">Inicio</span><input class="input" id="dateStart" type="date" style="min-width:160px" /><span class="muted">Fin</span><input class="input" id="dateEnd" type="date" style="min-width:160px" /></div>
        <button class="btn secondary" id="btnToday">Hoy</button>

        <button class="btn secondary" id="toggleCols">Columnas</button>
        <button class="btn secondary" id="toggleFullscreen">Pantalla completa</button>
      </div>

      <div class="card hidden" id="colsCard">
        <div class="muted" style="font-size:12px;margin-bottom:10px">Selecciona qué columnas mostrar en el tablero.</div>
        <div id="cols"></div>
      </div>

      <div class="kpis" id="kpis"></div>

      <div class="tableWrap" id="tableWrap">
      <table class="table" id="table">
        <thead>
          <tr>
                        <th data-key="folio">No</th>
            <th data-key="contenedor">Contenedor</th>
            <th data-key="cuenta">Cuenta</th>
            <th data-key="cedis">Cedis</th>
            <th data-key="status">Estatus</th>
            <th data-key="fecha">Fecha</th>
            <th data-key="indicacion">Indicación</th>
            <th data-key="anden">Andén</th>
            <th data-key="arribo_at">Arribo</th>
            <th data-key="asignacion_at">Asig.</th>
            <th data-key="responsable">Responsable</th>
            <th data-key="inicio_at">Inicio</th>
            <th data-key="fin_at">Fin</th>
            <th data-key="descarga_concl_fecha">F. descarga concluida</th>
            <th data-key="liberado_fecha">F. liberación</th>
            <th data-key="cajas">Cajas</th>
            <th data-key="tarimas">Tarimas</th>
            <th data-key="pallets">Pallets</th>
            <th data-key="playos_utilizados">Playos</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      </div>

      <div style="display:flex;gap:10px;align-items:center;margin-top:10px">
        <button class="btn" id="toScreen">PANTALLA</button>
      </div>

      <div style="height:12px"></div>
      <div class="chip">
        <b>Regla:</b> En <u>Hoy</u> se muestra <u>todo el día</u> + cualquier unidad <u>pendiente</u> de días previos (activo).
        El <u>histórico</u> se consulta seleccionando una fecha.
        Para terminar el día natural, usa <u>Cerrar día</u>: archiva concluidos (no se borran, solo salen del activo).
      </div>
</section>


        
    
        <section id="dashboardView" class="hidden">
      <div class="screenCard">
        <div class="screenTop">
          <div>
            <div class="screenTitle">DASHBOARD</div>
            <div class="screenSub muted">Indicadores en tiempo real (según filtros del Tablero)</div>
          </div>
          <div class="screenMeta">
            <span class="chip small" id="dashMetaCedis">CEDIS: Todos</span>
            <span class="chip small" id="dashMetaEstatus">Estatus: Todos</span>
            <span class="chip small" id="dashMetaFecha">Fecha: </span>
          </div>
        </div>

        <div class="grid dash2x2" style="margin-top:12px">
          <!-- Cuadrante 1: KPI's -->
          <div class="card">
            <div class="muted" style="font-size:12px;margin-bottom:8px">KPI’s (según filtros)</div>
            <div class="dashKpiGrid" id="dashKpisGrid"></div>
          </div>

          <!-- Cuadrante 2: Cajas descargadas vs pendientes -->
          <div class="card">
            <div class="muted" style="font-size:12px;margin-bottom:8px">Cajas descargadas vs cajas pendientes</div>
            <div id="chartCajas" style="width:100%;height:320px"></div>
          </div>

          <!-- Cuadrante 3: Tiempo por contenedor -->
          <div class="card">
            <div class="muted" style="font-size:12px;margin-bottom:8px">Tiempo por contenedor (Arribo → Fin)</div>
            <div id="chartTiempo" style="width:100%;height:320px"></div>
          </div>

          <!-- Cuadrante 4: Indicaciones -->
          <div class="card">
            <div class="muted" style="font-size:12px;margin-bottom:8px">Indicación (conteo de contenedores)</div>
            <div id="chartIndicaciones" style="width:100%;height:320px"></div>
          </div>
        </div>
      </div>
    </section>

    <section id="summaryView" class="hidden">
      <div class="screenCard">
        <div class="screenTop">
          <div>
            <div class="screenTitle">CONTENEDORES POR ESTATUS</div>
            <div class="screenSub muted">RESUMEN</div>
          </div>
          <div class="screenMeta">
            <span class="chip small" id="sumMetaCedis">CEDIS: Todos</span>
            <span class="chip small" id="sumMetaEstatus">Estatus: Todos</span>
            <span class="chip small" id="sumMetaFecha">Fecha: </span>
            <span class="chip small" id="sumMetaPlantilla">Plantilla: 0</span>
            <span class="chip small" id="sumMetaManiobra">Maniobra: 0</span>
          </div>
        </div>

        <div class="tableWrap" id="summaryWrap" style="overflow:auto; padding-bottom:10px;">
          <table class="table" id="tableSummary">
            <thead id="theadSummary"></thead>
            <tbody id="tbodySummary"></tbody>
          </table>
        </div>

        <div class="muted" id="summaryInfo" style="margin-top:8px;"></div>
      </div>
    </section>

    <section id="screenView" class="hidden">
      <div class="screenHeader">
        <div class="screenTitle">
          <div class="screenH1">Arribos a Cedis</div>
          <div class="screenSubtitle">PANTALLA</div>
        </div>
        <div class="screenMeta">
          <div class="chip" id="screenMetaCedis">CEDIS: Todos</div>
          <div class="chip" id="screenMetaEstatus">Estatus: Todos</div>
          <div class="chip" id="screenMetaFecha"></div>
          <div class="muted" id="screenInfo" style="font-size:12px"></div>
        </div>
      </div>
      <div class="tableWrap" id="screenWrap" style="overflow:hidden">
        <table class="table" id="tableScreen">
          <thead>
            <tr>
                            <th data-key="folio">No</th>
              <th data-key="contenedor">Contenedor</th>
              <th data-key="cuenta">Cuenta</th>
              <th data-key="cedis">Cedis</th>
              <th data-key="status">Estatus</th>
              <th data-key="fecha">Fecha</th>
              <th data-key="indicacion">Indicación</th>
              <th data-key="anden">Andén</th>
              <th data-key="arribo_at">Arribo</th>
              <th data-key="asignacion_at">Asig.</th>
              <th data-key="responsable">Responsable</th>
              <th data-key="inicio_at">Inicio</th>
              <th data-key="fin_at">Fin</th>
              <th data-key="descarga_concl_fecha">F. descarga concluida</th>
              <th data-key="liberado_fecha">F. liberación</th>
              <th data-key="cajas">Cajas</th>
              <th data-key="tarimas">Tarimas</th>
              <th data-key="pallets">Pallets</th>
            <th data-key="playos_utilizados">Playos</th>
            </tr>
          </thead>
          <tbody id="tbodyScreen"></tbody>
        </table>
      </div>
      <div style="height:10px"></div>
      <div class="muted" style="font-size:12px">Para detener la rotación, presiona <b>TABLERO</b>.</div>


    </section>

    <section id="adminView" class="hidden">

      <div class="card compact admin-session" style="margin-bottom:10px">
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center">
          <div>
            <div style="font-weight:900;margin-bottom:2px">Acceso administrador</div>
            <div class="muted" id="authState" style="font-size:12px">No conectado.</div>
            <div class="muted" style="font-size:12px;margin-top:2px;line-height:1.2">Para <b>consulta</b> no necesitas iniciar sesión. Para <b>captura</b>, sí.</div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <button class="btn secondary" id="btnAdminPorLlegar" title="Ver/actualizar avisos">ARRIBOS POR LLEGAR</button>
            <button class="btn secondary" id="btnAdminHistorico" title="Consultar histórico">ARRIBOS HISTÓRICO</button>
            <button class="btn secondary" id="btnShowAuth">Iniciar sesión</button>
            <button class="btn secondary hidden" id="btnLogout">Salir</button>
          </div>
        </div>
      </div>
      <div class="grid admin-two">
        <div class="card compact">
          <div style="font-weight:900;margin-bottom:8px">Captura rápida (celular)</div>
          <div class="grid" style="grid-template-columns: repeat(2, minmax(0,1fr));">
            <div>
              <div class="muted" style="font-size:12px">CEDIS</div>
              <select id="f_cedis" class="input" style="width:100%"></select>
            </div>
            <div>
              <div class="muted" style="font-size:12px">Contenedor/Unidad</div>
              <input class="input" id="f_contenedor" placeholder="MRKU7608568 / placas" style="width:100%" />
            </div>
            <div>
              <div class="muted" style="font-size:12px">Cuenta</div>
              <input class="input" id="f_cuenta" placeholder="AKSI - ARRIBO 0012" style="width:100%" />
            </div>
            <div>
              <div class="muted" style="font-size:12px">Andén/Cortina</div>
              <input class="input" id="f_anden" placeholder="Z06" style="width:100%" />
            </div>
            <div>
              <div class="muted" style="font-size:12px">Responsable</div>
              <input class="input" id="f_responsable" placeholder="Oscar / Alejandro / Hugo" style="width:100%" />
            </div>
            <div>
              <div class="muted" style="font-size:12px">Indicación</div>
              <input class="input" id="f_indicacion" placeholder="Resguardo / plaga / etc" style="width:100%" />
            </div>
            <div>
              <div class="muted" style="font-size:12px">Cajas</div>
              <input class="input" id="f_cajas" inputmode="numeric" placeholder="" style="width:100%" />
            </div>
            <div>
              <div class="muted" style="font-size:12px">Tarimas</div>
              <input class="input" id="f_tarimas" placeholder="" style="width:100%" />
            </div>
            <div>
              <div class="muted" style="font-size:12px">Pallets</div>
              <input class="input" id="f_pallets" inputmode="numeric" placeholder="" style="width:100%" />
            </div>
            <div>
              <div class="muted" style="font-size:12px">Playos</div>
              <input class="input" id="f_playos" inputmode="numeric" placeholder="" style="width:100%" />
            </div>
          </div>
          <div style="height:10px"></div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <button class="btn" id="btnAdd">Agregar</button>
            <button class="btn secondary hidden" id="btnSeed">Cargar histórico 2026/01/07</button>
            <button class="btn secondary" id="btnCloseDay">Cerrar día (archivar concluidos)</button>
            <button class="btn danger" id="btnReset">Desconectar nube</button>
          </div>
          <div style="height:10px"></div>
          <div class="muted" style="font-size:12px;line-height:1.4">
            Esta versión está lista para <b>nube (Supabase)</b>: el administrador captura desde el celular y el tablero se actualiza en vivo. Los usuarios externos pueden consultar con acceso de solo lectura (RLS).
          </div>
        </div>

        <div class="card compact concepts-card">
          <div style="font-weight:900;margin-bottom:8px">Conceptos autorizados (estatus)</div>
          <div class="muted" style="font-size:12px;line-height:1.45" id="statusHelp"></div>
        </div>
      </div>

      <div style="height:12px"></div>
            <div class="card compact" id="attendanceCard">
        <div style="display:flex;justify-content:space-between;align-items:flex-end;gap:14px;flex-wrap:wrap;">
          <div>
            <div style="font-weight:900;margin-bottom:4px">Lista de asistencia</div>
            <div class="muted" style="font-size:12px;line-height:1.35">Por día y CEDIS. Marca presentes: se registra la hora de llegada y la huella de cambios.</div>
          </div>
          <div style="display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap;">
            <div>
              <div class="muted" style="font-size:12px">CEDIS</div>
              <select id="att_cedis" class="input" style="min-width:220px"></select>
            </div>
            <div>
              <div class="muted" style="font-size:12px">Inicio</div>
              <input id="att_start" type="date" class="input" style="width:150px" />
            </div>
            <div>
              <div class="muted" style="font-size:12px">Fin</div>
              <input id="att_end" type="date" class="input" style="width:150px" />
            </div>
            <div>
              <div class="muted" style="font-size:12px">&nbsp;</div>
              <button class="btn secondary" id="att_today">Hoy</button>
            </div>
            <div>
              <div class="muted" style="font-size:12px">&nbsp;</div>
              <button class="btn" id="att_update">Actualizar</button>
            </div>
            <div>
              <div class="muted" style="font-size:12px">Presentes</div>
              <div class="pill" id="att_count" style="font-weight:900;min-width:56px;text-align:center;">0</div>
            </div>

            <div>
              <div class="muted" style="font-size:12px">&nbsp;</div>
              <button class="btn secondary" id="att_roster_toggle">Editar plantilla</button>
            </div>
          </div>
        </div>

        <div style="height:10px"></div>

        <div id="att_roster_editor" class="hidden" style="border:1px dashed var(--line);border-radius:14px;padding:12px;background:rgba(17,24,38,0.35)">
          <div style="font-weight:800;margin-bottom:6px">Plantilla de personal (este CEDIS)</div>
          <div class="muted" style="font-size:12px;line-height:1.35;margin-bottom:8px">Pega la lista de nombres (uno por línea) y guarda. Se guarda en nube (si está conectada) y se conserva como respaldo en este navegador.</div>
          <textarea id="att_roster_text" class="input" rows="6" style="width:100%;resize:vertical" placeholder="Ej:
JUAN PEREZ
MARIA LOPEZ
..."></textarea>
          <div style="height:10px"></div>
          <button class="btn secondary" id="att_roster_save">Guardar plantilla</button>
        </div>

        <div id="att_range_panel" class="hidden" style="margin-top:10px">
          <div class="muted" style="font-size:12px;line-height:1.35;margin-bottom:8px">
            Rango: <span id="att_range_label"></span> (haz clic en una fecha para abrir el detalle editable)
          </div>
          <div class="tableWrap" style="overflow:auto;border:1px solid var(--line);border-radius:14px">
            <table class="table" style="min-width:520px">
              <thead>
                <tr>
                  <th style="width:140px">Fecha</th>
                  <th style="width:120px">Presentes</th>
                  <th style="width:120px">Maniobra</th>
                </tr>
              </thead>
              <tbody id="att_range_body"></tbody>
            </table>
          </div>
        </div>

        <div class="tableWrap" id="att_table_wrap" style="overflow:auto;border:1px solid var(--line);border-radius:14px">
          <table class="table" style="min-width:640px">
            <thead>
              <tr>
                <th style="width:92px">Presente</th>
                <th>Nombre</th>
                <th style="width:150px">Hora llegada</th>
              </tr>
            </thead>
            <tbody id="att_body"></tbody>
          </table>
        </div>

        <div style="height:12px"></div>

        <div class="grid" id="att_maneuvers_grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px">
          <div>
            <div class="muted" style="font-size:12px">MANIOBRA RODRIGUEZ</div>
            <input class="input" id="att_man_rodriguez" inputmode="numeric" placeholder="0" style="width:100%" />
          </div>
          <div>
            <div class="muted" style="font-size:12px">MANIOBRA HERNANDEZ</div>
            <input class="input" id="att_man_hernandez" inputmode="numeric" placeholder="0" style="width:100%" />
          </div>

          <div>
            <div class="muted" style="font-size:12px">MANIOBRA ZUÑIGA</div>
            <input class="input" id="att_man_zuniga" inputmode="numeric" placeholder="0" style="width:100%" />
          </div>
        </div>

        <details id="att_audit_details" style="margin-top:12px">
          <summary class="muted" style="cursor:pointer;font-size:12px">Bitácora (cambios de hoy)</summary>
          <div id="att_audit" style="margin-top:10px"></div>
        </details>
      </div>

      <div style="height:12px"></div>
<div class="card compact">
        <div style="font-weight:900;margin-bottom:8px">Unidades (acciones permitidas)</div>
        <div class="muted" style="font-size:12px;margin-bottom:10px">Los botones se ajustan al estatus actual (solo transiciones válidas).</div>
        <div id="adminList" class="unitsCard"></div>
      </div>

      <div style="height:12px"></div>
      <div class="card compact">
        <div style="font-weight:900;margin-bottom:8px">Historial / huella de cambios</div>
        <div id="audit"></div>
      </div>
    </section>


    <section id="porLlegarView" class="hidden">
      <div class="card compact" style="margin-bottom:12px">
        <div class="subview-head">
          <div>
            <div class="h1">Arribos por llegar</div>
            <div class="sub">Avisos / indicaciones (se actualiza desde Excel).</div>
          </div>
          <div class="subview-actions">
            <button class="btn secondary" id="btnBackPorLlegar">Volver a ADMIN</button>
            <button class="btn secondary" id="toggleColsPorLlegar">Columnas</button>
            <button class="btn secondary" id="btnReloadPorLlegar">Actualizar</button>
          </div>
        </div>

        <div class="filtersRow">
          <input class="input" id="porLlegarSearch" placeholder="Buscar: contenedor / nave / destino / indicación" style="min-width:320px;flex:1" />
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <span class="muted">Inicio</span><input class="input" id="porLlegarStart" type="date" style="min-width:160px" />
            <span class="muted">Fin</span><input class="input" id="porLlegarEnd" type="date" style="min-width:160px" />
          </div>
          <button class="btn secondary" id="btnPorLlegarHoy">Hoy</button>
        </div>

        <div class="card colsCardSmall hidden" id="colsPorLlegarCard">
          <div class="muted" style="font-size:12px;margin-bottom:8px">Selecciona columnas a mostrar (se guarda en este dispositivo).</div>
          <div id="colsPorLlegar"></div>
        </div>

        <div class="muted" id="porLlegarMeta" style="margin-top:10px;font-size:12px"></div>
      </div>

      <div class="tableWrap">
        <table class="table" id="porLlegarTable">
          <thead>
            <tr>
              <th data-key="contenedor_norm">Contenedor</th>
              <th data-key="fecha_arribo">Fecha arribo</th>
              <th data-key="destino">Destino</th>
              <th data-key="tipo_arribo">Tipo</th>
              <th data-key="nave">Nave</th>
              <th data-key="indicacion">Indicación</th>
              <th data-key="cajas">Cajas</th>
              <th data-key="piezas">Piezas</th>
              <th data-key="observaciones">Observaciones</th>
              <th data-key="descripcion">Descripción</th>
              <th data-key="updated_at">Actualizado</th>
            </tr>
          </thead>
          <tbody id="tbodyPorLlegar"></tbody>
        </table>
      </div>
    </section>

    <section id="historicoView" class="hidden">
      <div class="card compact" style="margin-bottom:12px">
        <div class="subview-head">
          <div>
            <div class="h1">Arribos histórico</div>
            <div class="sub">Consulta del histórico cargado (2025→2026).</div>
          </div>
          <div class="subview-actions">
            <button class="btn secondary" id="btnBackHistorico">Volver a ADMIN</button>
            <button class="btn secondary" id="toggleColsHistorico">Columnas</button>
            <button class="btn secondary" id="btnReloadHistorico">Actualizar</button>
          </div>
        </div>

        <div class="filtersRow">
          <input class="input" id="historicoSearch" placeholder="Buscar: contenedor / estatus / indicación / cedis" style="min-width:320px;flex:1" />
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <span class="muted">Inicio</span><input class="input" id="historicoStart" type="date" style="min-width:160px" />
            <span class="muted">Fin</span><input class="input" id="historicoEnd" type="date" style="min-width:160px" />
          </div>
          <button class="btn secondary" id="btnHistoricoHoy">Hoy</button>
        </div>

        <div class="card colsCardSmall hidden" id="colsHistoricoCard">
          <div class="muted" style="font-size:12px;margin-bottom:8px">Selecciona columnas a mostrar (se guarda en este dispositivo).</div>
          <div id="colsHistorico"></div>
        </div>

        <div class="muted" id="historicoMeta" style="margin-top:10px;font-size:12px"></div>
      </div>

      <div class="tableWrap">
        <table class="table" id="historicoTable">
          <thead>
            <tr>
              <th data-key="fecha_reporte">Fecha reporte</th>
              <th data-key="cedis">CEDIS</th>
              <th data-key="contenedor_norm">Contenedor</th>
              <th data-key="estatus">Estatus</th>
              <th data-key="indicacion">Indicación</th>
              <th data-key="cajas">Cajas</th>
              <th data-key="tarimas">Tarimas</th>
              <th data-key="reportado">Reportado</th>
              <th data-key="source_sheet">Hoja</th>
              <th data-key="created_at">Creado</th>
            </tr>
          </thead>
          <tbody id="tbodyHistorico"></tbody>
        </table>
      </div>
    </section>


    <section id="svaView" class="hidden">
      <div class="card compact" style="margin-bottom:12px">
        <div class="subview-head">
          <div>
            <div class="h1">SVA · Reprocesos</div>
            <div class="sub">Seguimiento de CAMBIO DE CORRUGADO / UVA / TI HI (tiempo real).</div>
          </div>
          <div class="subview-actions">
            <button class="btn secondary" id="toggleColsSVA">Columnas</button>
            <button class="btn secondary" id="btnReloadSVA">Actualizar</button>
          </div>
        </div>

        <div class="filtersRow">
          <input class="input" id="svaSearch" placeholder="Buscar: contenedor / proceso / maquila / indicación" style="min-width:320px;flex:1" />
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <span class="muted">Inicio</span><input class="input" id="svaStart" type="date" style="min-width:160px" />
            <span class="muted">Fin</span><input class="input" id="svaEnd" type="date" style="min-width:160px" />
          </div>
          <button class="btn secondary" id="btnSVAHoy">Hoy</button>
        </div>

        <div class="filtersRow" style="margin-top:8px">
          <div class="chip" style="background:rgba(255,255,255,.06)">Procesos:</div>
          <label class="chip"><input type="checkbox" id="svaProcCorr" checked> CORRUGADO</label>
          <label class="chip"><input type="checkbox" id="svaProcUVA" checked> UVA</label>
          <label class="chip"><input type="checkbox" id="svaProcTIHI" checked> TI HI</label>
          <label class="chip" title="Incluye contenedores que aún no terminan descarga"><input type="checkbox" id="svaIncluyeDescarga"> incluir en descarga</label>
        </div>

        <div class="card colsCardSmall hidden" id="colsSVACard">
          <div class="muted" style="font-size:12px;margin-bottom:8px">Selecciona columnas a mostrar (se guarda en este dispositivo).</div>
          <div id="colsSVA"></div>
        </div>

        <div class="muted" id="svaMeta" style="margin-top:8px"></div>
      </div>

      <div class="svaTableWrapOuter">
      <div class="tableWrap" id="svaTableWrap">
        <table class="table" id="svaTable">
          <thead>
            <tr>
              <th data-key="no">NO</th>
              <th data-key="contenedor">CONTENEDOR</th>
              <th data-key="cedis">CEDIS</th>
              <th data-key="fecha">FECHA</th>
              <th data-key="proceso">PROCESO</th>
              <th data-key="estatus_sva">ESTATUS</th>
              <th data-key="maquilas">MAQUILA(S)</th>
              <th data-key="avance_pct">% AVANCE</th>
              <th data-key="inicio_proc">INICIO PROC</th>
              <th data-key="fin_proc">FIN PROC</th>
              <th data-key="tiempo_proc">TIEMPO</th>
              <th data-key="personal_maquila">PERSONAL POR MAQUILA</th>
              <th data-key="indicacion">INDICACIÓN</th>
              <th data-key="acciones">ACCIONES</th>
            </tr>
          </thead>
          <tbody id="tbodySVA"></tbody>
        </table>
      </div>
      <div class="svaHScroll" id="svaHScroll" aria-label="Desplazamiento horizontal">
        <div class="svaHScrollInner" id="svaHScrollInner"></div>
      </div>
    </div>
    </section>


    <section id="logisticaView" class="hidden">
      <div class="card compact" style="margin-bottom:12px">
        <div class="subview-head">
          <div>
            <div class="h1">LOGÍSTICA · Programa de embarques</div>
            <div class="sub">Consulta central de embarques (más adelante definimos captura avanzada / estados).</div>
          </div>
          <div class="subview-actions">
            <button class="btn secondary" id="toggleColsLog">Columnas</button>
            <button class="btn secondary" id="btnReloadLog">Actualizar</button>
          </div>
        </div>

        <div class="filtersRow">
          <input class="input" id="logSearch" placeholder="Buscar: contenedor / andén / notas / estatus" style="min-width:320px;flex:1" />
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <span class="muted">Inicio</span><input class="input" id="logStart" type="date" style="min-width:160px" />
            <span class="muted">Fin</span><input class="input" id="logEnd" type="date" style="min-width:160px" />
          </div>
          <button class="btn secondary" id="btnLogHoy">Hoy</button>
        </div>

        <div class="card colsCardSmall hidden" id="colsLogCard">
          <div class="muted" style="font-size:12px;margin-bottom:8px">Selecciona columnas a mostrar (se guarda en este dispositivo).</div>
          <div id="colsLog"></div>
        </div>

        <div class="card compact" style="margin-top:10px" id="logAddCard">
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end">
            <div style="min-width:160px">
              <div class="muted" style="font-size:12px;margin-bottom:4px">Fecha cita</div>
              <input class="input" id="logAddFecha" type="date">
            </div>
            <div style="min-width:120px">
              <div class="muted" style="font-size:12px;margin-bottom:4px">Hora</div>
              <input class="input" id="logAddHora" placeholder="10:00">
            </div>
            <div style="min-width:120px">
              <div class="muted" style="font-size:12px;margin-bottom:4px">Andén</div>
              <input class="input" id="logAddAnden" placeholder="Z10">
            </div>
            <div style="min-width:200px;flex:1">
              <div class="muted" style="font-size:12px;margin-bottom:4px">Contenedor (opcional)</div>
              <input class="input" id="logAddCont" placeholder="ECMU1234567">
            </div>
            <div style="min-width:110px">
              <div class="muted" style="font-size:12px;margin-bottom:4px">Tarimas</div>
              <input class="input" id="logAddTar" type="number" min="0" step="1" placeholder="0">
            </div>
            <div style="min-width:200px;flex:1">
              <div class="muted" style="font-size:12px;margin-bottom:4px">UPCs</div>
              <input class="input" id="logAddUpcs" placeholder="0966..., 0446...">
            </div>
            <div style="min-width:200px;flex:1">
              <div class="muted" style="font-size:12px;margin-bottom:4px">Cantidades</div>
              <input class="input" id="logAddCant" placeholder="1680, 924">
            </div>
            <div style="min-width:160px">
              <div class="muted" style="font-size:12px;margin-bottom:4px">Estatus</div>
              <select class="input" id="logAddEstatus">
                <option value="PROGRAMADO">PROGRAMADO</option>
                <option value="EN_CARGA">EN CARGA</option>
                <option value="EMBARCADO">EMBARCADO</option>
                <option value="CANCELADO">CANCELADO</option>
              </select>
            </div>
            <button class="btn" id="btnLogAdd">Agregar</button>
          </div>
          <div class="muted" style="font-size:12px;margin-top:8px">Tip: esto es un primer corte. Lo ideal es separar “cabecera” y “detalle” (UPCs/cantidades) para un tablero profesional.</div>
        </div>

        <div class="muted" id="logMeta" style="margin-top:8px"></div>
      </div>

      <div class="tableWrap">
        <table class="table" id="logTable">
          <thead>
            <tr>
              <th data-key="cita_ymd">FECHA</th>
              <th data-key="hora_cita">HORA</th>
              <th data-key="anden">ANDÉN</th>
              <th data-key="contenedor_norm">CONTENEDOR</th>
              <th data-key="tarimas">TARIMAS</th>
              <th data-key="upcs">UPCS</th>
              <th data-key="cantidades">CANTIDADES</th>
              <th data-key="estatus">ESTATUS</th>
              <th data-key="notas">NOTAS</th>
              <th data-key="acciones">ACCIONES</th>
            </tr>
          </thead>
          <tbody id="tbodyLog"></tbody>
        </table>
      </div>
    </section>


  </div>

  <!-- Modal detalle -->
  <div class="modal-backdrop hidden" id="modalBackdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="hd">
        <div style="font-weight:1000" id="modalTitle">Productividad</div>
        <button class="btn secondary" id="modalClose">Cerrar</button>
      </div>
      <div class="bd" id="modalBody"></div>
    </div>
  </div>


  <!-- Modal configuración nube -->
  <!-- Modal login admin -->
  <div class="modal-backdrop hidden" id="authBackdrop" role="dialog" aria-modal="true">
    <div class="modal auth">
      <div class="hd">
        <div style="font-weight:1000">Acceso administrador</div>
        <button class="btn secondary" id="authClose">Cerrar</button>
      </div>
      <div class="bd">
        <div class="grid" style="grid-template-columns: 1fr; gap:10px">
          <div>
            <div class="muted" style="font-size:12px">Correo</div>
            <input class="input" id="authEmail" type="email" placeholder="correo@empresa.com" style="width:100%" autocomplete="email" />
          </div>
          <div>
            <div class="muted" style="font-size:12px">Contraseña</div>
            <input class="input" id="authPass" type="password" placeholder="contraseña" style="width:100%" autocomplete="current-password" />
          </div>
        </div>
        <div style="height:10px"></div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <button class="btn" id="btnLogin">Entrar</button>
        </div>
        <div class="muted" style="font-size:12px;margin-top:10px;line-height:1.35">
          Al iniciar sesión, podrás <b>capturar</b>, <b>editar</b> y <b>eliminar</b> con huella. Para consulta no se requiere login.
        </div>
      </div>
    </div>
  </div>


  <div class="modal-backdrop hidden" id="cfgBackdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="hd">
        <div style="font-weight:1000">Conectar a Supabase</div>
        <button class="btn secondary" id="cfgClose">Cerrar</button>
      </div>
      <div class="bd">
        <div class="muted" style="font-size:12px;line-height:1.45;margin-bottom:12px">
          En Supabase: <b>Project Settings → API</b>. Copia <b>Project URL</b> y <b>anon public key</b>.
          <br><b>No</b> uses <u>service_role</u> en el navegador.
        </div>

        <div class="grid" style="grid-template-columns:1fr;gap:10px">
          <div>
            <div class="muted" style="font-size:12px">Project URL</div>
            <input class="input" id="cfgUrl" placeholder="https://TU-PROYECTO.supabase.co" style="width:100%" />
          </div>
          <div>
            <div class="muted" style="font-size:12px">anon public key</div>
            <textarea class="input" id="cfgAnon" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." style="width:100%;min-height:92px;resize:vertical"></textarea>
          </div>
        </div>

        <div style="height:10px"></div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn" id="cfgSave">Guardar</button>
          <button class="btn secondary" id="cfgTest">Probar conexión</button>
          <button class="btn secondary" id="cfgShare">Copiar link (equipo)</button>
          <button class="btn danger" id="cfgClear">Borrar configuración</button>
        </div>

        <div id="cfgMsg" class="muted" style="font-size:12px;margin-top:10px"></div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

  <script>
  // Seed local (para referencia)
  window.SEED_20260107 = [{"id": "seed-20260107-1", "folio": "1", "cedis": "CUAUTIPARK II", "contenedor": "MRKU7608568", "nave": "CUAUTIPARK", "anden": "Z06", "status": "FUMIG_PEND", "indicacion": "RESGUARDO, INSPECCIÓN DEIJI; SE REPORTA PLAGA AL MOMENTO DE LA DESCARGA", "cajas": 2427, "tarimas": "", "responsable": "", "arribo_at": "2026-01-07T07:30:00", "asignacion_at": "2026-01-07T07:33:00", "inicio_at": "", "fin_at": "", "liberado_at": "", "arribo_ymd": "2026-01-07", "created_at": "2026-01-07T07:30:00", "updated_at": "2026-01-07T07:30:00"}, {"id": "seed-20260107-2", "folio": "2", "cedis": "CUAUTIPARK II", "contenedor": "REC JUAN CARLOS BECERRA", "nave": "CUAUTIPARK", "anden": "Z07", "status": "HOLD_NO_DESCARGAR", "indicacion": "RECHAZO POR PLAGA PROCEDENTE IDC, PLAGA CERVEZA", "cajas": "", "tarimas": "", "responsable": "", "arribo_at": "2026-01-07T07:45:00", "asignacion_at": "2026-01-07T07:48:00", "inicio_at": "", "fin_at": "", "liberado_at": "", "arribo_ymd": "2026-01-07", "created_at": "2026-01-07T07:45:00", "updated_at": "2026-01-07T07:45:00"}, {"id": "seed-20260107-3", "folio": "3", "cedis": "CUAUTIPARK II", "contenedor": "REC JOSE DE JESUS SANTIAGO", "nave": "CUAUTIPARK", "anden": "Z08", "status": "HOLD_NO_DESCARGAR", "indicacion": "RECHAZO POR PLAGA PROCEDENTE IDC, PLAGA CERVEZA", "cajas": "", "tarimas": "", "responsable": "", "arribo_at": "2026-01-07T08:00:00", "asignacion_at": "2026-01-07T08:03:00", "inicio_at": "", "fin_at": "", "liberado_at": "", "arribo_ymd": "2026-01-07", "created_at": "2026-01-07T08:00:00", "updated_at": "2026-01-07T08:00:00"}, {"id": "seed-20260107-4", "folio": "4", "cedis": "CUAUTIPARK II", "contenedor": "FANU3471926", "nave": "CUAUTIPARK", "anden": "Z09", "status": "FUMIG_CUARENTENA", "indicacion": "PLAGA FUMIGACIÓN Y LIMPIEZA", "cajas": 641, "tarimas": "", "responsable": "", "arribo_at": "2026-01-07T08:15:00", "asignacion_at": "2026-01-07T08:18:00", "inicio_at": "", "fin_at": "", "liberado_at": "", "arribo_ymd": "2026-01-07", "created_at": "2026-01-07T08:15:00", "updated_at": "2026-01-07T08:15:00"}, {"id": "seed-20260107-5", "folio": "5", "cedis": "CUAUTIPARK II", "contenedor": "CAAU5681082", "nave": "CUAUTIPARK", "anden": "Z10", "status": "DESCARGA_CONCL", "indicacion": "HONGO SANITIZACIÓN DEIJI", "cajas": 44, "tarimas": 44, "responsable": "Hugo Silva", "arribo_at": "2026-01-07T08:30:00", "asignacion_at": "2026-01-07T08:33:00", "inicio_at": "2026-01-07T08:39:00", "fin_at": "2026-01-07T09:59:00", "liberado_at": "2026-01-07T10:04:00", "arribo_ymd": "2026-01-07", "created_at": "2026-01-07T08:30:00", "updated_at": "2026-01-07T08:30:00"}, {"id": "seed-20260107-6", "folio": "6", "cedis": "CUAUTIPARK II", "contenedor": "HAMU4359930", "nave": "CUAUTIPARK", "anden": "Z11", "status": "DESCARGA_CONCL", "indicacion": "HONGO SANITIZACIÓN DEIJI", "cajas": 44, "tarimas": 44, "responsable": "Hugo Silva", "arribo_at": "2026-01-07T08:45:00", "asignacion_at": "2026-01-07T08:48:00", "inicio_at": "2026-01-07T08:54:00", "fin_at": "2026-01-07T10:14:00", "liberado_at": "2026-01-07T10:19:00", "arribo_ymd": "2026-01-07", "created_at": "2026-01-07T08:45:00", "updated_at": "2026-01-07T08:45:00"}, {"id": "seed-20260107-7", "folio": "7", "cedis": "CUAUTIPARK II", "contenedor": "HLBU9377704", "nave": "CUAUTIPARK", "anden": "Z06", "status": "DESCARGA_CONCL", "indicacion": "RESGUARDO, INSPECCIÓN DEIJI", "cajas": 3810, "tarimas": 36, "responsable": "Oscar Chavarria", "arribo_at": "2026-01-07T09:00:00", "asignacion_at": "2026-01-07T09:03:00", "inicio_at": "2026-01-07T09:09:00", "fin_at": "2026-01-07T10:29:00", "liberado_at": "2026-01-07T10:34:00", "arribo_ymd": "2026-01-07", "created_at": "2026-01-07T09:00:00", "updated_at": "2026-01-07T09:00:00"}, {"id": "seed-20260107-8", "folio": "8", "cedis": "CUAUTIPARK II", "contenedor": "HLBU9917741", "nave": "CUAUTIPARK", "anden": "Z07", "status": "DESCARGA_CONCL", "indicacion": "RESGUARDO, INSPECCIÓN DEIJI", "cajas": 2480, "tarimas": 32, "responsable": "Oscar Chavarria", "arribo_at": "2026-01-07T09:15:00", "asignacion_at": "2026-01-07T09:18:00", "inicio_at": "2026-01-07T09:24:00", "fin_at": "2026-01-07T10:44:00", "liberado_at": "2026-01-07T10:49:00", "arribo_ymd": "2026-01-07", "created_at": "2026-01-07T09:15:00", "updated_at": "2026-01-07T09:15:00"}, {"id": "seed-20260107-9", "folio": "9", "cedis": "CUAUTIPARK II", "contenedor": "UETU6750278 (MSKU0980929)", "nave": "CUAUTIPARK", "anden": "Z08", "status": "DESCARGA_CONCL", "indicacion": "UPC INCORRECTO, PENDIENTE INDICACIONES", "cajas": "", "tarimas": 16, "responsable": "Alejandro Retama", "arribo_at": "2026-01-07T09:30:00", "asignacion_at": "2026-01-07T09:33:00", "inicio_at": "2026-01-07T09:39:00", "fin_at": "2026-01-07T10:59:00", "liberado_at": "2026-01-07T11:04:00", "arribo_ymd": "2026-01-07", "created_at": "2026-01-07T09:30:00", "updated_at": "2026-01-07T09:30:00"}, {"id": "seed-20260107-10", "folio": "10", "cedis": "CUAUTIPARK II", "contenedor": "CMAU8866125", "nave": "CUAUTIPARK", "anden": "Z09", "status": "FUMIG_PEND", "indicacion": "PLAGA FUMIGACIÓN Y LIMPIEZA", "cajas": 537, "tarimas": "", "responsable": "", "arribo_at": "2026-01-07T09:45:00", "asignacion_at": "2026-01-07T09:48:00", "inicio_at": "", "fin_at": "", "liberado_at": "", "arribo_ymd": "2026-01-07", "created_at": "2026-01-07T09:45:00", "updated_at": "2026-01-07T09:45:00"}, {"id": "seed-20260107-11", "folio": "11", "cedis": "CUAUTIPARK II", "contenedor": "MSKU0944618", "nave": "CUAUTIPARK", "anden": "Z10", "status": "DESCARGA_CONCL", "indicacion": "UPC INCORRECTO", "cajas": 208, "tarimas": 35, "responsable": "Hugo Silva", "arribo_at": "2026-01-07T10:00:00", "asignacion_at": "2026-01-07T10:03:00", "inicio_at": "2026-01-07T10:09:00", "fin_at": "2026-01-07T11:29:00", "liberado_at": "2026-01-07T11:34:00", "arribo_ymd": "2026-01-07", "created_at": "2026-01-07T10:00:00", "updated_at": "2026-01-07T10:00:00"}, {"id": "seed-20260107-12", "folio": "12", "cedis": "CUAUTIPARK II", "contenedor": "BMOU5805519", "nave": "CUAUTIPARK", "anden": "Z11", "status": "DESCARGA_CONCL", "indicacion": "HONGO SANITIZACIÓN TTSA", "cajas": 2274, "tarimas": 33, "responsable": "Hugo Silva", "arribo_at": "2026-01-07T10:15:00", "asignacion_at": "2026-01-07T10:18:00", "inicio_at": "2026-01-07T10:24:00", "fin_at": "2026-01-07T11:44:00", "liberado_at": "2026-01-07T11:49:00", "arribo_ymd": "2026-01-07", "created_at": "2026-01-07T10:15:00", "updated_at": "2026-01-07T10:15:00"}, {"id": "seed-20260107-13", "folio": "13", "cedis": "CUAUTIPARK II", "contenedor": "MRKU2778833", "nave": "CUAUTIPARK", "anden": "Z06", "status": "DESCARGA_CONCL", "indicacion": "UPC INCORRECTO", "cajas": 208, "tarimas": 35, "responsable": "Oscar Chavarria", "arribo_at": "2026-01-07T10:30:00", "asignacion_at": "2026-01-07T10:33:00", "inicio_at": "2026-01-07T10:39:00", "fin_at": "2026-01-07T11:59:00", "liberado_at": "2026-01-07T12:04:00", "arribo_ymd": "2026-01-07", "created_at": "2026-01-07T10:30:00", "updated_at": "2026-01-07T10:30:00"}, {"id": "seed-20260107-14", "folio": "14", "cedis": "CUAUTIPARK II", "contenedor": "HLBU9802700", "nave": "CUAUTIPARK", "anden": "Z07", "status": "DESCARGA_CONCL", "indicacion": "RESGUARDO, INSPECCIÓN DEIJI", "cajas": 1878, "tarimas": 38, "responsable": "Oscar Chavarria", "arribo_at": "2026-01-07T10:45:00", "asignacion_at": "2026-01-07T10:48:00", "inicio_at": "2026-01-07T10:54:00", "fin_at": "2026-01-07T12:14:00", "liberado_at": "2026-01-07T12:19:00", "arribo_ymd": "2026-01-07", "created_at": "2026-01-07T10:45:00", "updated_at": "2026-01-07T10:45:00"}, {"id": "seed-20260107-15", "folio": "15", "cedis": "CUAUTIPARK II", "contenedor": "MSKU0980929", "nave": "CUAUTIPARK", "anden": "Z08", "status": "DESCARGA_CONCL", "indicacion": "UPC INCORRECTO, PENDIENTE INDICACIONES", "cajas": 209, "tarimas": 23, "responsable": "Alejandro Retama", "arribo_at": "2026-01-07T11:00:00", "asignacion_at": "2026-01-07T11:03:00", "inicio_at": "2026-01-07T11:09:00", "fin_at": "2026-01-07T12:29:00", "liberado_at": "2026-01-07T12:34:00", "arribo_ymd": "2026-01-07", "created_at": "2026-01-07T11:00:00", "updated_at": "2026-01-07T11:00:00"}, {"id": "seed-20260107-16", "folio": "16", "cedis": "CUAUTIPARK II", "contenedor": "UETU5728140", "nave": "CUAUTIPARK", "anden": "Z09", "status": "DESCARGA_PROCESO", "indicacion": "RESGUARDO, INSPECCIÓN DEIJI", "cajas": 3079, "tarimas": "", "responsable": "Alejandro Retama", "arribo_at": "2026-01-07T11:15:00", "asignacion_at": "2026-01-07T11:18:00", "inicio_at": "2026-01-07T11:24:00", "fin_at": "", "liberado_at": "", "arribo_ymd": "2026-01-07", "created_at": "2026-01-07T11:15:00", "updated_at": "2026-01-07T11:15:00"}, {"id": "seed-20260107-17", "folio": "17", "cedis": "CUAUTIPARK II", "contenedor": "ECMU5250442", "nave": "CUAUTIPARK", "anden": "Z10", "status": "DESCARGA_CONCL", "indicacion": "CAMBIO DE CORRUGADO, ANOTAR MEDIDAS EN CIEGO", "cajas": 23, "tarimas": 5, "responsable": "Hugo Silva", "arribo_at": "2026-01-07T11:30:00", "asignacion_at": "2026-01-07T11:33:00", "inicio_at": "2026-01-07T11:39:00", "fin_at": "2026-01-07T12:59:00", "liberado_at": "2026-01-07T13:04:00", "arribo_ymd": "2026-01-07", "created_at": "2026-01-07T11:30:00", "updated_at": "2026-01-07T11:30:00"}, {"id": "seed-20260107-18", "folio": "18", "cedis": "CUAUTIPARK II", "contenedor": "MSBU6813525", "nave": "CUAUTIPARK", "anden": "Z11", "status": "DESCARGA_CONCL", "indicacion": "CAMBIO DE CORRUGADO, ANOTAR MEDIDAS EN CIEGO", "cajas": 38, "tarimas": 7, "responsable": "Hugo Silva", "arribo_at": "2026-01-07T11:45:00", "asignacion_at": "2026-01-07T11:48:00", "inicio_at": "2026-01-07T11:54:00", "fin_at": "2026-01-07T13:14:00", "liberado_at": "2026-01-07T13:19:00", "arribo_ymd": "2026-01-07", "created_at": "2026-01-07T11:45:00", "updated_at": "2026-01-07T11:45:00"}, {"id": "seed-20260107-19", "folio": "19", "cedis": "CUAUTIPARK II", "contenedor": "TRIU8072870", "nave": "CUAUTIPARK", "anden": "Z06", "status": "DESCARGA_PROCESO", "indicacion": "RESGUARDO, INSPECCIÓN DEIJI", "cajas": 1230, "tarimas": "", "responsable": "Oscar Chavarria", "arribo_at": "2026-01-07T12:00:00", "asignacion_at": "2026-01-07T12:03:00", "inicio_at": "2026-01-07T12:09:00", "fin_at": "", "liberado_at": "", "arribo_ymd": "2026-01-07", "created_at": "2026-01-07T12:00:00", "updated_at": "2026-01-07T12:00:00"}, {"id": "seed-20260107-20", "folio": "20", "cedis": "CUAUTIPARK II", "contenedor": "TTNU8469069", "nave": "CUAUTIPARK", "anden": "Z07", "status": "DESCARGA_PROCESO", "indicacion": "RESGUARDO, INSPECCIÓN DEIJI", "cajas": 1230, "tarimas": "", "responsable": "Oscar Chavarria", "arribo_at": "2026-01-07T12:15:00", "asignacion_at": "2026-01-07T12:18:00", "inicio_at": "2026-01-07T12:24:00", "fin_at": "", "liberado_at": "", "arribo_ymd": "2026-01-07", "created_at": "2026-01-07T12:15:00", "updated_at": "2026-01-07T12:15:00"}, {"id": "seed-20260107-21", "folio": "21", "cedis": "CUAUTIPARK II", "contenedor": "GESU9579768", "nave": "CUAUTIPARK", "anden": "Z08", "status": "REPORTADO_PATIO", "indicacion": "RESGUARDO, INSPECCIÓN DEIJI", "cajas": 1220, "tarimas": "", "responsable": "", "arribo_at": "2026-01-07T12:30:00", "asignacion_at": "2026-01-07T12:33:00", "inicio_at": "", "fin_at": "", "liberado_at": "", "arribo_ymd": "2026-01-07", "created_at": "2026-01-07T12:30:00", "updated_at": "2026-01-07T12:30:00"}, {"id": "seed-20260107-22", "folio": "22", "cedis": "CUAUTIPARK II", "contenedor": "HLBU9908734", "nave": "CUAUTIPARK", "anden": "Z09", "status": "REPORTADO_PATIO", "indicacion": "RESGUARDO, INSPECCIÓN DEIJI", "cajas": 1230, "tarimas": "", "responsable": "", "arribo_at": "2026-01-07T12:45:00", "asignacion_at": "2026-01-07T12:48:00", "inicio_at": "", "fin_at": "", "liberado_at": "", "arribo_ymd": "2026-01-07", "created_at": "2026-01-07T12:45:00", "updated_at": "2026-01-07T12:45:00"}, {"id": "seed-20260107-23", "folio": "23", "cedis": "TULTIVAL", "contenedor": "CMAU4829463 (TLLU8847560)", "nave": "TULTIVAL", "anden": "TUL-01", "status": "DESCARGA_CONCL", "indicacion": "DESTRUCCIÓN", "cajas": 1, "tarimas": 1, "responsable": "", "arribo_at": "2026-01-07T13:00:00", "asignacion_at": "2026-01-07T13:03:00", "inicio_at": "2026-01-07T13:09:00", "fin_at": "2026-01-07T14:29:00", "liberado_at": "2026-01-07T14:34:00", "arribo_ymd": "2026-01-07", "created_at": "2026-01-07T13:00:00", "updated_at": "2026-01-07T13:00:00"}, {"id": "seed-20260107-24", "folio": "24", "cedis": "CUAUTIPARK II", "contenedor": "MORU1319010", "nave": "CUAUTIPARK", "anden": "Z11", "status": "REPORTADO_PATIO", "indicacion": "", "cajas": "", "tarimas": "", "responsable": "", "arribo_at": "2026-01-07T13:15:00", "asignacion_at": "2026-01-07T13:18:00", "inicio_at": "", "fin_at": "", "liberado_at": "", "arribo_ymd": "2026-01-07", "created_at": "2026-01-07T13:15:00", "updated_at": "2026-01-07T13:15:00"}, {"id": "seed-20260107-25", "folio": "25", "cedis": "CUAUTIPARK II", "contenedor": "TCLU5319323", "nave": "CUAUTIPARK", "anden": "Z06", "status": "REPORTADO_PATIO", "indicacion": "UPC INCORRECTO", "cajas": "", "tarimas": "", "responsable": "", "arribo_at": "2026-01-07T13:30:00", "asignacion_at": "2026-01-07T13:33:00", "inicio_at": "", "fin_at": "", "liberado_at": "", "arribo_ymd": "2026-01-07", "created_at": "2026-01-07T13:30:00", "updated_at": "2026-01-07T13:30:00"}, {"id": "seed-20260107-26", "folio": "26", "cedis": "CUAUTIPARK II", "contenedor": "TLLU5948509 (TCLU5319323)", "nave": "CUAUTIPARK", "anden": "Z07", "status": "REPORTADO_PATIO", "indicacion": "UPC INCORRECTO", "cajas": "", "tarimas": "", "responsable": "", "arribo_at": "2026-01-07T13:45:00", "asignacion_at": "2026-01-07T13:48:00", "inicio_at": "", "fin_at": "", "liberado_at": "", "arribo_ymd": "2026-01-07", "created_at": "2026-01-07T13:45:00", "updated_at": "2026-01-07T13:45:00"}, {"id": "seed-20260107-27", "folio": "27", "cedis": "CUAUTIPARK II", "contenedor": "REC-ROGELIO GARCIA", "nave": "CUAUTIPARK", "anden": "Z08", "status": "DESCARGA_CONCL", "indicacion": "DESTRUCCIÓN", "cajas": "", "tarimas": "PALETIZADO", "responsable": "Alejandro Retama", "arribo_at": "2026-01-07T14:00:00", "asignacion_at": "2026-01-07T14:03:00", "inicio_at": "2026-01-07T14:09:00", "fin_at": "2026-01-07T15:29:00", "liberado_at": "2026-01-07T15:34:00", "arribo_ymd": "2026-01-07", "created_at": "2026-01-07T14:00:00", "updated_at": "2026-01-07T14:00:00"}, {"id": "seed-20260107-28", "folio": "28", "cedis": "CUAUTIPARK II", "contenedor": "MRSU5037082", "nave": "CUAUTIPARK", "anden": "Z09", "status": "REPORTADO_PATIO", "indicacion": "MERCANCIA LADEADA", "cajas": 38, "tarimas": "", "responsable": "", "arribo_at": "2026-01-07T14:15:00", "asignacion_at": "2026-01-07T14:18:00", "inicio_at": "", "fin_at": "", "liberado_at": "", "arribo_ymd": "2026-01-07", "created_at": "2026-01-07T14:15:00", "updated_at": "2026-01-07T14:15:00"}];


  // =================== SUPABASE (Nube) ===================
  const LS_CFG  = 'arribos_supabase_cfg_v1';
  const LS_WORK = 'arribos_workdate_v3';
  const LS_COLS = 'arribos_cols_v3';
  const LS_LAST_CLOSE = 'arribos_last_close_v1';
  const LS_AUTO_CLOSE = 'arribos_autoclose_v1';

  // --- Configuracion sin friccion ---
  // El anon key es PUBLICO (por diseno). Para que tu equipo no tenga que pegar URL/anon en cada dispositivo,
  // este tablero soporta un link de configuracion (?cfg=...) que guarda la config en el navegador.

  let supa = null;
  let authUser = null;
  let realtime = null;
  let currentTab = 'board';
  let realtimeSva = null;
  let realtimeLog = null;
  // Multi-select filter state (TABLERO)
  let statusFilter = new Set();
  let cedisFilter = new Set();

  // ------------------- Datos base (catálogo autorizado) -------------------
  const CEDIS_LIST = ['4G','CUAUTIPARK II','NAVE 14','PARK','SMO','TULTIVAL'];

  const STATUS = [
    {order:'1', code:'REPORTADO_PATIO', label:'REPORTADO EN PATIO'},
    {order:'1.1', code:'ESPERA_CORTINA', label:'EN ESPERA DE CORTINA'},
    {order:'1.1', code:'HOLD_NO_DESCARGAR', label:'NOTIFICADO - NO DESCARGAR'},
    {order:'1.1', code:'ESPERA_CONFRONTA', label:'EN ESPERA DE CONFRONTA'},
    {order:'1.1', code:'FUMIG_PEND', label:'FUMIGACIÓN - PENDIENTE'},
    {order:'1.1.1', code:'FUMIG_CUARENTENA', label:'FUMIGACIÓN - CUARENTENA'},
    {order:'1.1.1.1', code:'RECHAZADO', label:'RECHAZADO'},
    {order:'1.1.1.2', code:'TRASPALEO_CURSO', label:'TRASPALEO EN CURSO'},
    {order:'1.1.1.3', code:'TRASPALEO_CONCL', label:'TRASPALEO CONCLUIDO'},
    {order:'2', code:'CORTINA_ASIGNADA', label:'CORTINA ASIGNADA'},
    {order:'3', code:'ESPERA_DESCARGA', label:'EN ESPERA DE DESCARGA'},
    {order:'4', code:'DESCARGA_PROCESO', label:'DESCARGA - EN PROCESO'},
    {order:'5', code:'DESCARGA_CONCL', label:'DESCARGA - CONCLUIDA'},
    {order:'6', code:'LIBERADO', label:'LIBERADO'},
  ];
  const STATUS_BY_CODE = Object.fromEntries(STATUS.map(s=>[s.code, s]));

  const TRANSITIONS = {
    REPORTADO_PATIO: ['ESPERA_CORTINA','CORTINA_ASIGNADA','HOLD_NO_DESCARGAR','ESPERA_CONFRONTA','FUMIG_PEND','RECHAZADO'],
    ESPERA_CORTINA: ['CORTINA_ASIGNADA','HOLD_NO_DESCARGAR','ESPERA_CONFRONTA','FUMIG_PEND','RECHAZADO'],
    CORTINA_ASIGNADA: ['ESPERA_DESCARGA','DESCARGA_PROCESO','ESPERA_CORTINA'],
    ESPERA_DESCARGA: ['DESCARGA_PROCESO','HOLD_NO_DESCARGAR','ESPERA_CONFRONTA','FUMIG_PEND','RECHAZADO'],
    DESCARGA_PROCESO: ['DESCARGA_CONCL'],
    DESCARGA_CONCL: ['LIBERADO'],

    HOLD_NO_DESCARGAR: ['FUMIG_PEND','ESPERA_CONFRONTA','ESPERA_CORTINA','RECHAZADO'],
    ESPERA_CONFRONTA: ['ESPERA_CORTINA','CORTINA_ASIGNADA','RECHAZADO'],
    FUMIG_PEND: ['FUMIG_CUARENTENA','ESPERA_CORTINA'],
    FUMIG_CUARENTENA: ['RECHAZADO','TRASPALEO_CURSO'],
    TRASPALEO_CURSO: ['TRASPALEO_CONCL'],
    TRASPALEO_CONCL: ['LIBERADO'],
    RECHAZADO: ['LIBERADO'],

    LIBERADO: [],
  };

  // Concluidos (para regla de visibilidad)
  const CONCLUIDOS = new Set(['DESCARGA_CONCL','LIBERADO','RECHAZADO','TRASPALEO_CONCL']);

  // Seed (histórico 2026/01/07). Se usa solo si tú presionas "Cargar histórico".
  const SEED_20260107 = (typeof window.SEED_20260107 !== 'undefined') ? window.SEED_20260107 : null;

  // ------------------- Helpers UI -------------------
  const el = (id)=>document.getElementById(id);

  function esc(s){
    return String(s ?? '').replace(/[&<>"']/g, c=>({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[c]));
  }

  // Alias requerido por SVA (compatibilidad)
  function escapeHtml(s){ return esc(s); }


  
  // -------- INDICACIÓN en 2 renglones + ancho proporcional --------
  function splitIndicacion2(s){
    s = String(s ?? '').trim().replace(/\s+/g,' ');
    if(!s) return ['', ''];

    // Corto o sin espacios: 1 renglón
    if(s.length <= 18 || !/\s/.test(s)) return [s, ''];

    const words = s.split(' ');
    if(words.length < 2) return [s, ''];

    let bestI = 1;
    let bestScore = Infinity;

    for(let i=1;i<words.length;i++){
      const a = words.slice(0,i).join(' ');
      const b = words.slice(i).join(' ');
      if(!a || !b) continue;
      const la = a.length, lb = b.length;
      const diff = Math.abs(la - lb);
      const mx = Math.max(la, lb);
      // prioriza partes iguales; desempata por línea más corta
      const score = diff * 1000 + mx;
      if(score < bestScore){
        bestScore = score;
        bestI = i;
      }
    }

    const a = words.slice(0,bestI).join(' ').trim();
    const b = words.slice(bestI).join(' ').trim();
    if(!a || !b) return [s, ''];
    return [a, b];
  }

  function indicacionHTML(s){
    const [a,b] = splitIndicacion2(s);
    if(!b) return `<div class="ind2"><span>${esc(a)}</span></div>`;
    return `<div class="ind2"><span>${esc(a)}</span><span>${esc(b)}</span></div>`;
  }

  function updateIndicacionWidth(rows){
    try{
      let maxLen = 0;
      for(const r of (rows||[])){
        const [a,b] = splitIndicacion2(r.indicacion || '');
        maxLen = Math.max(maxLen, a.length, b.length);
      }
      // límites razonables para no romper layout
      maxLen = Math.min(80, Math.max(10, maxLen || 10));
      document.documentElement.style.setProperty('--indW', maxLen + 'ch');
    }catch(e){}
  }

function ymd(d=new Date()){
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,'0');
    const day=String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  // ISO local con offset (para guardar movimientos con hora local real)
  function nowLocalIso(){
    const d = new Date();
    const pad = (n)=>String(n).padStart(2,'0');
    const y = d.getFullYear();
    const m = pad(d.getMonth()+1);
    const day = pad(d.getDate());
    const hh = pad(d.getHours());
    const mm = pad(d.getMinutes());
    const ss = pad(d.getSeconds());
    const ms = String(d.getMilliseconds()).padStart(3,'0');
    const off = -d.getTimezoneOffset();
    const sign = off>=0 ? '+' : '-';
    const oh = pad(Math.floor(Math.abs(off)/60));
    const om = pad(Math.abs(off)%60);
    return `${y}-${m}-${day}T${hh}:${mm}:${ss}.${ms}${sign}${oh}:${om}`;
  }

  function fmtYMD(ymdStr){
    if(!ymdStr) return '';
    // acepta 'YYYY-MM-DD' o ISO
    if(typeof ymdStr === 'string' && ymdStr.includes('T')) ymdStr = ymdStr.slice(0,10);
    return String(ymdStr).slice(0,10).replace(/-/g,'/');
  }


  function fmtTime(iso){
    if(!iso) return '';
    const d = new Date(iso);
    return d.toLocaleTimeString('es-MX',{hour12:false,hour:'2-digit',minute:'2-digit'});
  }

  // Alias utilizado por PANTALLA (HH:MM)
  function fmtHM(iso){ return fmtTime(iso); }

  function statusLabel(code){
    return (STATUS_BY_CODE[code] && STATUS_BY_CODE[code].label) ? STATUS_BY_CODE[code].label : code;
  }

  function statusClass(code){
    switch(code){
      case 'REPORTADO_PATIO': return 'st-reportado';
      case 'ESPERA_CORTINA':
      case 'ESPERA_DESCARGA':
      case 'CORTINA_ASIGNADA':
      case 'ESPERA_CONFRONTA': return 'st-espera';
      case 'HOLD_NO_DESCARGAR': return 'st-hold';
      case 'FUMIG_PEND': return 'st-pend';
      case 'FUMIG_CUARENTENA': return 'st-cuar';
      case 'DESCARGA_PROCESO':
      case 'TRASPALEO_CURSO': return 'st-proceso';
      case 'DESCARGA_CONCL':
      case 'LIBERADO':
      case 'TRASPALEO_CONCL': return 'st-ok';
      case 'RECHAZADO': return 'st-rech';
      default: return 'st-espera';
    }
  }

  function statusPill(code){
    return `<span class="status-block ${statusClass(code)}">${esc(statusLabel(code))}</span>`;
  }

  function toast(msg){
    // simple: usa el texto de configuración si existe, si no alert
    const m = el('cfgMsg');
    if(m){ m.textContent = msg; }
    else alert(msg);
  }

  async function copyText(text){
    try{
      if(navigator.clipboard && navigator.clipboard.writeText){
        await navigator.clipboard.writeText(text);
        return true;
      }
    }catch{}
    // fallback
    prompt('Copia el link:', text);
    return false;
  }

  // ------------------- Config Supabase -------------------
  function loadCfg(){
    try{ return JSON.parse(localStorage.getItem(LS_CFG) || 'null'); }catch{ return null; }
  }
  function saveCfg(cfg){ localStorage.setItem(LS_CFG, JSON.stringify(cfg)); }

  // Base64URL helpers (para compartir configuracion por link)
  function b64urlEncode(str){
    return btoa(unescape(encodeURIComponent(str)))
      .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  }
  function b64urlDecode(str){
    str = (str||'').replace(/-/g,'+').replace(/_/g,'/');
    while(str.length % 4) str += '=';
    return decodeURIComponent(escape(atob(str)));
  }

  function makeShareLink(cfg){
    const payload = b64urlEncode(JSON.stringify({ url: cfg.url, anon: cfg.anon }));
    const u = new URL(window.location.href);
    u.searchParams.set('cfg', payload);
    return u.toString();
  }

  function applyCfgFromUrl(){
    try{
      const u = new URL(window.location.href);
      const token = u.searchParams.get('cfg');
      if(!token) return false;
      const obj = JSON.parse(b64urlDecode(token));
      if(obj && obj.url && obj.anon){
        saveCfg({ url: normalizeUrl(obj.url), anon: (obj.anon||'').trim() });
        // Limpia URL (quita cfg) para no dejar la llave en el historial
        u.searchParams.delete('cfg');
        window.history.replaceState({}, document.title, u.toString());
        return true;
      }
    }catch(e){
      console.warn('No se pudo aplicar cfg desde URL:', e);
    }
    return false;
  }

  function setCloudChip(){
    const chip = el('chipCloud');
    if(!chip) return;
    const cfg = loadCfg();
    if(!cfg || !cfg.url || !cfg.anon){
      chip.textContent = 'Nube: no configurada';
      chip.style.opacity = '0.8';
      return;
    }
    const short = (cfg.url||'').replace('https://','').replace('http://','');
    chip.textContent = authUser ? `Nube: conectado (${short})` : `Nube: listo (${short})`;
    chip.style.opacity = '1';
  }

  function openCfg(){
    const cfg = loadCfg() || {};
    el('cfgUrl').value = cfg.url || '';
    el('cfgAnon').value = cfg.anon || '';
    el('cfgMsg').textContent = '';
    el('cfgBackdrop').classList.remove('hidden');
  }
  function closeCfg(){ el('cfgBackdrop').classList.add('hidden'); }

  function normalizeUrl(u){
    u = (u||'').trim();
    if(!u) return '';
    // Si solo te dan el project ref (ej: abcdefg...), construye URL
    if(!u.includes('://') && u.match(/^[a-z0-9]{10,}$/i)){
      return `https://${u}.supabase.co`;
    }
    if(!u.includes('://')) return 'https://' + u;
    return u;
  }

  async function ensureSupabase(){
    const cfg = loadCfg();
    if(!cfg || !cfg.url || !cfg.anon){
      setCloudChip();
      openCfg();
      throw new Error('Supabase no configurado');
    }
    if(!window.supabase){
      throw new Error('No se cargó supabase-js (revisa conexión a internet).');
    }
    if(!supa){
      supa = window.supabase.createClient(cfg.url, cfg.anon);
      // auth
      const { data } = await supa.auth.getUser();
      authUser = data?.user || null;
      setAuthUI();
      setCloudChip();

      supa.auth.onAuthStateChange((_evt, session)=>{
        authUser = session?.user || null;
        setAuthUI();
        setCloudChip();
        // al cambiar auth, refresca audit si estás en admin
        if(!el('adminView').classList.contains('hidden')) renderAudit();
      });

      // realtime
      try{
        realtime = supa.channel('arribos_shipments_live')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'shipments' }, (_payload)=>{
            // recarga datos cuando haya cambios
            reloadData(false);
          })
          .subscribe();
      }catch(e){
        console.warn('Realtime no disponible aún:', e);
      }
    }
    return supa;
  }

  // Alias por compatibilidad (algunas vistas llaman ensureSupa)
  async function ensureSupa(){
    return ensureSupabase();
  }

  async function testConnection(){
    try{
      const cfg = loadCfg();
      if(!cfg || !cfg.url || !cfg.anon){ toast('Falta URL o anon key.'); return; }
      const tmp = window.supabase.createClient(cfg.url, cfg.anon);
      const { error } = await tmp.from('shipments').select('id').limit(1);
      if(error) throw error;
      toast('Conexión OK.');
    }catch(e){
      toast('Error de conexión: ' + (e?.message || e));
    }
  }

  function clearCfg(){
    if(!confirm('Borrar configuración de nube en este navegador. ¿Continuar?')) return;
    localStorage.removeItem(LS_CFG);
    supa = null;
    authUser = null;
    setAuthUI();
    setCloudChip();
    toast('Configuración borrada.');
    openCfg();
  }

  
  // ------------------- Work date (Inicio/Fin) -------------------
  const LS_WORK_FROM = 'arribos_work_from_v1';
  const LS_WORK_TO   = 'arribos_work_to_v1';

  function getWorkRange(){
    const today = ymd();
    const start = localStorage.getItem(LS_WORK_FROM) || localStorage.getItem(LS_WORK) || today;
    const endRaw = localStorage.getItem(LS_WORK_TO) || '';
    const end = endRaw || start;

    // Sync inputs (Fin puede quedar vacío)
    if(el('dateStart')) el('dateStart').value = start;
    if(el('dateEnd')) el('dateEnd').value = endRaw;

    return { start, end, endRaw };
  }

  function setWorkRange(start, endRaw){
    const today = ymd();
    const s = start || today;

    localStorage.setItem(LS_WORK_FROM, s);
    localStorage.setItem(LS_WORK, s); // compat

    if(endRaw){
      localStorage.setItem(LS_WORK_TO, endRaw);
    }else{
      localStorage.removeItem(LS_WORK_TO);
    }

    if(el('dateStart')) el('dateStart').value = s;
    if(el('dateEnd')) el('dateEnd').value = endRaw || '';

    reloadData(true);
  }

  // Back-compat (mantenemos API interna existente)
  function getWorkDate(){ return getWorkRange().start; }
  function setWorkDate(v){ setWorkRange(v, ''); }

// ------------------- Column visibility -------------------
    const COLS = [
    {key:'folio', label:'No'},
    {key:'contenedor', label:'Contenedor'},
    {key:'cuenta', label:'Cuenta'},
    {key:'cedis', label:'Cedis'},
    {key:'status', label:'Estatus'},
    {key:'fecha', label:'Fecha'},
    {key:'indicacion', label:'Indicación'},
    {key:'anden', label:'Andén'},
    {key:'arribo_at', label:'Arribo'},
    {key:'asignacion_at', label:'Asig.'},
    {key:'responsable', label:'Responsable'},
    {key:'inicio_at', label:'Inicio'},
    {key:'fin_at', label:'Fin'},
    {key:'descarga_concl_fecha', label:'F. descarga concluida'},
    {key:'liberado_fecha', label:'F. liberación'},
    {key:'cajas', label:'Cajas'},
    {key:'tarimas', label:'Tarimas'},
    {key:'pallets', label:'Pallets'},
    {key:'playos_utilizados', label:'Playos'},
  ];

  function loadCols(){
    try{
      const v = JSON.parse(localStorage.getItem(LS_COLS) || 'null');
      if(Array.isArray(v) && v.length){
        // FECHA siempre visible (columna bloqueada)
        if(!v.includes('fecha')) v.push('fecha');
        return v;
      }
    }catch{}
    const def = COLS.map(c=>c.key);
    localStorage.setItem(LS_COLS, JSON.stringify(def));
    return def;
  }

  function renderCols(){
    const selected = new Set(loadCols());
    el('cols').innerHTML = COLS.map(c=>{
      const checked = selected.has(c.key) ? 'checked' : '';
      const locked = (c.key==='fecha');
      const disabled = locked ? 'disabled' : '';
      return `<label style="display:inline-flex;align-items:center;gap:8px;margin-right:14px;margin-bottom:8px;color:var(--muted);font-size:12px;"><input type="checkbox" data-colpick="${c.key}" ${checked} ${disabled} ${locked ? "data-locked=\"1\"" : ""}/> ${c.label}</label>`;
    }).join('');

    el('cols').querySelectorAll('input[data-colpick]').forEach(chk=>{
      chk.addEventListener('change', ()=>{
        const sel = new Set(loadCols());
        const key = chk.dataset.colpick;
        if(key==='fecha'){ chk.checked = true; return; }
        if(chk.checked) sel.add(key);
        else sel.delete(key);
        // fuerza FECHA siempre visible
        sel.add('fecha');
        if(sel.size===0){ chk.checked=true; return; }
        localStorage.setItem(LS_COLS, JSON.stringify(Array.from(sel)));
        renderBoard();
      });
    });
  }

  function applyCols(){
    const selected = new Set(loadCols());

    document.querySelectorAll('#table thead th[data-key]').forEach(th=>{
      const key = th.dataset.key;
      th.classList.toggle('hidden-col', !selected.has(key));
    
    autoScaleBoard();
  });

    document.querySelectorAll('#tbody td[data-key]').forEach(td=>{
      const key = td.dataset.key;
      td.classList.toggle('hidden-col', !selected.has(key));
    });

    updateTableScale();
  }

  
  function updateTableScale(){
    const ths = Array.from(document.querySelectorAll('#table thead th[data-key]'));
    const visible = ths.filter(th=>!th.classList.contains('hidden-col')).length || 1;

    let base = 2.0;
    if(visible <= 8) base = 2.2;
    if(visible <= 6) base = 2.4;
    if(visible <= 4) base = 2.8;

    const wrap = document.querySelector('.tableWrap') || document.getElementById('tableWrap') || document.body;
    const table = document.getElementById('table');
    let fitFactor = 1;
    try{
      const cw = (wrap.clientWidth || window.innerWidth || 1200);
      const tw = (table ? table.scrollWidth : cw);
      fitFactor = tw>0 ? Math.min(1, cw / tw) : 1;
      fitFactor = Math.max(0.65, fitFactor * 0.98);
    }catch(e){ fitFactor = 1; }

    const scale = base * fitFactor;
    document.documentElement.style.setProperty('--tblScale', String(scale));
  }



  // ------------------- Sorting -------------------
  let sortKey = 'folio';
  let sortDir = 1;

  function cmp(a,b){
    const k = sortKey;
    const av = a[k] ?? '';
    const bv = b[k] ?? '';

    if(k==='folio') return (Number(av)-Number(bv)) * sortDir;

    if(k.endsWith('_at')){
      const at = av ? new Date(av).getTime() : 0;
      const bt = bv ? new Date(bv).getTime() : 0;
      return (at-bt) * sortDir;
    }

    return String(av).localeCompare(String(bv), 'es', {sensitivity:'base'}) * sortDir;
  }

  // ------------------- Estado en memoria -------------------
  const STATE = {
    rows: [],
    lastLoadAt: 0,
  };

  function localDayRangeISO(work){
    const start = new Date(work + 'T00:00:00');
    const end = new Date(work + 'T23:59:59.999');
    return (start.toISOString(), end.toISOString());
  }

  function rangeISO(work){
    const start = new Date(work + 'T00:00:00');
    const end = new Date(work + 'T23:59:59.999');
    return { startIso: start.toISOString(), endIso: end.toISOString() };
  }

  // Rango Inicio/Fin (incluyente)
  function rangeISO2(startYMD, endYMD){
    let s = startYMD;
    let e = endYMD || startYMD;
    if(e < s){ const tmp=s; s=e; e=tmp; }
    const start = new Date(s + 'T00:00:00');
    const end = new Date(e + 'T23:59:59.999');
    return { startIso: start.toISOString(), endIso: end.toISOString() };
  }


  function dbToRow(d){
    const arr = d.arribo_at;
    const arrDate = arr ? ymd(new Date(arr)) : '';
    return {
      id: d.id,
      is_active: (d.is_active !== undefined ? d.is_active : true),
      is_deleted: (d.is_deleted !== undefined ? d.is_deleted : false),
      folio: d.folio ?? '',
      cedis: d.cedis ?? '',
      cuenta: d.cuenta ?? '',
      contenedor: d.contenedor ?? '',
      status: d.estatus ?? '',
      anden: d.anden ?? '',
      responsable: d.responsable ?? '',
      indicacion: d.indicacion ?? '',
      cajas: d.cajas ?? '',
      tarimas: d.tarimas ?? '',
      pallets: (d.pallets ?? d.PALLETS ?? ''),
      playos_utilizados: (d.playos_utilizados ?? d.PLAYOS_UTILIZADOS ?? ''),
      arribo_at: d.arribo_at ?? '',
      asignacion_at: d.asig_cortina_at ?? '',
      inicio_at: d.inicio_descarga_at ?? '',
      fin_at: d.fin_descarga_at ?? '',
      created_at: d.created_at ?? '',
      updated_at: d.updated_at ?? '',
      arribo_ymd: arrDate,
    };
  }

  
  function isVisible(row, range){
    if(row.is_deleted) return false;

    // Soporta compat: si llega string, se trata como una sola fecha
    let start, end;
    if(typeof range === 'string'){
      start = range; end = range;
    }else{
      start = range?.start || ymd();
      end = range?.end || start;
    }
    if(end < start){ const tmp=start; start=end; end=tmp; }

    const today = ymd();

    // Modo HOY (una sola fecha = hoy): mezcla pendientes previos + regla especial LIBERADO/RECHAZADO
    if(start === today && end === today){
      const st = String(row.status||'').toUpperCase();
      if(st === 'LIBERADO'){
        const d = row.liberado_ymd || (row.updated_at ? ymd(new Date(row.updated_at)) : '');
        return d === today;
      }
      if(st === 'RECHAZADO'){
        const d = row.rechazado_ymd || (row.updated_at ? ymd(new Date(row.updated_at)) : '');
        return d === today;
      }
      return (row.arribo_ymd === today) || !!row.is_active;
    }

    // Rango histórico / multi-día: solo por FECHA DE ARRIBO
    const a = row.arribo_ymd || '';
    if(!a) return false;
    return (a >= start && a <= end);
  }


  function matches(row, q){
    if(!q) return true;
    const hay = `${row.folio} ${row.contenedor} ${row.cuenta} ${row.cedis} ${row.indicacion} ${row.anden} ${row.responsable}`.toLowerCase();
    return hay.includes(q.toLowerCase());
  }

  // ------------------- Fetch principal -------------------
  
async function fetchRows(range){
    const s = await ensureSupabase();
    const today = ymd();

    // Normaliza rango
    let start, end;
    if(typeof range === 'string'){
      start = range; end = range;
    }else{
      start = range?.start || today;
      end = range?.end || start;
    }
    if(end < start){ const tmp=start; start=end; end=tmp; }

    const { startIso, endIso } = rangeISO2(start, end);

    // HOY (una sola fecha = hoy): trae lo del día + pendientes activos de días previos + (LIBERADO/RECHAZADO) que cambiaron hoy
    if(start === today && end === today){
      const qDay = s.from('shipments').select('*').eq('is_deleted', false).gte('arribo_at', startIso).lte('arribo_at', endIso);
      const qPend = s.from('shipments').select('*').eq('is_deleted', false).eq('is_active', true);

      const qIds = s.from('shipment_events')
        .select('shipment_id,to_status,event_at')
        .gte('event_at', startIso).lte('event_at', endIso)
        .in('to_status', ['LIBERADO','RECHAZADO'])
        .order('event_at', {ascending:false})
        .limit(5000);

      const [r1, r2, r3] = await Promise.all([qDay, qPend, qIds]);
      if(r1.error) throw r1.error;
      if(r2.error) throw r2.error;
      if(r3.error) throw r3.error;

      const map = new Map();
      for(const d of (r1.data||[])) map.set(d.id, dbToRow(d));
      for(const d of (r2.data||[])) map.set(d.id, dbToRow(d));

      const extraIds = Array.from(new Set((r3.data||[]).map(x=>x.shipment_id).filter(Boolean)));
      if(extraIds.length){
        const chunk = 200;
        for(let i=0;i<extraIds.length;i+=chunk){
          const part = extraIds.slice(i,i+chunk);
          const q = await s.from('shipments').select('*').eq('is_deleted', false).in('id', part);
          if(q.error) throw q.error;
          for(const d of (q.data||[])) map.set(d.id, dbToRow(d));
        }
      }

      return Array.from(map.values());
    }

    // Histórico / rango: solo por fecha de arribo (sin mezclar pendientes fuera del rango)
    const r = await s.from('shipments').select('*').eq('is_deleted', false).gte('arribo_at', startIso).lte('arribo_at', endIso);
    if(r.error) throw r.error;
    return (r.data||[]).map(dbToRow);
  }

  async function reloadData(force){
    try{
      const range = getWorkRange();
      const now = Date.now();
      if(!force && (now - STATE.lastLoadAt) < 3000) {
        renderAllViews();
        renderAdmin();
        return;
      }

      const rows = await fetchRows(range);

      // Enriquecer: fechas de estatus (LIBERADO / RECHAZADO) desde shipment_events (para visibilidad y columna F. liberación)
      const ids = rows.map(r=>r.id).filter(Boolean);
      let libMap = {}, rejMap = {}, descMap = {};
      try{
        [libMap, rejMap, descMap] = await Promise.all([
          fetchStatusEventMap(ids, 'LIBERADO'),
          fetchStatusEventMap(ids, 'RECHAZADO'),
          fetchStatusEventMap(ids, 'DESCARGA_CONCL'),
        ]);
      }catch(_e){
        console.warn('No se pudo leer shipment_events; tablero continúa sin fechas enriquecidas.', _e);
        libMap = libMap || {}; rejMap = rejMap || {}; descMap = descMap || {};
      }
      for(const r of rows){
        r.liberado_ymd = libMap[r.id] || '';
        r.rechazado_ymd = rejMap[r.id] || '';
        r.descarga_concl_ymd = descMap[r.id] || '';
      }

      STATE.rows = rows;
      STATE.lastLoadAt = now;

      renderAllViews();
      renderAdmin();
      if(!el('adminView').classList.contains('hidden')) renderAudit();
    }catch(e){
      console.error(e);
      // si no está configurado, solo muestra tablero vacío
      renderAllViews();
      renderAdmin();
    }
  }

  // ------------------- KPIs + Render -------------------
  // ---- Plantilla/Maniobra KPIs (según filtros) ----
  let _staffKpiCache = { plantilla: 0, maniobra: 0 };
  let _staffKpiKey = '';
  let _staffKpiTimer = null;

  function _staffSetText(id, val){
    const n = (val===null||val===undefined) ? 0 : val;
    const node = el(id);
    if(node) node.textContent = String(n);
  }

  function _staffKey(range){
    const c = (cedisFilter && cedisFilter.size) ? Array.from(cedisFilter).sort().join('|') : '*';
    return `${range.start}..${range.end}__${c}`;
  }

  function _ymdToDate(ymd){
    const [y,m,d] = (ymd||'').split('-').map(Number);
    if(!y||!m||!d) return null;
    return new Date(y, m-1, d);
  }
  function _dateToYMD(dt){
    const y = dt.getFullYear();
    const m = String(dt.getMonth()+1).padStart(2,'0');
    const d = String(dt.getDate()).padStart(2,'0');
    return `${y}-${m}-${d}`;
  }

  async function _computeStaffTotals(range){
    const key = _staffKey(range);

    // evita recomputar si ya está fresco para el mismo key
    if(key === _staffKpiKey && _staffKpiCache) return _staffKpiCache;

    const cedisList = (cedisFilter && cedisFilter.size) ? Array.from(cedisFilter) : null;

    // 1) intenta nube (Supabase)
    try{
      const sb = await _attGetSupabaseSilent();
      if(sb){
        // Plantilla (presentes)
        let q1 = sb.from('attendance_entries')
          .select('person')
          .eq('present', true)
          .gte('work_date', range.start)
          .lte('work_date', range.end);
        if(cedisList && cedisList.length) q1 = q1.in('cedis', cedisList);
        const r1 = await q1;
        if(r1.error) throw r1.error;
        const plantilla = (r1.data||[]).length;

        // Maniobra (suma de 3)
        let q2 = sb.from('attendance_maneuvers')
          .select('manobra_rodriguez,manobra_hernandez,manobra_zuniga')
          .gte('work_date', range.start)
          .lte('work_date', range.end);
        if(cedisList && cedisList.length) q2 = q2.in('cedis', cedisList);
        const r2 = await q2;
        if(r2.error) throw r2.error;

        const maniobra = (r2.data||[]).reduce((acc,row)=>{
          const a = (row.manobra_rodriguez==null?0:Number(row.manobra_rodriguez)) || 0;
          const b = (row.manobra_hernandez==null?0:Number(row.manobra_hernandez)) || 0;
          const c = (row.manobra_zuniga==null?0:Number(row.manobra_zuniga)) || 0;
          return acc + a + b + c;
        }, 0);

        _staffKpiCache = { plantilla, maniobra };
        _staffKpiKey = key;
        return _staffKpiCache;
      }
    }catch(e){
      // si hay error de esquema, no revientes la app
      if(!_attSchemaMissing(e)) console.warn('Staff KPI nube error', e);
    }

    // 2) fallback local (si no hay nube): suma por días/cedis de lo guardado local
    try{
      let plantilla = 0, maniobra = 0;
      const d0 = _ymdToDate(range.start);
      const d1 = _ymdToDate(range.end);
      if(d0 && d1){
        const cList = (cedisList && cedisList.length) ? cedisList : (CEDIS_LIST||[]);
        for(let dt = new Date(d0); dt <= d1; dt.setDate(dt.getDate()+1)){
          const ymd = _dateToYMD(dt);
          for(const cedis of cList){
            const day = _attLoadLocalDay(cedis, ymd);
            const ppl = day && day.people ? day.people : {};
            for(const k of Object.keys(ppl)){
              if(ppl[k] && ppl[k].present) plantilla += 1;
            }
            const m = day && day.maneuvers ? day.maneuvers : {};
            maniobra += (Number(m.rodriguez)||0) + (Number(m.hernandez)||0) + (Number(m.zuniga)||0);
          }
        }
      }
      _staffKpiCache = { plantilla, maniobra };
      _staffKpiKey = key;
      return _staffKpiCache;
    }catch(e){
      console.warn('Staff KPI local error', e);
      _staffKpiCache = { plantilla: 0, maniobra: 0 };
      _staffKpiKey = key;
      return _staffKpiCache;
    }
  }

  function refreshStaffKPIsDebounced(){
    clearTimeout(_staffKpiTimer);
    _staffKpiTimer = setTimeout(async ()=>{
      const range = getWorkRange();
      const totals = await _computeStaffTotals(range);

      // Tablero (chips)
      _staffSetText('kpiPlantillaBoard', totals.plantilla);
      _staffSetText('kpiManiobraBoard', totals.maniobra);

      // Resumen (meta chips)
      if(el('sumMetaPlantilla')) el('sumMetaPlantilla').textContent = `Plantilla: ${totals.plantilla}`;
      if(el('sumMetaManiobra')) el('sumMetaManiobra').textContent = `Maniobra: ${totals.maniobra}`;
    }, 220);
  }


  function renderKPIs(visible){
    const by = (code)=>visible.filter(r=>r.status===code).length;
    const range = getWorkRange();
    const conclWork = visible.filter(r=>CONCLUIDOS.has(r.status) && ((range.start===range.end)?(r.arribo_ymd===range.start):(r.arribo_ymd>=range.start && r.arribo_ymd<=range.end))).length;

    const chips = [
      ['Total visible', visible.length],
      ['Reportado', by('REPORTADO_PATIO')],
      ['Espera cortina', by('ESPERA_CORTINA')],
      ['Cortina asignada', by('CORTINA_ASIGNADA')],
      ['Descarga en proceso', by('DESCARGA_PROCESO')],
      ['Bloqueos (hold/fumig)', visible.filter(r=>['HOLD_NO_DESCARGAR','FUMIG_PEND','FUMIG_CUARENTENA','ESPERA_CONFRONTA'].includes(r.status)).length],
            ['Concluidos día', conclWork],
      ['Playos', visible.reduce((a,r)=>a+num0(r.playos_utilizados),0)],
      ['Plantilla', `<span id="kpiPlantillaBoard">${_staffKpiCache.plantilla}</span>`],
      ['Maniobra', `<span id="kpiManiobraBoard">${_staffKpiCache.maniobra}</span>`],
    ];

    el('kpis').innerHTML = chips.map(([k,v])=>`<span class="chip"><b>${v}</b> <span class="muted">${k}</span></span>`).join('');
  }

  function fitBoardWrap(){
    // TABLERO: allow full vertical growth; rely on browser scroll (no internal scroll region).
    const wrap = document.querySelector('#boardView .tableWrap');
    if(!wrap) return;
    wrap.style.height = 'auto';
    wrap.style.maxHeight = 'none';
    wrap.style.overflow = 'visible';
  }

  function autoScaleBoard(){
    try{
      const table = document.getElementById('table');
      const wrap  = document.querySelector('#boardView .tableWrap');
      if(!table || !wrap) return;

      const ths = Array.from(table.querySelectorAll('thead th[data-key]'));
      const visibleCols = ths.filter(th=>!th.classList.contains('hidden-col')).length || 1;

      // base scale
      let base = 2.0;
      if(visibleCols <= 8) base = 2.2;
      if(visibleCols <= 6) base = 2.4;
      if(visibleCols <= 4) base = 2.8;

      // apply base for measurement
      document.documentElement.style.setProperty('--tblScale', String(base));

      // fit width
      const cw = wrap.clientWidth || window.innerWidth || 1200;
      const tw = table.scrollWidth || cw;
      let fitW = tw>0 ? Math.min(1, cw / tw) : 1;
      // deja margen para scroll horizontal cuando hay muchas columnas
      fitW = Math.max(0.80, fitW * 0.98);

      // fit height for ~10 rows
      const availH = wrap.clientHeight || 600;
      const headH = (table.querySelector('thead')?.getBoundingClientRect().height) || 0;
      const row = table.querySelector('tbody tr');
      const rowH = row ? row.getBoundingClientRect().height : 0;
      const want = 10;
      const needH = headH + (rowH * want) + 16;
      let fitH = 1;
      if(rowH > 0 && needH > availH){
        fitH = Math.max(0.55, (availH / needH) * 0.98);
      }

      const scale = base * Math.min(fitW, fitH);
      document.documentElement.style.setProperty('--tblScale', String(scale));
    }catch(e){}
  }



  function renderBoard(){
    const range = getWorkRange();
    const q = (el('q').value || '').trim();
    const cSet = cedisFilter;
    const stSet = statusFilter;

    let rows = (STATE.rows || []).slice();

    rows = rows.filter(r=>isVisible(r, range));
    if(cSet && cSet.size) rows = rows.filter(r=>cSet.has(r.cedis));
    if(stSet && stSet.size) rows = rows.filter(r=>stSet.has(r.status));
    if(q) rows = rows.filter(r=>matches(r, q));

    rows.sort(cmp);

    renderKPIs(rows);
    refreshStaffKPIsDebounced();
    updateIndicacionWidth(rows);

    el('tbody').innerHTML = rows.map((r,i)=>`
      <tr data-id="${r.id}">
        <td data-key="folio" class="mono">${i+1}</td>
        <td data-key="contenedor" class="mono"><div class="clamp2">${esc(r.contenedor)}</div></td>
        <td data-key="cuenta">${esc(r.cuenta)}</td>
        <td data-key="cedis">${esc(r.cedis)}</td>
        <td data-key="status">${statusPill(r.status)}</td>
        <td data-key="fecha" class="mono">${fmtYMD(r.arribo_ymd)}</td>
        <td data-key="indicacion">${indicacionHTML(r.indicacion)}</td>
        <td data-key="anden" class="mono">${esc(r.anden)}</td>
        <td data-key="arribo_at" class="mono">${fmtTime(r.arribo_at)}</td>
        <td data-key="asignacion_at" class="mono">${fmtTime(r.asignacion_at)}</td>
        <td data-key="responsable">${esc(r.responsable)}</td>
        <td data-key="inicio_at" class="mono">${fmtTime(r.inicio_at)}</td>
        <td data-key="fin_at" class="mono">${fmtTime(r.fin_at)}</td>
        <td data-key="descarga_concl_fecha" class="mono">${fmtYMD(r.descarga_concl_ymd||"")}</td>
        <td data-key="liberado_fecha" class="mono">${fmtYMD(r.liberado_ymd||"")}</td>
        <td data-key="cajas" class="mono">${esc(r.cajas==null?'':String(r.cajas))}</td>
        <td data-key="tarimas" class="mono">${esc(r.tarimas==null?'':String(r.tarimas))}</td>
        <td data-key="pallets" class="mono">${esc(r.pallets==null?'':String(r.pallets))}</td>
        <td data-key="playos_utilizados" class="mono">${esc(r.playos_utilizados==null?'':String(r.playos_utilizados))}</td>
      </tr>
    `).join('');

    renderCols();
    applyCols();

    document.querySelectorAll('#tbody tr[data-id]').forEach(tr=>{
      tr.addEventListener('click', ()=>openDetail(tr.dataset.id));
    
    try{ updateTableScale(); }catch(e){}
  
    fitBoardWrap();
    autoScaleBoard();
  });

    resizeTableWrap();
  }

  function renderStatusHelp(){
    el('statusHelp').innerHTML = STATUS.map(s=>`${esc(s.order)} · <b>${esc(s.label)}</b>`).join('<br>');
  }

  function nextActions(code){
    return (TRANSITIONS[code] || []).map(to=>({to, label: statusLabel(to)}));
  }

  function requireNote(to){
    return ['HOLD_NO_DESCARGAR','ESPERA_CONFRONTA','FUMIG_PEND','FUMIG_CUARENTENA','RECHAZADO'].includes(to);
  }
  function requireAnden(to){ return to === 'CORTINA_ASIGNADA'; }
  function requireResp(to){ return to === 'CORTINA_ASIGNADA' || to === 'DESCARGA_PROCESO'; }

  // ------------------- Admin (Auth + acciones) -------------------
  function setAuthUI(){
    const st = el('authState');
    if(authUser){
      st.innerHTML = `Conectado como <b>${esc(authUser.email||authUser.id)}</b>.`;
      el('btnLogout').classList.remove('hidden');
    } else {
      st.textContent = 'No conectado.';
      el('btnLogout').classList.add('hidden');
    }

    // botón para abrir login
    try{
      el('btnShowAuth').textContent = authUser ? 'Cambiar usuario' : 'Iniciar sesión';
    }catch(_e){}
    if(authUser){ closeAuthDialog(); }

    // habilitar/inhabilitar botones de captura
    const canEdit = !!authUser;
    el('btnAdd').disabled = !canEdit;
    el('btnSeed').disabled = !canEdit;
    el('btnCloseDay').disabled = !canEdit;
  }

  async function login(){
    try{
      await ensureSupabase();
      const email = (el('authEmail').value || '').trim();
      const pass = (el('authPass').value || '').trim();
      if(!email || !pass){ alert('Escribe correo y contraseña'); return; }
      const { error } = await supa.auth.signInWithPassword({ email, password: pass });
      if(error) throw error;
      el('authPass').value = '';
      await reloadData(true);
      await autoCloseIfNeeded();
      closeAuthDialog();
      alert('Sesión iniciada.');
    }catch(e){
      alert('Error al iniciar sesión: ' + (e?.message || e));
    }
  }

  async function logout(){
    try{
      if(!supa) return;
      await supa.auth.signOut();
      authUser = null;
      setAuthUI();
      setCloudChip();
      alert('Sesión cerrada.');
    }catch(e){
      alert('Error al salir: ' + (e?.message || e));
    }
  }

  async function addRowCloud(payload){
    if(!authUser){ alert('Necesitas iniciar sesión para capturar.'); return; }
    const s = await ensureSupabase();
    const range = getWorkRange();
    const { startIso, endIso } = rangeISO(range.start);

    // folio siguiente (por día)
    const maxq = await s.from('shipments').select('folio').gte('arribo_at', startIso).lte('arribo_at', endIso).order('folio', {ascending:false}).limit(1);
    if(maxq.error) throw maxq.error;
    const nextFolio = (maxq.data && maxq.data[0] && maxq.data[0].folio) ? (Number(maxq.data[0].folio)+1) : 1;

    const now = new Date();
    const row = {
      cedis: payload.cedis,
      cuenta: payload.cuenta || null,
      folio: nextFolio,
      contenedor: payload.contenedor,
      estatus: 'REPORTADO_PATIO',
      anden: payload.anden || null,
      responsable: payload.responsable || null,
      indicacion: payload.indicacion || null,
      cajas: payload.cajas ? Number(payload.cajas) : null,
      tarimas: payload.tarimas || null,
      pallets: payload.pallets ? Number(payload.pallets) : null,
      playos_utilizados: payload.playos_utilizados ? Number(payload.playos_utilizados) : null,
      arribo_at: now.toISOString(),
    };

    let ins = await s.from('shipments').insert([row]).select('*').single();
    if(ins.error){
      let msg = String(ins.error.message||'').toLowerCase();

      // compat: si la columna playos_utilizados aún no existe (o el schema cache no está actualizado),
      // reintenta sin playos_utilizados.
      if(msg.includes('playos_utilizados') && msg.includes('could not find')){
        const row0 = {...row};
        delete row0.playos_utilizados;
        ins = await s.from('shipments').insert([row0]).select('*').single();
        msg = String(ins.error?.message||'').toLowerCase();
      }
      // compat: si la columna pallets aún no existe (o el schema cache no está actualizado),
      // intenta guardar en una columna alternativa "PALLETS" (si existe) y si no, reintenta sin pallets.
      if(msg.includes('pallets') && msg.includes('could not find')){
        const v = row.pallets;
        // intento 2: columna alternativa PALLETS
        const row2 = {...row};
        delete row2.pallets;
        if(v !== null && v !== undefined) row2.PALLETS = v;
        ins = await s.from('shipments').insert([row2]).select('*').single();

        // intento 3: sin pallets
        if(ins.error){
          const row3 = {...row};
          delete row3.pallets;
          delete row3.PALLETS;
          ins = await s.from('shipments').insert([row3]).select('*').single();
        }
      }
    }
    if(ins.error) throw ins.error;

    // evento
    await s.from('shipment_events').insert([{
      shipment_id: ins.data.id,
      event_at: ins.data.arribo_at || nowLocalIso(),
      actor: authUser.email || authUser.id,
      from_status: null,
      to_status: 'REPORTADO_PATIO',
      note: null,
      patch: { created: true }
    }]);

    await reloadData(true);
  }

  async function seedExampleCloud(){
    if(!authUser){
      alert('Primero inicia sesión en ADMIN (correo/contraseña) para poder cargar el histórico a la nube.');
      setTab('admin');
      return;
    }
    if(!SEED_20260107 || !Array.isArray(SEED_20260107) || !SEED_20260107.length){
      alert('No se encontró el histórico local (SEED_20260107).');
      return;
    }

    const ok = confirm('Esto cargará el HISTÓRICO del 2026/01/07 a la nube.\n\nSe guarda como histórico (no afecta HOY).\n\n¿Continuar?');
    if(!ok) return;

    const s = await ensureSupabase();

    // Intentar limpiar datos previos de ese día (requiere policy DELETE para admins)
    const start = '2026-01-07T00:00:00';
    const end   = '2026-01-07T23:59:59';

    const del = await s.from('shipments').delete().gte('arribo_at', start).lte('arribo_at', end);
    if(del.error){
      // Si falla por RLS, muestra el SQL que falta
      const msg = (del.error.message || '').toLowerCase();
      if(msg.includes('row level security') || msg.includes('permission') || msg.includes('not allowed')){
        alert(
          'No pude borrar registros previos del histórico (falta permiso DELETE en RLS).\n\nEjecuta esto en Supabase > SQL Editor una sola vez:\n\n' +
          'drop policy if exists shipments_admin_delete on public.shipments;\n' +
          'create policy shipments_admin_delete on public.shipments for delete\n' +
          'using (public.is_admin());\n\n' +
          'Luego vuelve a presionar "Cargar histórico".'
        );
        return;
      }
      // Si falla por otra cosa, seguimos (pero avisamos)
      console.warn('No se pudo limpiar histórico previo:', del.error);
    }

    function toIso(val){
      if(!val) return null;
      try{ return new Date(val).toISOString(); }catch{ return null; }
    }
    function toInt(val){
      if(val===null || val===undefined || val==='') return null;
      const n = Number(val);
      return Number.isFinite(n) ? n : null;
    }

    // 1) Inserta shipments
    const baseRows = SEED_20260107.map(x=>({
      cedis: x.cedis,
      cuenta: (x.cuenta||'').trim() || null,
      folio: Number(x.folio),
      contenedor: x.contenedor,
      estatus: x.status,
      anden: (x.anden||'').trim() || null,
      responsable: (x.responsable||'').trim() || null,
      arribo_at: toIso(x.arribo_at),
      asig_cortina_at: toIso(x.asignacion_at),
      inicio_descarga_at: toIso(x.inicio_at),
      fin_descarga_at: toIso(x.fin_at),
      indicacion: (x.indicacion||'').trim() || null,
      cajas: toInt(x.cajas),
      tarimas: (x.tarimas===0 ? '0' : (x.tarimas||'')) ? String(x.tarimas) : null,
      pallets: toInt(x.pallets),
      is_active: !CONCLUIDOS.has(x.status),
      is_deleted: false,
    }));

    let ins = await s.from('shipments').insert(baseRows).select('id, folio, estatus');
    if(ins.error){
      // Si tu tabla aun no tiene indicacion/cajas/tarimas, reintenta con columnas minimas
      const m = (ins.error.message||'');
      if(m.includes('indicacion') || m.includes('cajas') || m.includes('tarimas') || m.includes('pallets')){
        const minRows = SEED_20260107.map(x=>({
          cedis: x.cedis,
      cuenta: (x.cuenta||'').trim() || null,
          folio: Number(x.folio),
          contenedor: x.contenedor,
          estatus: x.status,
          anden: (x.anden||'').trim() || null,
          responsable: (x.responsable||'').trim() || null,
          arribo_at: toIso(x.arribo_at),
          asig_cortina_at: toIso(x.asignacion_at),
          inicio_descarga_at: toIso(x.inicio_at),
          fin_descarga_at: toIso(x.fin_at),
          is_active: !CONCLUIDOS.has(x.status),
      is_deleted: false,
        }));
        ins = await s.from('shipments').insert(minRows).select('id, folio, estatus');
      }
    }
    if(ins.error){
      alert('Error al cargar histórico (shipments): ' + (ins.error.message || ins.error));
      return;
    }

    // 2) Inserta eventos (huella) - opcional
    const events = (ins.data||[]).map(r=>({
      shipment_id: r.id,
      event_at: nowLocalIso(),
      actor: authUser.email || authUser.id,
      from_status: null,
      to_status: r.estatus,
      note: 'Seed histórico 2026/01/07',
      patch: { seed: true, folio: r.folio }
    }));
    if(events.length){
      const ev = await s.from('shipment_events').insert(events);
      if(ev.error){
        console.warn('No se pudieron insertar eventos (no bloquea):', ev.error);
      }
    }

    setWorkDate('2026-01-07');
    alert('Histórico 2026/01/07 cargado en la nube.');
  }

  async function closeDayCloud(day, silent=false){
    if(!authUser){
      if(!silent) alert('Necesitas iniciar sesión para cerrar el día.');
      return;
    }
    const label = day;
    if(!silent){
      const ok = confirm(`Cerrar día: ${label}.

Esto archivará (is_active=false) los registros CONCLUIDOS de ese día.
No se borran: quedan disponibles en Histórico por fecha.

¿Continuar?`);
      if(!ok) return;
    }

    const s = await ensureSupabase();
    const { startIso, endIso } = rangeISO(day);
    const concl = Array.from(CONCLUIDOS);

    const up = await s
      .from('shipments')
      .update({ is_active: false })
      .in('estatus', concl)
      .gte('arribo_at', startIso)
      .lte('arribo_at', endIso);
    if(up.error) throw up.error;

    localStorage.setItem(LS_LAST_CLOSE, day);
    if(!silent) alert('Cierre aplicado. Los concluidos ya no aparecen en HOY (solo pendientes).');
    await reloadData(true);
  }

  async function autoCloseIfNeeded(){
    // Se ejecuta al iniciar sesión: si cambió el día, archiva automáticamente los concluidos de AYER
    if(!authUser) return;
    const today = ymd();
    const last = localStorage.getItem(LS_AUTO_CLOSE);
    if(last == today) return;

    const d = new Date();
    d.setDate(d.getDate()-1);
    const yday = ymd(d);

    try{
      await closeDayCloud(yday, true);
      localStorage.setItem(LS_AUTO_CLOSE, today);
    }catch(e){
      console.warn('Auto-cierre no aplicado (no bloquea):', e);
    }
  }

  async function applyTransitionCloud(id, to){
    if(!authUser){ alert('Necesitas iniciar sesión para editar.'); return; }

    const row = (STATE.rows || []).find(r=>r.id===id);
    if(!row){ alert('No se encontró el registro en memoria.'); return; }

    const from = row.status;
    const allowed = new Set(TRANSITIONS[from] || []);
    if(!allowed.has(to)){
      alert('Transición no permitida');
      return;
    }

    let newAnden = row.anden || '';
    let newResp = row.responsable || '';
    let note = '';

    if(requireAnden(to)){
      const a = prompt('Andén/Cortina (ej: Z06):', newAnden);
      if(a===null) return;
      newAnden = (a||'').trim();
    }
    if(requireResp(to)){
      const r = prompt('Responsable:', newResp);
      if(r===null) return;
      newResp = (r||'').trim();
    }
    if(requireNote(to)){
      const n = prompt('Nota / motivo:', '');
      if(n===null) return;
      note = (n||'').trim();
    }

    const patch = {
      estatus: to,
      anden: newAnden || null,
      responsable: newResp || null,
    };

    const t = nowLocalIso();
    // timestamps
    if(to==='CORTINA_ASIGNADA' && !row.asignacion_at) patch.asig_cortina_at = t;
    if(to==='DESCARGA_PROCESO' && !row.inicio_at) patch.inicio_descarga_at = t;
    if(to==='DESCARGA_CONCL' && !row.fin_at) patch.fin_descarga_at = t;

    const s = await ensureSupabase();
    const up = await s.from('shipments').update(patch).eq('id', id);
    if(up.error) throw up.error;

    const ev = await s.from('shipment_events').insert([{
      shipment_id: id,
      event_at: t,
      actor: authUser.email || authUser.id,
      from_status: from,
      to_status: to,
      note: note || null,
      patch,
    }]);
    if(ev.error) throw ev.error;

    await reloadData(true);
  }

  

  // --------- Extra: mapa de fecha (YYYY-MM-DD, local) por estatus desde shipment_events ----------
  async function fetchStatusEventMap(ids, statusCode){
    if(!ids || !ids.length) return {};
    try{
      const s = await ensureSupabase();
      const out = {};
      const chunk = 200;
      for(let i=0;i<ids.length;i+=chunk){
        const part = ids.slice(i,i+chunk);
        const q = await s.from('shipment_events')
          .select('shipment_id,event_at,to_status')
          .in('shipment_id', part)
          .eq('to_status', statusCode)
          .order('event_at', {ascending:false})
          .limit(5000);
        if(q.error){
          // Si RLS no permite leer shipment_events en modo Tablero, no bloquees el tablero
          console.warn('shipment_events no disponible (RLS/permiso). Se omite enriquecimiento.', q.error);
          return {};
        }
        for(const r of (q.data||[])){
          if(!out[r.shipment_id] && r.event_at){
            // Usa fecha LOCAL, evita desfase por UTC
            out[r.shipment_id] = ymd(new Date(r.event_at));
          }
        }
      }
      return out;
    }catch(e){
      console.warn('shipment_events no disponible. Se omite enriquecimiento.', e);
      return {};
    }
  }
      // --------- Extra: back options por historial (para Detalle TABLERO) ----------
  async function fetchBackOptions(id, curStatus){
    const s = await ensureSupabase();
    const q = await s.from('shipment_events')
      .select('from_status,to_status,event_at')
      .eq('shipment_id', id)
      .order('event_at', {ascending:false})
      .limit(50);
    if(q.error) throw q.error;
    const evs = q.data || [];
    const seen = new Set();
    const opts = [];
    for(const e of evs){
      const fs = e.from_status;
      if(!fs || fs===curStatus) continue;
      if(seen.has(fs)) continue;
      seen.add(fs);
      opts.push({status: fs, at: (e.event_at? String(e.event_at).slice(0,16).replace('T',' '): '')});
      if(opts.length>=12) break;
    }
    return opts;
  }

  async function rollbackToStatusCloud(id, targetStatus){
    if(!authUser){ alert('Necesitas iniciar sesión para editar.'); return; }
    const row = (STATE.rows || []).find(r=>r.id===id);
    if(!row){ alert('No se encontró el registro.'); return; }
    const cur = row.status;
    if(!targetStatus || targetStatus===cur){ alert('Selecciona un estatus válido.'); return; }

    const motivo = prompt('Motivo de regresar a "'+statusLabel(targetStatus)+'" (opcional):', 'Corrección de dedo');
    if(motivo===null) return;

    const patch = {};
    const early = ['REPORTADO_PATIO','ESPERA_CORTINA','HOLD_NO_DESCARGAR','ESPERA_CONFRONTA','FUMIG_PEND','FUMIG_CUARENTENA','TRASPALEO_CURSO','TRASPALEO_CONCL'];
    if(early.includes(targetStatus)){
      patch.asignacion_at = null;
      patch.inicio_at = null;
      patch.fin_at = null;
      patch.responsable = '';
    }else if(targetStatus === 'CORTINA_ASIGNADA'){
      patch.inicio_at = null;
      patch.fin_at = null;
    }else if(targetStatus === 'DESCARGA_PROCESO'){
      patch.fin_at = null;
    }

    const s = await ensureSupabase();
    const up = await s.from('shipments').update({ status: targetStatus, ...patch }).eq('id', id);
    if(up.error) throw up.error;

    const ev = await s.from('shipment_events').insert([{
      shipment_id: id,
      event_at: nowLocalIso(),
      actor: authUser.email || authUser.id,
      from_status: cur,
      to_status: targetStatus,
      note: motivo || null,
      patch,
    }]);
    if(ev.error) throw ev.error;

    await reloadData(true);
  }
async function rollbackOneStepCloud(id){
    if(!authUser){ alert('Necesitas iniciar sesión para editar.'); return; }
    const row = (STATE.rows || []).find(r=>r.id===id);
    if(!row){ alert('No se encontró el registro en memoria.'); return; }

    const cur = row.status;
    const s = await ensureSupabase();

    // buscar el último cambio que llevó al estatus actual
    const q = await s.from('shipment_events')
      .select('from_status,to_status,event_at')
      .eq('shipment_id', id)
      .order('event_at', { ascending:false })
      .limit(25);
    if(q.error) throw q.error;

    const evs = q.data || [];
    const last = evs.find(e=>e.to_status===cur) || evs[0];
    const prev = last?.from_status;

    if(!prev || prev===cur){
      alert('No hay paso anterior registrado.');
      return;
    }

    const motivo = prompt('Motivo de regresar un paso (opcional):', 'Corrección de captura');
    const note = (motivo||'').trim();

    // limpiar timestamps "hacia adelante" cuando aplica
    const stage = (st)=>{
      st = String(st||'');
      if(st==='LIBERADO') return 4;
      if(st==='DESCARGA_CONCL') return 3;
      if(st==='DESCARGA_PROCESO') return 2;
      if(st==='CORTINA_ASIGNADA' || st==='ESPERA_DESCARGA') return 1;
      return 0;
    };
    const pStage = stage(prev);

    const patch = { estatus: prev };

    if(pStage < 3) patch.fin_descarga_at = null;
    if(pStage < 2) patch.inicio_descarga_at = null;
    if(pStage < 1) patch.asig_cortina_at = null;

    const u = await s.from('shipments').update(patch).eq('id', id);
    if(u.error) throw u.error;

    const ins = await s.from('shipment_events').insert([{
      shipment_id: id,
      event_at: nowLocalIso(),
      actor: authUser.email || authUser.id,
      from_status: cur,
      to_status: prev,
      note: note || 'Rollback 1 paso',
      patch,
    }]);
    if(ins.error) throw ins.error;

    await reloadData(true);
  }


  function renderAdmin(){
    const canEdit = !!authUser;

    const range = getWorkRange();
    let rows = (STATE.rows || []).slice().filter(r=>isVisible(r, range));

    
    // Orden cronológico admin: más reciente arriba (fecha+hora, robusto)
    const arriboTs = (r)=>{
      const y = r.arribo_ymd || '';
      const a = r.arribo_at || '';
      try{
        if(typeof a === 'string' && a){
          if(a.includes('T')){ const t = Date.parse(a); if(!Number.isNaN(t)) return t; }
          if(/^\d{2}:\d{2}/.test(a) && y){ const t = Date.parse(y + 'T' + a + ':00'); if(!Number.isNaN(t)) return t; }
        }
        if(y){ const t = Date.parse(y + 'T00:00:00'); if(!Number.isNaN(t)) return t; }
      }catch(e){}
      return 0;
    };
    rows.sort((a,b)=>{
      const dt = arriboTs(b) - arriboTs(a);
      if(dt) return dt;
      const bu=(b.updated_at||b.created_at||''); const au=(a.updated_at||a.created_at||'');
      if(bu!==au) return bu.localeCompare(au);
      return (b.contenedor||'').localeCompare(a.contenedor||'');
    });
// activos primero
    rows.sort((a,b)=>{
      const aa = CONCLUIDOS.has(a.status) ? 1 : 0;
      const bb = CONCLUIDOS.has(b.status) ? 1 : 0;
      if(aa!==bb) return aa-bb;
      return Number(a.folio)-Number(b.folio);
    });

    el('adminList').innerHTML = rows.map((r,i)=>{
      const opts = nextActions(r.status);
      const optHtml = opts.map(o=>`<option value="${o.to}">${esc(o.label)}</option>`).join('');
      return `
        <div class="card admin-row" style="opacity:${canEdit?1:0.75}">
          <div class="admin-row-top">
            <div class="admin-controls">
              <select class="input" data-next="${r.id}" ${canEdit?'':'disabled'}>
                <option value="">Siguiente estatus…</option>
                ${optHtml}
              </select>
              <button class="btn" data-apply="${r.id}" ${canEdit?'':'disabled'}>Aplicar</button>
              <button class="btn secondary tiny" data-back="${r.id}" ${canEdit?'':'disabled'} style="flex-basis:100%;max-width:180px">Paso anterior</button>
              <button class="btn secondary" data-detail="${r.id}">Productividad</button>
              <button class="btn secondary" data-edit="${r.id}" ${canEdit?'':'disabled'}>Editar</button>
              <button class="btn danger" data-del="${r.id}" ${canEdit?'':'disabled'}>Eliminar</button>
            </div>

            <div class="admin-info">
              <div class="mono admin-title">${i+1} · ${esc(r.contenedor)}</div>
              <div class="muted admin-meta">CUENTA: <b>${esc(r.cuenta||'')}</b> · CEDIS: <b>${esc(r.cedis)}</b> · Andén: <span class="mono">${esc(r.anden)}</span></div>
              <div class="muted admin-meta">Arribo: <span class="mono">${fmtTime(r.arribo_at)}</span> · Asig.: <span class="mono">${fmtTime(r.asignacion_at)}</span> · Inicio: <span class="mono">${fmtTime(r.inicio_at)}</span> · Fin: <span class="mono">${fmtTime(r.fin_at)}</span></div>
              <div class="muted admin-meta">Indicación: ${esc(r.indicacion||'')}</div>
            </div>

            <div class="admin-status">${statusPill(r.status)}</div>
          </div>
        </div>
      `;
    }).join('');

    
    // Aplicar siguiente estatus
    document.querySelectorAll('button[data-apply]').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const id = b.dataset.apply;
        const sel = document.querySelector(`select[data-next="${id}"]`);
        const to = sel ? sel.value : '';
        if(!to){ alert('Selecciona un estatus'); return; }
        try{
          await applyTransitionCloud(id, to);
        }catch(e){
          alert('Error al actualizar: ' + (e?.message || e));
        }
      });
    });

    // Paso anterior
    document.querySelectorAll('button[data-back]').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const id = b.dataset.back;
        try{
          const target = document.getElementById('d_back_to') ? document.getElementById('d_back_to').value : '';
          if(!target){ alert('Selecciona a qué estatus regresar'); return; }
          await rollbackToStatusCloud(id, target);
        }catch(e){
          alert('Error al regresar un paso: ' + (e?.message || e));
        }
      });
    });

document.querySelectorAll('button[data-detail]').forEach(b=>b.addEventListener('click', ()=>openDetail(b.dataset.detail)));

    // Editar
    document.querySelectorAll('button[data-edit]').forEach(b=>b.addEventListener('click', ()=>{
      if(!authUser){ alert('Inicia sesión para editar.'); return; }
      openEdit(b.dataset.edit);
    }));

    // Eliminar (soft delete)
    document.querySelectorAll('button[data-del]').forEach(b=>b.addEventListener('click', async ()=>{
      if(!authUser){ alert('Inicia sesión para eliminar.'); return; }
      const id = b.dataset.del;
      const row = (STATE.rows||[]).find(r=>r.id===id);
      const label = row ? `${row.folio} · ${row.contenedor}` : id;
      const reason = prompt(`Motivo de eliminación (${label}):`, 'Duplicado');
      if(reason===null) return;
      try{
        await softDeleteCloud(id, (reason||'').trim() || 'Sin motivo');
      }catch(e){
        alert('No se pudo eliminar: ' + (e?.message || e));
      }
    }));

    renderAudit();
  }

  async function renderAudit(){
    if(!authUser || !supa){
      el('audit').innerHTML = '<div class="muted" style="font-size:12px">Inicia sesión para ver el historial.</div>';
      return;
    }

    try{
      const q = await supa.from('shipment_events')
        .select('event_at,actor,from_status,to_status,note,shipment_id')
        .order('event_at', {ascending:false})
        .limit(120);
      if(q.error) throw q.error;

      const byId = new Map((STATE.rows||[]).map(r=>[r.id, r]));

      el('audit').innerHTML = `
        <table class="table">
          <thead><tr><th>Cuando</th><th>Folio</th><th>De</th><th>A</th><th>Actor</th><th>Nota</th></tr></thead>
          <tbody>
            ${(q.data||[]).map(e=>{
              const r = byId.get(e.shipment_id);
              const folio = r ? r.folio : '';
              return `
                <tr>
                  <td class="mono">${new Date(e.event_at).toLocaleString('es-MX',{hour12:false})}</td>
                  <td class="mono">${esc(folio)}</td>
                  <td class="muted" style="font-size:12px">${esc(statusLabel(e.from_status)||'')}</td>
                  <td>${esc(statusLabel(e.to_status)||'')}</td>
                  <td class="muted" style="font-size:12px">${esc(e.actor||'')}</td>
                  <td class="muted" style="font-size:12px">${esc(e.note||'')}</td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;
    }catch(e){
      el('audit').innerHTML = '<div class="muted" style="font-size:12px">No se pudo cargar el historial (revisa políticas RLS para shipment_events).</div>';
    }
  }

  
  // ------------------- Edición / eliminación -------------------
  async function updateFieldsCloud(id, patch, note){
    if(!authUser){ alert('Necesitas iniciar sesión para editar.'); return; }
    const row = (STATE.rows || []).find(r=>r.id===id);
    const from = row ? row.status : null;

    // normaliza vacíos a null
    const clean = {};
    for(const [k,v] of Object.entries(patch || {})){
      if(v === undefined) continue;
      if(v === '') clean[k] = null;
      else clean[k] = v;
    }

    const s = await ensureSupabase();

    // Intento 1: con todos los campos (incluyendo pallets)
    let clean2 = {...clean};
    let skippedPallets = false;

    // Si no hay nada que actualizar, corta
    if(Object.keys(clean2).length === 0){
      throw new Error('No hay cambios para guardar.');
    }

    let up = await s.from('shipments').update(clean2).eq('id', id);

    // Compatibilidad: si la BD aún NO tiene la columna pallets (o el schema cache no está actualizado),
    // intenta guardar en una columna alternativa "PALLETS" (si existe) y si no, reintenta sin pallets.
    if(up.error){
      let msg = String(up.error.message || up.error).toLowerCase();
      // Compatibilidad: si la BD aún NO tiene la columna playos_utilizados (o el schema cache no está actualizado),
      // reintenta sin playos_utilizados.
      if(msg.includes('playos_utilizados') && msg.includes('could not find')){
        delete clean2.playos_utilizados;
        if(Object.keys(clean2).length === 0){
          throw new Error('Tu base (Supabase) aún no tiene la columna para PLAYOS UTILIZADOS (playos_utilizados) en la tabla shipments. Agrégala y vuelve a intentar.');
        }
        up = await s.from('shipments').update(clean2).eq('id', id);
        msg = String(up.error?.message || up.error || '').toLowerCase();
      }
      if(up.error && msg.includes('pallets') && msg.includes('could not find')){
        const v = clean2.pallets;
        // intento 2: columna alternativa PALLETS
        if(v !== undefined){
          const alt = {...clean2};
          delete alt.pallets;
          alt.PALLETS = v;

          const up2 = await s.from('shipments').update(alt).eq('id', id);
          if(!up2.error){
            up = up2;
            clean2 = alt;          // para que la huella registre lo que sí se guardó
            skippedPallets = false;
          } else {
            // intento 3: sin pallets
            skippedPallets = true;
            delete clean2.pallets;

            // Si lo único que se quería guardar era pallets, avisa y no cierres el modal
            if(Object.keys(clean2).length === 0){
              throw new Error('Tu base (Supabase) aún no tiene la columna para PALLETS (pallets o PALLETS) en la tabla shipments. Agrégala y vuelve a intentar.');
            }

            up = await s.from('shipments').update(clean2).eq('id', id);
          }
        }
      }
    }

    if(up.error) throw up.error;

    const ev = await s.from('shipment_events').insert([{
      shipment_id: id,
      event_at: nowLocalIso(),
      actor: authUser.email || authUser.id,
      from_status: from,
      to_status: from,   // no cambia estatus; solo campos
      note: skippedPallets ? ((note || 'Edición') + ' (PALLETS no guardado: BD sin columna)') : (note || 'Edición'),
      patch: clean2,
    }]);
    if(ev.error) throw ev.error;

    await reloadData(true);
  }


  async function softDeleteCloud(id, reason){
    if(!authUser){ alert('Necesitas iniciar sesión para eliminar.'); return; }
    const row = (STATE.rows || []).find(r=>r.id===id);
    const from = row ? row.status : null;

    const now = nowLocalIso();
    const patch = {
      is_deleted: true,
      is_active: false,
      deleted_at: now,
      deleted_reason: reason,
      deleted_by: (authUser.email || authUser.id),
    };

    const s = await ensureSupabase();
    const up = await s.from('shipments').update(patch).eq('id', id);
    if(up.error) throw up.error;

    const ev = await s.from('shipment_events').insert([{
      shipment_id: id,
      event_at: now,
      actor: authUser.email || authUser.id,
      from_status: from,
      to_status: 'ELIMINADO',
      note: reason || null,
      patch,
    }]);
    if(ev.error) throw ev.error;

    await reloadData(true);
  }

  function openEdit(id){
    const r = (STATE.rows || []).find(x=>x.id===id);
    if(!r){ alert('No se encontró el registro.'); return; }

    el('modalTitle').textContent = 'Editar registro';
    el('modalBody').innerHTML = `
      <div class="grid two">
        <div>
          <div class="muted" style="font-size:12px">Folio</div>
          <input class="input" value="${esc(r.folio)}" disabled />
        </div>
        <div>
          <div class="muted" style="font-size:12px">Estatus</div>
          <input class="input" value="${esc(r.status)}" disabled />
        </div>

        <div>
          <div class="muted" style="font-size:12px">CEDIS</div>
          <input class="input" id="e_cedis" value="${esc(r.cedis)}" />
        </div>
        <div>
          <div class="muted" style="font-size:12px">Cuenta</div>
          <input class="input" id="e_cuenta" value="${esc(r.cuenta)}" placeholder="AKSI - ARRIBO 0012" />
        </div>

        <div style="grid-column:1/-1">
          <div class="muted" style="font-size:12px">Contenedor/Unidad</div>
          <input class="input" id="e_contenedor" value="${esc(r.contenedor)}" />
        </div>

        <div>
          <div class="muted" style="font-size:12px">Andén/Cortina</div>
          <input class="input" id="e_anden" value="${esc(r.anden)}" />
        </div>
        <div>
          <div class="muted" style="font-size:12px">Responsable</div>
          <input class="input" id="e_responsable" value="${esc(r.responsable)}" />
        </div>

        <div style="grid-column:1/-1">
          <div class="muted" style="font-size:12px">Indicación</div>
          <input class="input" id="e_indicacion" value="${esc(r.indicacion)}" />
        </div>

        <div>
          <div class="muted" style="font-size:12px">Cajas</div>
          <input class="input" id="e_cajas" value="${esc(r.cajas)}" />
        </div>
        <div>
          <div class="muted" style="font-size:12px">Tarimas</div>
          <input class="input" id="e_tarimas" value="${esc(r.tarimas)}" />
        </div>
        <div>
          <div class="muted" style="font-size:12px">Pallets</div>
          <input class="input" id="e_pallets" value="${esc(r.pallets)}" />
        </div>

        <div>
          <div class="muted" style="font-size:12px">Playos utilizados</div>
          <input class="input" id="e_playos" value="${esc((r.playos_utilizados ?? ''))}" />
        </div>

        <div style="grid-column:1/-1">
          <div class="muted" style="font-size:12px">Nota (huella)</div>
          <input class="input" id="e_note" placeholder="Ej. Corrección de captura / duplicado / etc" />
        </div>

        <div style="grid-column:1/-1;display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn secondary" id="e_cancel">Cancelar</button>
          <button class="btn" id="e_save">Guardar cambios</button>
        </div>
      </div>
    `;
    el('modalBackdrop').classList.remove('hidden');

    el('e_cancel').addEventListener('click', closeDetail);
    el('e_save').addEventListener('click', async ()=>{
      const note = (el('e_note').value || '').trim() || 'Edición';
      const cajasRaw = (el('e_cajas').value || '').trim();
      const cajas = cajasRaw ? Number(cajasRaw) : null;
      const palletsRaw = (el('e_pallets').value || '').trim();
      const palletsN = palletsRaw ? Number(palletsRaw) : null;
      const playosRaw = (el('e_playos').value || '').trim();
      const playosN = playosRaw ? Number(playosRaw) : null;
      const patch = {
        cedis: (el('e_cedis').value || '').trim(),
        cuenta: (el('e_cuenta').value || '').trim(),
        contenedor: (el('e_contenedor').value || '').trim(),
        anden: (el('e_anden').value || '').trim(),
        responsable: (el('e_responsable').value || '').trim(),
        indicacion: (el('e_indicacion').value || '').trim(),
        cajas: (Number.isFinite(cajas) ? cajas : null),
        tarimas: (el('e_tarimas').value || '').trim(),
        pallets: (Number.isFinite(palletsN) ? palletsN : null),
        playos_utilizados: (Number.isFinite(playosN) ? playosN : null),
      };
      try{
        await updateFieldsCloud(id, patch, note);
        closeDetail();
      }catch(e){
        alert('No se pudo guardar: ' + (e?.message || e));
      }
    });
  }


  // ------------------- Detail modal -------------------
  function openDetail(id){
    const r = (STATE.rows || []).find(x=>x.id===id);
    if(!r) return;

    el('modalTitle').textContent = `${r.folio} · ${r.contenedor}`;
    const fields = [
      ['CEDIS', r.cedis],
      ['Cuenta', r.cuenta],
      ['Indicación', r.indicacion],
      ['Estatus', statusLabel(r.status)],
      ['Andén', r.anden],
      ['Arribo', `${r.arribo_ymd} ${fmtTime(r.arribo_at)}`],
      ['Asignación', fmtTime(r.asignacion_at)],
      ['Inicio', fmtTime(r.inicio_at)],
      ['Fin', fmtTime(r.fin_at)],
      ['Cajas', r.cajas],
      ['Tarimas', r.tarimas],
      ['Pallets', r.pallets],
      ['Indicación', r.indicacion],
    ];

    el('modalBody').innerHTML = fields.map(([k,v])=>`
      <div class="row"><div class="k">${esc(k)}</div><div class="v">${esc(v||'')}</div></div>
    `).join('');

    // Acciones en TABLERO (requiere sesión)
    const opts = nextActions(r.status);
    const optHtml = opts.map(o=>`<option value="${o.to}">${esc(o.label)}</option>`).join('');
    const dis = authUser ? '' : 'disabled';

    el('modalBody').innerHTML += `
      <div class="sep" style="margin:10px 0;border-top:1px solid rgba(255,255,255,.08)"></div>
      <div id="detailActions" class="admin-controls" style="gap:10px;flex-wrap:wrap">
        <select class="input" id="d_next" ${dis} style="min-width:220px">
          <option value="">Siguiente estatus…</option>
          ${optHtml}
        </select>
        <button class="btn" id="d_apply" ${dis}>Aplicar</button>
        <select class="input" id="d_back_to" ${dis} style="min-width:220px;max-width:320px">
          <option value="">Regresar a…</option>
        </select>
        <button class="btn secondary tiny" id="d_back_apply" ${dis} style="max-width:180px">Regresar</button>
        <button class="btn secondary" id="d_edit" ${dis}>Editar</button>
        <button class="btn danger" id="d_del" ${dis}>Eliminar</button>
        ${authUser ? '' : '<div class="muted" style="font-size:12px;opacity:.9">Inicia sesión en ADMIN para ejecutar acciones.</div>'}
      </div>
    `;

    el('modalBackdrop').dataset.curId = id;
    // poblar opciones de regreso (historial)
    if(authUser){
      const selBack = document.getElementById('d_back_to');
      if(selBack){
        selBack.innerHTML = '<option value="">Regresar a…</option>';
        fetchBackOptions(id, r.status).then(opts=>{
          opts.forEach(o=>{
            const op = document.createElement('option');
            op.value = o.status;
            op.textContent = (statusLabel(o.status) + (o.at?(' · '+o.at):''));
            selBack.appendChild(op);
          });
        }).catch(e=>console.warn(e));
      }
    }



    el('modalBackdrop').classList.remove('hidden');
  }

  function closeDetail(){
    el('modalBackdrop').classList.add('hidden');
  }

  
  // ------------------- Auth dialog -------------------
  function openAuthDialog(){
    el('authBackdrop').classList.remove('hidden');
    setTimeout(()=>{ try{ el('authEmail').focus(); }catch(_e){} }, 50);
  }
  function closeAuthDialog(){
    el('authBackdrop').classList.add('hidden');
  }

  // ------------------- Subvistas (ADMIN): Arribos por llegar / Histórico -------------------
  const LS_COLS_PORLLEGAR = 'LS_COLS_PORLLEGAR_v1';
  const COLS_PORLLEGAR = [
    { key:'contenedor_norm', label:'Contenedor', locked:true },
    { key:'fecha_arribo', label:'Fecha arribo' },
    { key:'destino', label:'Destino' },
    { key:'tipo_arribo', label:'Tipo' },
    { key:'nave', label:'Nave' },
    { key:'indicacion', label:'Indicación' },
    { key:'cajas', label:'Cajas' },
    { key:'piezas', label:'Piezas' },
    { key:'observaciones', label:'Observaciones' },
    { key:'descripcion', label:'Descripción' },
    { key:'updated_at', label:'Actualizado' },
  ];

  const LS_COLS_HISTORICO = 'LS_COLS_HISTORICO_v1';
  const COLS_HISTORICO = [
    { key:'fecha_reporte', label:'Fecha reporte', locked:true },
    { key:'cedis', label:'CEDIS' },
    { key:'contenedor_norm', label:'Contenedor' },
    { key:'estatus', label:'Estatus' },
    { key:'indicacion', label:'Indicación' },
    { key:'cajas', label:'Cajas' },
    { key:'tarimas', label:'Tarimas' },
    { key:'reportado', label:'Reportado' },
    { key:'source_sheet', label:'Hoja' },
    { key:'created_at', label:'Creado' },
  ];

  function _loadColsGeneric(lsKey, defKeys){
    try{
      const raw = localStorage.getItem(lsKey);
      if(raw){
        const arr = JSON.parse(raw);
        if(Array.isArray(arr)){
          if(arr.length && typeof arr[0]==='object' && arr[0] && 'key' in arr[0]) return arr.map(x=>x.key);
          return arr;
        }
      }
    }catch{}
    try{ localStorage.setItem(lsKey, JSON.stringify(defKeys)); }catch{}
    return defKeys;
  }

  function _renderColsGeneric(containerId, cols, lsKey, applyFn){
    const selected = new Set(_loadColsGeneric(lsKey, cols.map(c=>c.key)));
    el(containerId).innerHTML = cols.map(c=>{
      const checked = selected.has(c.key) ? 'checked' : '';
      const disabled = c.locked ? 'disabled' : '';
      return `<label style="display:inline-flex;align-items:center;gap:8px;margin-right:14px;margin-bottom:8px;color:var(--muted);font-size:12px;"><input type="checkbox" data-colpick="${c.key}" ${checked} ${disabled}/> ${c.label}</label>`;
    }).join('');

    el(containerId).querySelectorAll('input[data-colpick]').forEach(chk=>{
      chk.addEventListener('change', ()=>{
        const sel = new Set(_loadColsGeneric(lsKey, cols.map(c=>c.key)));
        const key = chk.dataset.colpick;
        const locked = cols.find(x=>x.key===key)?.locked;
        if(locked){ chk.checked = true; return; }
        if(chk.checked) sel.add(key); else sel.delete(key);

        // fuerza locked visibles
        cols.filter(x=>x.locked).forEach(x=>sel.add(x.key));

        localStorage.setItem(lsKey, JSON.stringify(Array.from(sel)));
        applyFn();
      });
    });
  }

  function _applyColsToTable(tableSel, tbodySel, lsKey, cols){
    const selected = new Set(_loadColsGeneric(lsKey, cols.map(c=>c.key)));
    document.querySelectorAll(`${tableSel} thead th[data-key]`).forEach(th=>{
      const key = th.dataset.key;
      th.classList.toggle('hidden-col', !selected.has(key));
    });
    document.querySelectorAll(`${tbodySel} td[data-key]`).forEach(td=>{
      const key = td.dataset.key;
      td.classList.toggle('hidden-col', !selected.has(key));
    });
  }

  function applyColsPorLlegar(){ _applyColsToTable('#porLlegarTable', '#tbodyPorLlegar', LS_COLS_PORLLEGAR, COLS_PORLLEGAR); }
  function applyColsHistorico(){ _applyColsToTable('#historicoTable', '#tbodyHistorico', LS_COLS_HISTORICO, COLS_HISTORICO); }
  function applyColsSVA(){ _applyColsToTable('#svaTable', '#tbodySVA', LS_COLS_SVA, COLS_SVA); }
  function applyColsLog(){ _applyColsToTable('#logTable', '#tbodyLog', LS_COLS_LOG, COLS_LOG); }

  let _porLlegarRows = [];
  let _historicoRows = [];
  let _porLlegarTimer = null;
  let _historicoTimer = null;

  function _fmtDT(iso){
    if(!iso) return '';
    try{
      const d = new Date(iso);
      return d.toLocaleString('es-MX',{hour12:false});
    }catch{return String(iso)}
  }

  function _setDefaultSubRanges(){
    try{
      if(el('porLlegarStart') && !el('porLlegarStart').value){
        const d1 = new Date(); d1.setDate(d1.getDate()-2);
        const d2 = new Date(); d2.setDate(d2.getDate()+14);
        el('porLlegarStart').value = ymd(d1);
        el('porLlegarEnd').value = ymd(d2);
      }
      if(el('historicoStart') && !el('historicoStart').value){
        const d1 = new Date(); d1.setDate(d1.getDate()-7);
        const d2 = new Date();
        el('historicoStart').value = ymd(d1);
        el('historicoEnd').value = ymd(d2);
      }
    }catch{}
  }

  async function reloadPorLlegar(){
    try{
      _setDefaultSubRanges();
      await ensureSupa();
      const s = (el('porLlegarSearch')?.value || '').trim();
      const d1 = el('porLlegarStart')?.value || '';
      const d2 = el('porLlegarEnd')?.value || '';

      let q = supa.from('arribos_por_llegar').select('*');

      if(d1) q = q.gte('fecha_arribo', d1);
      if(d2) q = q.lte('fecha_arribo', d2);

      if(s){
        const esc = s.replace(/%/g,'').replace(/,/g,' ');
        q = q.or(`contenedor_norm.ilike.%${esc}%,contenedor_raw.ilike.%${esc}%,destino.ilike.%${esc}%,nave.ilike.%${esc}%,indicacion.ilike.%${esc}%`);
      }

      q = q.order('fecha_arribo', { ascending:true }).order('contenedor_norm', { ascending:true }).limit(5000);

      const { data, error } = await q;
      if(error) throw error;
      _porLlegarRows = data || [];
      renderPorLlegar();
    }catch(e){
      console.warn('reloadPorLlegar', e);
      if(el('porLlegarMeta')) el('porLlegarMeta').textContent = `Error al cargar: ${e?.message || e}`;
      if(el('tbodyPorLlegar')) el('tbodyPorLlegar').innerHTML = '';
    }
  }

  function renderPorLlegar(){
    const rows = _porLlegarRows || [];
    el('tbodyPorLlegar').innerHTML = rows.map(r=>{
      return `<tr>
        <td data-key="contenedor_norm">${esc(r.contenedor_norm||'')}</td>
        <td data-key="fecha_arribo">${esc(fmtYMD(r.fecha_arribo||''))}</td>
        <td data-key="destino">${esc(r.destino||'')}</td>
        <td data-key="tipo_arribo">${esc(r.tipo_arribo||'')}</td>
        <td data-key="nave">${esc(r.nave||'')}</td>
        <td data-key="indicacion">${esc(r.indicacion||'')}</td>
        <td data-key="cajas">${(r.cajas??'')===null?'':esc(String(r.cajas??''))}</td>
        <td data-key="piezas">${(r.piezas??'')===null?'':esc(String(r.piezas??''))}</td>
        <td data-key="observaciones">${esc(r.observaciones||'')}</td>
        <td data-key="descripcion">${esc(r.descripcion||'')}</td>
        <td data-key="updated_at">${esc(_fmtDT(r.updated_at||''))}</td>
      </tr>`;
    }).join('');

    applyColsPorLlegar();
    el('porLlegarMeta').textContent = `Registros: ${rows.length}`;
  }

  async function reloadHistorico(){
    try{
      _setDefaultSubRanges();
      await ensureSupa();
      const s = (el('historicoSearch')?.value || '').trim();
      const d1 = el('historicoStart')?.value || '';
      const d2 = el('historicoEnd')?.value || '';

      let q = supa.from('arribos_historico').select('*');

      if(d1) q = q.gte('fecha_reporte', d1);
      if(d2) q = q.lte('fecha_reporte', d2);

      if(s){
        const escq = s.replace(/%/g,'').replace(/,/g,' ');
        q = q.or(`contenedor_norm.ilike.%${escq}%,cedis.ilike.%${escq}%,estatus.ilike.%${escq}%,indicacion.ilike.%${escq}%`);
      }

      q = q.order('fecha_reporte', { ascending:false }).order('cedis', { ascending:true }).limit(2000);

      const { data, error } = await q;
      if(error) throw error;
      _historicoRows = data || [];
      renderHistorico();
    }catch(e){
      console.warn('reloadHistorico', e);
      if(el('historicoMeta')) el('historicoMeta').textContent = `Error al cargar: ${e?.message || e}`;
      if(el('tbodyHistorico')) el('tbodyHistorico').innerHTML = '';
    }
  }

  function renderHistorico(){
    const rows = _historicoRows || [];
    el('tbodyHistorico').innerHTML = rows.map(r=>{
      return `<tr>
        <td data-key="fecha_reporte">${esc(fmtYMD(r.fecha_reporte||''))}</td>
        <td data-key="cedis">${esc(r.cedis||'')}</td>
        <td data-key="contenedor_norm">${esc(r.contenedor_norm||'')}</td>
        <td data-key="estatus">${esc(r.estatus||'')}</td>
        <td data-key="indicacion">${esc(r.indicacion||'')}</td>
        <td data-key="cajas">${(r.cajas??'')===null?'':esc(String(r.cajas??''))}</td>
        <td data-key="tarimas">${esc(r.tarimas||'')}</td>
        <td data-key="reportado">${esc(r.reportado||'')}</td>
        <td data-key="source_sheet">${esc(r.source_sheet||'')}</td>
        <td data-key="created_at">${esc(_fmtDT(r.created_at||''))}</td>
      </tr>`;
    }).join('');

    applyColsHistorico();
    el('historicoMeta').textContent = `Registros: ${rows.length} (máx 2000 por consulta)`;
  }

  function initSubViews(){
    _setDefaultSubRanges();

    if(el('colsPorLlegar')) _renderColsGeneric('colsPorLlegar', COLS_PORLLEGAR, LS_COLS_PORLLEGAR, applyColsPorLlegar);
    if(el('colsHistorico')) _renderColsGeneric('colsHistorico', COLS_HISTORICO, LS_COLS_HISTORICO, applyColsHistorico);

    if(el('colsSVA')) _renderColsGeneric('colsSVA', COLS_SVA, LS_COLS_SVA, applyColsSVA);
    if(el('colsLog')) _renderColsGeneric('colsLog', COLS_LOG, LS_COLS_LOG, applyColsLog);
  }


// ------------------- UI wiring -------------------
  
  function setTab(which){
    currentTab = which;
    const isBoard = which==='board';
    const isPorLlegar = which==='porllegar';
    const isHistorico = which==='historico';
    const isAdmin = (which==='admin') || isPorLlegar || isHistorico;
    const showAdminView = which==='admin';
    const isScreen = which==='screen';
    const isSummary = which==='summary';
    const isDashboard = which==='dashboard';
    const isSVA = which==='sva';
    const isLogistica = which==='logistica';

    el('boardView').classList.toggle('hidden', !isBoard);
    el('adminView').classList.toggle('hidden', !showAdminView);
    el('screenView').classList.toggle('hidden', !isScreen);
    if(el('summaryView')) el('summaryView').classList.toggle('hidden', !isSummary);
    if(el('dashboardView')) el('dashboardView').classList.toggle('hidden', !isDashboard);
    if(el('porLlegarView')) el('porLlegarView').classList.toggle('hidden', !isPorLlegar);
    if(el('historicoView')) el('historicoView').classList.toggle('hidden', !isHistorico);
    if(el('svaView')) el('svaView').classList.toggle('hidden', !isSVA);
    if(el('logisticaView')) el('logisticaView').classList.toggle('hidden', !isLogistica);

    el('tabBoard').classList.toggle('active', isBoard);
    el('tabAdmin').classList.toggle('active', isAdmin);
    if(el('tabScreen')) el('tabScreen').classList.toggle('active', isScreen);
    if(el('tabSummary')) el('tabSummary').classList.toggle('active', isSummary);
    if(el('tabDashboard')) el('tabDashboard').classList.toggle('active', isDashboard);
    if(el('tabSVA')) el('tabSVA').classList.toggle('active', isSVA);
    if(el('tabLogistica')) el('tabLogistica').classList.toggle('active', isLogistica);

    const modeLabel = isBoard ? 'Tablero'
      : (isPorLlegar ? 'Admin · Por llegar'
      : (isHistorico ? 'Admin · Histórico'
      : (isAdmin ? 'Admin'
      : (isSummary ? 'Resumen'
      : (isDashboard ? 'Dashboard' : 'Pantalla')))));
    el('chipMode').textContent = `Modo: ${modeLabel}`;

    if(isBoard) closeAuthDialog();

    if(!isScreen) stopScreen();
    if(isScreen){ startScreen(); }

    if(showAdminView){ renderAudit(); }
    if(isBoard){ renderBoard(); }
    if(isSummary){ renderSummary(); }
    if(isDashboard){ renderDashboard(); setTimeout(dashResize, 60); }

    // Carga de subvistas
    if(isPorLlegar){ reloadPorLlegar(); }
    if(isHistorico){ reloadHistorico(); }
    if(isSVA){ reloadSVA(); }
    if(isLogistica){ reloadLogistica(); }
  }

  
function renderFilters(){
    // CEDIS (multi-select)
    initCedisMulti();

    // Estatus (multi-select)
    initStatusMulti();

    // Admin capture (CEDIS list)
    const fcs = el('f_cedis');
    if(fcs) fcs.innerHTML = (CEDIS_LIST||[]).map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join('');
  }


  
  
  function initCedisMulti(){
    const btn = el('cedisBtn');
    const menu = el('cedisMenu');
    if(!btn || !menu) return;
    if(menu.dataset.ready === '1'){ updateCedisBtnText(); return; }
    menu.dataset.ready = '1';

    const items = (CEDIS_LIST||[]).map(c=>String(c)).filter(Boolean);

    menu.innerHTML = `
      <div class="msHead">
        <button type="button" class="msAction" data-act="all">Todos</button>
        <button type="button" class="msAction" data-act="close">Cerrar</button>
      </div>
      <div class="msList">
        ${items.map(v => `
          <label class="msItem">
            <input type="checkbox" value="${esc(v)}" ${cedisFilter.has(v) ? 'checked' : ''} />
            <span>${esc(v)}</span>
          </label>
        `).join('')}
      </div>
    `;

    btn.addEventListener('click', (e)=>{
      e.stopPropagation();
      menu.classList.toggle('hidden');
    });
    document.addEventListener('click', ()=>{
      menu.classList.add('hidden');
    });
    menu.addEventListener('click', (e)=>e.stopPropagation());

    menu.querySelector('[data-act="all"]').addEventListener('click', ()=>{
      cedisFilter.clear();
      menu.querySelectorAll('input[type="checkbox"]').forEach(ch=>ch.checked=false);
      updateCedisBtnText();
      renderAllViews();
    });
    menu.querySelector('[data-act="close"]').addEventListener('click', ()=> menu.classList.add('hidden'));

    menu.querySelectorAll('input[type="checkbox"]').forEach(ch=>{
      ch.addEventListener('change', ()=>{
        if(ch.checked) cedisFilter.add(ch.value);
        else cedisFilter.delete(ch.value);
        updateCedisBtnText();
        renderAllViews();
      });
    });

    updateCedisBtnText();
  }

  function updateCedisBtnText(){
    const btn = el('cedisBtn');
    if(!btn) return;
    const n = cedisFilter.size;
    if(n===0) btn.textContent = 'CEDIS: Todos ▾';
    else btn.textContent = 'CEDIS: ' + n + ' seleccionados ▾';
  }

function initStatusMulti(){
    const btn = el('estatusBtn');
    const menu = el('estatusMenu');
    if(!btn || !menu) return;
    if(menu.dataset.ready === '1'){ updateStatusBtnText(); return; }
    menu.dataset.ready = '1';

    const items = (STATUS||[]).map(s=>({code:s.code,label:s.label})).filter(x=>x.code && x.label);

    menu.innerHTML = `
      <div class="msHead">
        <button type="button" class="msAction" data-act="all">Todos</button>
        <button type="button" class="msAction" data-act="close">Cerrar</button>
      </div>
      <div class="msList">
        ${items.map(it => `
          <label class="msItem">
            <input type="checkbox" value="${esc(it.code)}" ${statusFilter.has(it.code) ? 'checked' : ''} />
            <span>${esc(it.label)}</span>
          </label>
        `).join('')}
      </div>
    `;

    // Open/close
    btn.addEventListener('click', (e)=>{
      e.stopPropagation();
      menu.classList.toggle('hidden');
    });
    document.addEventListener('click', ()=>{
      menu.classList.add('hidden');
    });
    menu.addEventListener('click', (e)=>e.stopPropagation());

    // Actions
    menu.querySelector('[data-act="all"]').addEventListener('click', ()=>{
      statusFilter.clear();
      menu.querySelectorAll('input[type="checkbox"]').forEach(ch=>ch.checked=false);
      updateStatusBtnText();
      renderAllViews();
    });
    menu.querySelector('[data-act="close"]').addEventListener('click', ()=>{
      menu.classList.add('hidden');
    });

    // Checkbox changes
    menu.querySelectorAll('input[type="checkbox"]').forEach(ch=>{
      ch.addEventListener('change', ()=>{
        if(ch.checked) statusFilter.add(ch.value);
        else statusFilter.delete(ch.value);
        updateStatusBtnText();
        renderAllViews();
      });
    });

    updateStatusBtnText();
  }
  function updateStatusBtnText(){
    const btn = el('estatusBtn');
    if(!btn) return;
    const n = statusFilter.size;
    if(n===0) btn.textContent = 'Estatus: Todos ▾';
    else btn.textContent = 'Estatus: ' + n + ' seleccionados ▾';
  }



  function resizeTableWrap(){
    // TABLERO should show all rows; do not clamp table height.
    const w = document.getElementById('tableWrap');
    if(!w) return;
    w.style.maxHeight = 'none';
    w.style.height = 'auto';
    w.style.overflow = 'visible';
  }

  
  // =========================
  // SVA / LOGÍSTICA (nuevas vistas)
  // =========================

  const LS_COLS_SVA = 'cols_sva_v1';
  const COLS_SVA = [
    { key:'no', label:'NO' },
    { key:'contenedor', label:'CONTENEDOR' },
    { key:'cedis', label:'CEDIS' },
    { key:'fecha', label:'FECHA' },
    { key:'proceso', label:'PROCESO' },
    { key:'estatus_sva', label:'ESTATUS' },
    { key:'maquilas', label:'MAQUILA(S)' },
    { key:'avance_pct', label:'% AVANCE' },
    { key:'inicio_proc', label:'INICIO PROC' },
    { key:'fin_proc', label:'FIN PROC' },
    { key:'tiempo_proc', label:'TIEMPO' },
    { key:'personal_maquila', label:'PERSONAL POR MAQUILA' },
    { key:'indicacion', label:'INDICACIÓN' },
    { key:'acciones', label:'ACCIONES' },
  ];

  const LS_COLS_LOG = 'cols_log_v1';
  const COLS_LOG = [
    { key:'cita_ymd', label:'FECHA' },
    { key:'hora_cita', label:'HORA' },
    { key:'anden', label:'ANDÉN' },
    { key:'contenedor_norm', label:'CONTENEDOR' },
    { key:'tarimas', label:'TARIMAS' },
    { key:'upcs', label:'UPCS' },
    { key:'cantidades', label:'CANTIDADES' },
    { key:'estatus', label:'ESTATUS' },
    { key:'notas', label:'NOTAS' },
    { key:'acciones', label:'ACCIONES' },
  ];

  let svaMerged = [];
  let logRows = [];
  let _svaTimer = null;
  let _logTimer = null;
  const _svaSaveTimers = new Map();
  const _logSaveTimers = new Map();

  function _rangeISOFromTo(d1, d2){
    const start = d1 ? new Date(d1+'T00:00:00') : new Date();
    const end = d2 ? new Date(d2+'T23:59:59.999') : new Date();
    return { startIso: start.toISOString(), endIso: end.toISOString() };
  }

  function _normCont(v){
    v = (v||'').toUpperCase().trim();
    const m = v.match(/[A-Z]{4}\d{7}/);
    if(m) return m[0];
    v = v.replace(/[^A-Z0-9]/g,'');
    return v.slice(0,20);
  }

  function _detectSvaProcesos(indicacion){
    const t = (indicacion||'').toUpperCase();
    const out = [];
    if(t.includes('CORRUG')) out.push('CAMBIO DE CORRUGADO');
    if(t.includes('UVA')) out.push('UVA');
    if(t.includes('TI HI') || t.includes('TIHI') || t.includes('TI-HI')) out.push('TI HI');
    return out;
  }

  function _fmtDur(ms){
    if(!isFinite(ms) || ms<=0) return '';
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    if(h>0) return `${h}h ${m}m`;
    return `${m}m`;
  }

  function _isoToYMDLocal(iso){
    if(!iso) return '';
    const d = new Date(iso);
    return ymd(d); // helper existente del sistema
  }

  function _isoToHM(iso){
    if(!iso) return '';
    try{ return fmtTime(iso); }catch(e){ return ''; }
  }

  function _ensureRealtimeSVA(){
    if(!supa || realtimeSva) return;
    realtimeSva = supa.channel('sva_reprocesos_live')
      .on('postgres_changes', { event:'*', schema:'public', table:'sva_reprocesos' }, payload => {
        if(currentTab==='sva'){ reloadSVA(); }
      })
      .subscribe();
  }

  function _ensureRealtimeLOG(){
    if(!supa || realtimeLog) return;
    realtimeLog = supa.channel('logistica_embarques_live')
      .on('postgres_changes', { event:'*', schema:'public', table:'logistica_embarques' }, payload => {
        if(currentTab==='logistica'){ reloadLogistica(); }
      })
      .subscribe();
  }

  function _initSvaCols(){
    _renderColsGeneric('colsSVA', COLS_SVA, LS_COLS_SVA, () => renderSVA());
    applyColsSVA();
  }

  function _initLogCols(){
    _renderColsGeneric('colsLog', COLS_LOG, LS_COLS_LOG, () => renderLogistica());
    applyColsLog();
  }

  function _toggleCard(cardId){
    const c = el(cardId);
    if(!c) return;
    c.classList.toggle('hidden');
  }

  function _setTodayRange(startId, endId){
    const t = ymd(new Date());
    if(el(startId)) el(startId).value = t;
    if(el(endId)) el(endId).value = t;
  }

  async function reloadSVA(){
    try{
      if(!el('svaStart') || !el('svaEnd')) return;
      if(!el('svaStart').value || !el('svaEnd').value){ _setTodayRange('svaStart','svaEnd'); }
      await ensureSupa();
      if(!supa){
        el('svaMeta').textContent = 'Nube no conectada.';
        el('tbodySVA').innerHTML = '';
        return;
      }
      _ensureRealtimeSVA();

      const d1 = el('svaStart').value;
      const d2 = el('svaEnd').value;
      const { startIso, endIso } = _rangeISOFromTo(d1, d2);

      const term = (el('svaSearch').value||'').trim().toUpperCase();
      const includeDesc = !!el('svaIncluyeDescarga')?.checked;

      const sel = new Set();
      if(el('svaProcCorr')?.checked) sel.add('CAMBIO DE CORRUGADO');
      if(el('svaProcUVA')?.checked) sel.add('UVA');
      if(el('svaProcTIHI')?.checked) sel.add('TI HI');

      let q = supa.from('shipments')
        .select('id,cedis,cuenta,contenedor,indicacion,arribo_at,asig_cortina_at,inicio_descarga_at,fin_descarga_at,estatus,cajas,pallets,tarimas')
        .gte('arribo_at', startIso).lte('arribo_at', endIso)
        .order('arribo_at', { ascending: true });

      const r = await q;
      if(r.error) throw r.error;
      const ships = r.data || [];

      let items = [];
      for(const sh of ships){
        const procs = _detectSvaProcesos(sh.indicacion||'');
        if(!procs.length) continue;

        for(const p of procs){
          if(!sel.has(p)) continue;
          if(!includeDesc && !sh.fin_descarga_at) continue;

          const cont = _normCont(sh.contenedor);
          const fecha = _isoToYMDLocal(sh.arribo_at);
          const key = `${cont}|${fecha}|${p}`;
          items.push({ key, contenedor_norm: cont, arribo_ymd: fecha, proceso: p, sh });
        }
      }

      const conts = [...new Set(items.map(x=>x.contenedor_norm))];
      const recMap = new Map();

      if(conts.length){
        let rq = supa.from('sva_reprocesos').select('*').in('contenedor_norm', conts);
        if(d1) rq = rq.gte('arribo_ymd', d1);
        if(d2) rq = rq.lte('arribo_ymd', d2);
        const rr = await rq;
        if(rr.error) throw rr.error;
        (rr.data||[]).forEach(rec=>{
          const k = `${rec.contenedor_norm}|${rec.arribo_ymd}|${rec.proceso||''}`;
          recMap.set(k, rec);
        });
      }

      svaMerged = items.map((it, i)=>{
        const rec = recMap.get(it.key) || {};
        const sh = it.sh;

        const estatus_sva = rec.estatus_sva || (sh.fin_descarga_at ? 'PENDIENTE' : '');
        const inicio_proc = rec.inicio_proc || null;
        const fin_proc = rec.fin_proc || null;

        const tproc = (inicio_proc && fin_proc) ? _fmtDur(new Date(fin_proc) - new Date(inicio_proc)) : '';

        return {
          no: i+1,
          key: it.key,
          contenedor_norm: it.contenedor_norm,
          contenedor: it.contenedor_norm,
          cedis: sh.cedis || '',
          fecha: it.arribo_ymd || '',
          proceso: it.proceso,
          estatus_sva,
          maquilas: rec.maquilas || '',
          avance_pct: (rec.avance_pct ?? ''),
          inicio_proc,
          fin_proc,
          tiempo_proc: tproc,
          personal_maquila: rec.personal_maquila || '',
          indicacion: sh.indicacion || '',
          sh
        };
      });


      // Enriquecer SVA: maquilas asignadas y producción acumulada (para % general)
      try{
        const conts2 = [...new Set(svaMerged.map(x=>x.contenedor_norm))];
        if(conts2.length){
          // Maquilas asignadas (lista + personal)
          let mqQ = supa.from('sva_reprocesos_maquilas')
            .select('contenedor_norm,arribo_ymd,proceso,maquila,personal,estatus,inicio_at,fin_at')
            .in('contenedor_norm', conts2);
          if(d1) mqQ = mqQ.gte('arribo_ymd', d1);
          if(d2) mqQ = mqQ.lte('arribo_ymd', d2);
          let mqR = await mqQ;
          // Fallback si la tabla aún no tiene columnas de estado por maquila
          if(mqR && mqR.error && String(mqR.error.message||'').toLowerCase().includes('column')){
            mqQ = supa.from('sva_reprocesos_maquilas')
              .select('contenedor_norm,arribo_ymd,proceso,maquila,personal')
              .in('contenedor_norm', conts2);
            if(d1) mqQ = mqQ.gte('arribo_ymd', d1);
            if(d2) mqQ = mqQ.lte('arribo_ymd', d2);
            mqR = await mqQ;
          }
          if(!mqR.error){
            const mapM = new Map();
            for(const row of (mqR.data||[])){
              const k = `${row.contenedor_norm}|${row.arribo_ymd}|${row.proceso||''}`;
              if(!mapM.has(k)) mapM.set(k, []);
              mapM.get(k).push({
                maquila: (row.maquila||'').toUpperCase(),
                personal: (row.personal==null ? null : Number(row.personal)),
                estatus: (row.estatus||'') ? String(row.estatus).toUpperCase() : null,
                inicio_at: row.inicio_at || null,
                fin_at: row.fin_at || null
              });
            }
            for(const r of svaMerged){
              const lst = mapM.get(r.key) || [];
              r.maquilas_info = lst;
              r.maquilas_list = [...new Set(lst.map(x=>x.maquila).filter(Boolean))];
              r.maquilas_state = Object.fromEntries(lst.map(x=>[x.maquila, {estatus:x.estatus||null, inicio_at:x.inicio_at||null, fin_at:x.fin_at||null}]));
            }
          }

          // Producción acumulada (sum cajas) para mostrar avance general
          let prQ = supa.from('sva_prod_hora')
            .select('contenedor_norm,arribo_ymd,proceso,cajas')
            .in('contenedor_norm', conts2);
          if(d1) prQ = prQ.gte('arribo_ymd', d1);
          if(d2) prQ = prQ.lte('arribo_ymd', d2);
          const prR = await prQ;
          if(!prR.error){
            const mapP = new Map();
            for(const row of (prR.data||[])){
              const k = `${row.contenedor_norm}|${row.arribo_ymd}|${row.proceso||''}`;
              mapP.set(k, (mapP.get(k)||0) + Number(row.cajas||0));
            }
            for(const r of svaMerged){
              const done = mapP.get(r.key) || 0;
              const total = _svaTotalCajasFromShipment(r.sh) || 0;
              r.prod_cajas = done;
              r.prod_total_cajas = total;
              r.prod_pct = total>0 ? Math.round((done/total)*100) : null;
            }
          }
        }
      }catch(e){ console.warn(e); }


      if(term){
        svaMerged = svaMerged.filter(x=>{
          const blob = [
            x.contenedor, x.cedis, x.fecha, x.proceso, x.estatus_sva,
            (x.maquilas_list||[]).join(', '), x.maquilas, String((x.prod_pct ?? x.avance_pct) || ''), x.personal_maquila, x.indicacion
          ].join(' ').toUpperCase();
          return blob.includes(term);
        });
        // re-number after filter
        svaMerged.forEach((x,i)=>x.no=i+1);
      }

      el('svaMeta').textContent = `${svaMerged.length} contenedor(es) en SVA con los filtros actuales.`;
      renderSVA();
    }catch(err){
      console.error(err);
      if(el('svaMeta')) el('svaMeta').textContent = `Error al cargar SVA: ${err?.message||err}`;
      if(el('tbodySVA')) el('tbodySVA').innerHTML = '';
    }
  }

  function renderSVA(){
    if(!el('tbodySVA')) return;

    const rows = svaMerged || [];
    const visible = _loadColsGeneric(LS_COLS_SVA, COLS_SVA.map(c=>c.key));

    const td = (key, inner) => `<td data-key="${key}">${inner}</td>`;

    let html = '';
    for(const r of rows){
      const disabled = (!r.sh.fin_descarga_at) ? 'disabled' : '';
      const statusSel = `<select class="input" data-sva="estatus_sva" data-key="${r.key}" ${disabled}>
          <option value="PENDIENTE" ${r.estatus_sva==='PENDIENTE'?'selected':''}>PENDIENTE</option>
          <option value="EN PROCESO" ${r.estatus_sva==='EN PROCESO'?'selected':''}>EN PROCESO</option>
          <option value="TERMINADO" ${r.estatus_sva==='TERMINADO'?'selected':''}>TERMINADO</option>
        </select>`;

      const maqList = (Array.isArray(r.maquilas_list) && r.maquilas_list.length)
        ? r.maquilas_list
        : String(r.maquilas||'').split(',').map(s=>s.trim()).filter(Boolean);

      const maqCount = maqList.length;
      const maqItems = maqList.map(m=>{
        const mm = escapeHtml(m);
        const st = (r.maquilas_state||{})[(String(m||'').toUpperCase())] || {};
        const disStart = (disabled || st.inicio_at || st.estatus==='EN PROCESO' || st.estatus==='TERMINADO') ? 'disabled' : '';
        const disEnd = (disabled || st.fin_at || st.estatus==='TERMINADO' || (!st.inicio_at && st.estatus!=='EN PROCESO')) ? 'disabled' : '';
        const badge = st.estatus ? `<span class="chip" style="opacity:.9">${esc(st.estatus)}</span>` : '';
        return `<div class="svaMaqItem">
          <span class="chip">${mm}</span>${badge}
          <button class="btn secondary tiny" data-sva-act="maqStart" data-key="${r.key}" data-maq="${mm}" ${disStart}>Iniciar</button>
          <button class="btn secondary tiny" data-sva-act="maqEnd" data-key="${r.key}" data-maq="${mm}" ${disEnd}>Terminar</button>
          <button class="btn secondary tiny" data-sva-act="prod" data-key="${r.key}" data-maq="${mm}" title="Capturar productividad / cajas">Productividad</button>
        </div>`;
      }).join('');
      const maquilasIn = maqCount
        ? `<details class="svaDetails"><summary>${maqCount} maquila(s)</summary><div style="margin-top:8px">${maqItems}</div></details>`
        : `<span class="muted">—</span>`;

      const totalCajas = (r.prod_total_cajas ?? _svaTotalCajasFromShipment(r.sh) ?? 0);
      const done = (r.prod_cajas ?? 0);
      const pct = (r.prod_pct!=null) ? r.prod_pct : ((r.avance_pct!=='' && r.avance_pct!=null) ? Number(r.avance_pct) : null);
      const avanceIn = `<div style="min-width:110px">
          <div style="font-weight:900">${pct==null ? '—' : (String(pct)+'%')}</div>
          <div class="muted" style="font-size:12px">${totalCajas ? `${done} / ${totalCajas} cajas` : `${done} cajas`}</div>
        </div>`;

      const persTxt = Array.isArray(r.maquilas_info)
        ? r.maquilas_info.map(x=>`${x.maquila}:${(x.personal==null?'':x.personal)}`).join(', ')
        : (r.personal_maquila||'');
      const persIn = `<span class="muted" style="font-size:12px">${escapeHtml(persTxt||'')}</span>`;


      const inicioTxt = r.inicio_proc ? `${_isoToYMDLocal(r.inicio_proc)} ${_isoToHM(r.inicio_proc)}` : '';
      const finTxt = r.fin_proc ? `${_isoToYMDLocal(r.fin_proc)} ${_isoToHM(r.fin_proc)}` : '';

      const hasState = Array.isArray(r.maquilas_info) && r.maquilas_info.some(x=>x.inicio_at||x.fin_at||x.estatus);
      const canStart = (maqCount>0) ? (!hasState ? true : maqList.some(mm=>{ const st=(r.maquilas_state||{})[mm]||{}; return !(st.inicio_at || st.estatus==='EN PROCESO' || st.estatus==='TERMINADO'); })) : false;
      const canEnd = (maqCount>0) ? (!hasState ? true : maqList.some(mm=>{ const st=(r.maquilas_state||{})[mm]||{}; return (st.inicio_at || st.estatus==='EN PROCESO') && !(st.fin_at || st.estatus==='TERMINADO'); })) : false;

      const btnStart = `<button class="btn secondary" data-sva-act="start" data-key="${r.key}" ${disabled || !canStart ?'disabled':''}>Iniciar</button>`;
      const btnEnd = `<button class="btn secondary" data-sva-act="end" data-key="${r.key}" ${disabled || !canEnd ?'disabled':''}>Terminar</button>`;
      const btnSave = `<button class="btn" data-sva-act="save" data-key="${r.key}" ${disabled}>Guardar</button>`;
      const btnDet  = `<button class="btn secondary" data-sva-act="prod" data-key="${r.key}" ${disabled}>Productividad</button>`;

      const acciones = `<div style="display:flex;gap:6px;flex-wrap:wrap">${btnStart}${btnEnd}${btnSave}${btnDet}</div>`;

      const rowCells = [
        ['no', r.no],
        ['contenedor', escapeHtml(r.contenedor)],
        ['cedis', escapeHtml(r.cedis)],
        ['fecha', escapeHtml(r.fecha)],
        ['proceso', escapeHtml(r.proceso)],
        ['estatus_sva', statusSel],
        ['maquilas', maquilasIn],
        ['avance_pct', avanceIn],
        ['inicio_proc', escapeHtml(inicioTxt)],
        ['fin_proc', escapeHtml(finTxt)],
        ['tiempo_proc', escapeHtml(r.tiempo_proc||'')],
        ['personal_maquila', persIn],
        ['indicacion', `<span class="muted">${escapeHtml(r.indicacion||'')}</span>`],
        ['acciones', acciones]
      ];

      // Build row respecting visible cols
      let tr = '<tr>';
      for(const [k,v] of rowCells){
        if(!visible.includes(k)) continue;
        tr += td(k, String(v));
      }
      tr += '</tr>';
      html += tr;
    }

    el('tbodySVA').innerHTML = html || `<tr><td class="muted" colspan="20">Sin resultados.</td></tr>`;
    applyColsSVA();
    _svaSetupHScroll();

    // wire inputs (delegated)
    const body = el('tbodySVA');
    body.oninput = (ev)=>{
      const t = ev.target;
      if(!t || !t.dataset) return;
      const field = t.dataset.sva;
      const key = t.dataset.key;
      if(!field || !key) return;
      _queueSaveSva(key, {[field]: (field==='avance_pct' ? (t.value===''? null : Number(t.value)) : t.value)});
    };
    body.onchange = body.oninput;

    body.onclick = (ev)=>{
      const t = ev.target;
      if(!t || !t.dataset) return;
      const act = t.dataset.svaAct;
      const key = t.dataset.key;
      if(!act || !key) return;
      if(act==='save'){ _saveSvaNow(key); }
      if(act==='start'){ _startSva(key); }
      if(act==='end'){ _endSva(key); }
      if(act==='maqStart'){ _svaMaqStart(key, t.dataset.maq||null); }
      if(act==='maqEnd'){ _svaMaqEnd(key, t.dataset.maq||null); }
      if(act==='prod'){ openSvaProductividad(key, t.dataset.maq || null); }
    };
  }

  function _findSvaRow(key){
    return (svaMerged||[]).find(x=>x.key===key);
  }

  function _queueSaveSva(key, patch){
    // debounce
    const prev = _svaSaveTimers.get(key);
    if(prev) clearTimeout(prev);
    const timer = setTimeout(()=>_saveSvaPatch(key, patch), 500);
    _svaSaveTimers.set(key, timer);
  }

  async function _saveSvaNow(key){
    const row = _findSvaRow(key);
    if(!row) return;
    await _saveSvaPatch(key, {}); // read inputs from DOM
  }

  async function _saveSvaPatch(key, patch){
    try{
      await ensureSupa();
      if(!supa) return;
      if(!authUser){
        alert('Para guardar SVA necesitas iniciar sesión (ADMIN).');
        return;
      }
      const row = _findSvaRow(key);
      if(!row) return;

      // pull latest from DOM to avoid stale
      const pull = (field)=>{
        const elIn = document.querySelector(`[data-sva="${field}"][data-key="${CSS.escape(key)}"]`);
        if(!elIn) return null;
        if(field==='avance_pct') return elIn.value==='' ? null : Number(elIn.value);
        return elIn.value;
      };

      const toInt = (v)=>{
        if(v==null) return null;
        if(typeof v==='number' && Number.isFinite(v)) return Math.round(v);
        const s = String(v).trim();
        if(s==='') return null;
        const n = Number(s);
        return Number.isFinite(n) ? Math.round(n) : null;
      };

      const patch2 = Object.assign({}, patch);
      if(Object.prototype.hasOwnProperty.call(patch2,'avance_pct')) patch2.avance_pct = toInt(patch2.avance_pct);

      const payload = {
        contenedor_norm: row.contenedor_norm,
        arribo_ymd: row.fecha,
        proceso: row.proceso,
        estatus_sva: pull('estatus_sva') ?? row.estatus_sva,
        maquilas: pull('maquilas') ?? row.maquilas,
        avance_pct: toInt(pull('avance_pct') ?? row.avance_pct),
        personal_maquila: pull('personal_maquila') ?? row.personal_maquila,
        updated_at: new Date().toISOString(),
        ...patch2,
      };

      const resp = await supa.from('sva_reprocesos')
        .upsert(payload, { onConflict: 'contenedor_norm,arribo_ymd,proceso' })
        .select();

      if(resp.error) throw resp.error;

      // huella (log) — no bloquea
      try{
        await supa.from('sva_reprocesos_log').insert([{
          contenedor_norm: payload.contenedor_norm,
          arribo_ymd: payload.arribo_ymd,
          proceso: payload.proceso,
          action: (patch && Object.keys(patch||{}).length) ? 'PATCH_ROW' : 'SAVE_ROW',
          field: 'row',
          old_value: null,
          new_value: JSON.stringify({
            estatus_sva: payload.estatus_sva,
            avance_pct: payload.avance_pct,
            maquilas: payload.maquilas,
            personal_maquila: payload.personal_maquila,
            inicio_proc: payload.inicio_proc || null,
            fin_proc: payload.fin_proc || null,
          }),
          changed_by: authUser?.id || null
        }]);
      }catch(e){ console.warn(e); }

      // refresh row view quickly
      await reloadSVA();
    }catch(err){
      console.error(err);
      alert(`Error al guardar SVA: ${err?.message||err}`);
    }
  }

  async function _startSva(key){
    const row = _findSvaRow(key);
    if(!row) return;
    const maq = _svaChooseMaq(row);
    if(!maq){ toastErr('Selecciona una maquila (primero agrega maquila).'); return; }
    await _svaMaqStart(key, maq);
  }

  async function _endSva(key){
    const row = _findSvaRow(key);
    if(!row) return;
    const maq = _svaChooseMaq(row);
    if(!maq){ toastErr('Selecciona una maquila (primero agrega maquila).'); return; }
    await _svaMaqEnd(key, maq);
  }

  function _svaChooseMaq(row){
    const lst = (row.maquilas_list && row.maquilas_list.length) ? row.maquilas_list : String(row.maquilas||'').split(',').map(s=>s.trim()).filter(Boolean);
    if(lst.length===1) return String(lst[0]||'').toUpperCase();
    if(!lst.length) return null;
    const msg = 'Selecciona maquila:\n' + lst.map((m,i)=>`${i+1}) ${m}`).join('\n');
    const ans = prompt(msg, '1');
    const n = Number(ans);
    if(!Number.isFinite(n) || n<1 || n>lst.length) return null;
    return String(lst[n-1]||'').toUpperCase();
  }

  async function _svaMaqStart(key, maquila){
    try{
      const r = _findSvaRow(key);
      if(!r) return;
      const mq = String(maquila||'').trim().toUpperCase();
      if(!mq) return;

      await ensureSupa();
      if(!supa){ toastErr('Nube no conectada.'); return; }
      if(!authUser){ alert('Para iniciar/terminar por maquila necesitas iniciar sesión (ADMIN).'); return; }

      const { contenedor_norm, arribo_ymd, proceso } = _svaKeyParts(key);
      const nowIso = new Date().toISOString();

      // Intentar actualizar estado por maquila (si existen columnas)
      let ok = true;
      try{
        const cur = await supa.from('sva_reprocesos_maquilas')
          .select('maquila,inicio_at,fin_at,estatus')
          .eq('contenedor_norm', contenedor_norm)
          .eq('arribo_ymd', arribo_ymd)
          .eq('proceso', proceso)
          .eq('maquila', mq)
          .limit(1);

        const exists = (cur.data && cur.data.length) ? cur.data[0] : null;
        const inicio_at = exists?.inicio_at || nowIso;

        const up = await supa.from('sva_reprocesos_maquilas')
          .upsert([{
            contenedor_norm, arribo_ymd, proceso,
            maquila: mq,
            inicio_at,
            fin_at: null,
            estatus: 'EN PROCESO'
          }], { onConflict: 'contenedor_norm,arribo_ymd,proceso,maquila' });
        if(up.error) throw up.error;
      }catch(e){
        ok = false;
        console.warn(e);
      }

      // Huella (siempre)
      try{
        await supa.from('sva_reprocesos_log').insert([{
          contenedor_norm, arribo_ymd, proceso,
          action: 'MAQ_START',
          field: 'maquila',
          old_value: null,
          new_value: JSON.stringify({ maquila: mq, at: nowIso, ok }),
          changed_by: authUser?.id || null
        }]);
      }catch(e){ console.warn(e); }

      // Recalcular estatus del contenedor en base a maquilas
      if(!ok){
        // Fallback (si aún no existen columnas por maquila)
        await _saveSvaPatch(key, {
          estatus_sva: 'EN PROCESO',
          inicio_proc: r.inicio_proc || nowIso,
          avance_pct: (r.avance_pct==='' || r.avance_pct==null) ? 0 : r.avance_pct
        });
        toastErr('Falta esquema de estado por maquila en la nube (sva_reprocesos_maquilas.inicio_at/fin_at/estatus).');
        await reloadSVA();
        return;
      }

      await _svaRecalcMasterFromMaquilas(key);

      await reloadSVA();
      toastOk(`Iniciado: ${mq}`);
    }catch(err){
      console.error(err);
      toastErr('No se pudo iniciar maquila.');
    }
  }

  async function _svaMaqEnd(key, maquila){
    try{
      const r = _findSvaRow(key);
      if(!r) return;
      const mq = String(maquila||'').trim().toUpperCase();
      if(!mq) return;

      await ensureSupa();
      if(!supa){ toastErr('Nube no conectada.'); return; }
      if(!authUser){ alert('Para iniciar/terminar por maquila necesitas iniciar sesión (ADMIN).'); return; }

      const { contenedor_norm, arribo_ymd, proceso } = _svaKeyParts(key);
      const nowIso = new Date().toISOString();

      let ok = true;
      try{
        const cur = await supa.from('sva_reprocesos_maquilas')
          .select('maquila,inicio_at,fin_at,estatus')
          .eq('contenedor_norm', contenedor_norm)
          .eq('arribo_ymd', arribo_ymd)
          .eq('proceso', proceso)
          .eq('maquila', mq)
          .limit(1);

        const exists = (cur.data && cur.data.length) ? cur.data[0] : null;
        const inicio_at = exists?.inicio_at || nowIso;

        const up = await supa.from('sva_reprocesos_maquilas')
          .upsert([{
            contenedor_norm, arribo_ymd, proceso,
            maquila: mq,
            inicio_at,
            fin_at: nowIso,
            estatus: 'TERMINADO'
          }], { onConflict: 'contenedor_norm,arribo_ymd,proceso,maquila' });
        if(up.error) throw up.error;
      }catch(e){
        ok = false;
        console.warn(e);
      }

      try{
        await supa.from('sva_reprocesos_log').insert([{
          contenedor_norm, arribo_ymd, proceso,
          action: 'MAQ_END',
          field: 'maquila',
          old_value: null,
          new_value: JSON.stringify({ maquila: mq, at: nowIso, ok }),
          changed_by: authUser?.id || null
        }]);
      }catch(e){ console.warn(e); }

      await _svaRecalcMasterFromMaquilas(key);
      if(!ok){
        await _saveSvaPatch(key, {
          estatus_sva: 'TERMINADO',
          fin_proc: nowIso,
          avance_pct: 100
        });
        toastErr('Falta esquema de estado por maquila en la nube (sva_reprocesos_maquilas.inicio_at/fin_at/estatus).');
        await reloadSVA();
        return;
      }



      await reloadSVA();
      toastOk(`Terminado: ${mq}`);
    }catch(err){
      console.error(err);
      toastErr('No se pudo terminar maquila.');
    }
  }

  async function _svaRecalcMasterFromMaquilas(key){
    try{
      await ensureSupa();
      if(!supa) return;
      const row = _findSvaRow(key);
      if(!row) return;

      const { contenedor_norm, arribo_ymd, proceso } = _svaKeyParts(key);

      // leer estados por maquila (si hay columnas)
      const mq = await supa.from('sva_reprocesos_maquilas')
        .select('maquila,inicio_at,fin_at,estatus')
        .eq('contenedor_norm', contenedor_norm)
        .eq('arribo_ymd', arribo_ymd)
        .eq('proceso', proceso);

      if(mq.error){ console.warn(mq.error); return; }

      const lst = (mq.data||[]).map(x=>({
        maquila: String(x.maquila||'').toUpperCase(),
        inicio_at: x.inicio_at || null,
        fin_at: x.fin_at || null,
        estatus: (x.estatus||'') ? String(x.estatus).toUpperCase() : null
      })).filter(x=>x.maquila);

      if(!lst.length) return;

      const started = lst.filter(x=>x.inicio_at || x.estatus==='EN PROCESO' || x.estatus==='TERMINADO').length;
      const ended = lst.filter(x=>x.fin_at || x.estatus==='TERMINADO').length;

      let estatus_sva = 'PENDIENTE';
      if(ended===lst.length) estatus_sva = 'TERMINADO';
      else if(started>0) estatus_sva = 'EN PROCESO';

      const inicio_proc = (started>0) ? lst.map(x=>x.inicio_at).filter(Boolean).sort()[0] : null;
      const fin_proc = (ended===lst.length) ? lst.map(x=>x.fin_at).filter(Boolean).sort().slice(-1)[0] : null;
      const tiempo_proc = (inicio_proc && fin_proc) ? _fmtDur(new Date(fin_proc)-new Date(inicio_proc)) : null;

      await supa.from('sva_reprocesos').upsert([{
        contenedor_norm, arribo_ymd, proceso,
        estatus_sva,
        inicio_proc: inicio_proc || null,
        fin_proc: fin_proc || null,
        tiempo_proc: tiempo_proc || null,
        updated_at: new Date().toISOString()
      }], { onConflict: 'contenedor_norm,arribo_ymd,proceso' });
    }catch(e){ console.warn(e); }
  }

  let _svaScrollBound = false;
  function _svaSetupHScroll(){
    try{
      const wrap = el('svaTableWrap');
      const bar = el('svaHScroll');
      const inner = el('svaHScrollInner');
      if(!wrap || !bar || !inner) return;

      inner.style.width = wrap.scrollWidth + 'px';

      if(!_svaScrollBound){
        let lock = false;
        wrap.addEventListener('scroll', ()=>{
          if(lock) return;
          lock = true;
          bar.scrollLeft = wrap.scrollLeft;
          lock = false;
        });
        bar.addEventListener('scroll', ()=>{
          if(lock) return;
          lock = true;
          wrap.scrollLeft = bar.scrollLeft;
          lock = false;
        });
        window.addEventListener('resize', ()=>{
          inner.style.width = wrap.scrollWidth + 'px';
        });
        _svaScrollBound = true;
      }
      // sincroniza posición
      bar.scrollLeft = wrap.scrollLeft;
    }catch(e){ console.warn(e); }
  }

  async function reloadLogistica(){
    try{
      if(!el('logStart') || !el('logEnd')) return;
      if(!el('logStart').value || !el('logEnd').value){ _setTodayRange('logStart','logEnd'); }
      await ensureSupa();
      if(!supa){
        el('logMeta').textContent = 'Nube no conectada.';
        el('tbodyLog').innerHTML = '';
        return;
      }
      _ensureRealtimeLOG();

      const d1 = el('logStart').value;
      const d2 = el('logEnd').value;
      const term = (el('logSearch').value||'').trim().toUpperCase();

      let q = supa.from('logistica_embarques').select('*');
      if(d1) q = q.gte('cita_ymd', d1);
      if(d2) q = q.lte('cita_ymd', d2);
      q = q.order('cita_ymd', { ascending: true }).order('hora_cita', { ascending: true });

      const r = await q;
      if(r.error) throw r.error;

      logRows = (r.data||[]);

      if(term){
        logRows = logRows.filter(x=>{
          const blob = [
            x.cita_ymd, x.hora_cita, x.anden, x.contenedor_norm, x.upcs, x.cantidades, x.estatus, x.notas
          ].join(' ').toUpperCase();
          return blob.includes(term);
        });
      }

      el('logMeta').textContent = `${logRows.length} embarque(s) con los filtros actuales.`;
      renderLogistica();
    }catch(err){
      console.error(err);
      if(el('logMeta')) el('logMeta').textContent = `Error al cargar LOGÍSTICA: ${err?.message||err}`;
      if(el('tbodyLog')) el('tbodyLog').innerHTML = '';
    }
  }

  function renderLogistica(){
    if(!el('tbodyLog')) return;

    const visible = _loadColsGeneric(LS_COLS_LOG, COLS_LOG.map(c=>c.key));

    const td = (key, inner) => `<td data-key="${key}">${inner}</td>`;

    let html = '';
    for(const r of (logRows||[])){
      const id = r.id;
      const inText = (field, val, ph='') => `<input class="input" data-log="${field}" data-id="${id}" value="${escapeHtml(val??'')}" placeholder="${escapeHtml(ph)}">`;
      const inNum = (field, val) => `<input class="input" type="number" min="0" step="1" style="max-width:120px" data-log="${field}" data-id="${id}" value="${val??''}">`;

      const estSel = `<select class="input" data-log="estatus" data-id="${id}">
          ${['PROGRAMADO','EN_CARGA','EMBARCADO','CANCELADO'].map(op=>`<option value="${op}" ${r.estatus===op?'selected':''}>${op.replace('_',' ')}</option>`).join('')}
        </select>`;

      const btnSave = `<button class="btn" data-log-act="save" data-id="${id}">Guardar</button>`;

      const rowCells = [
        ['cita_ymd', escapeHtml(r.cita_ymd||'')],
        ['hora_cita', inText('hora_cita', r.hora_cita, '10:00')],
        ['anden', inText('anden', r.anden, 'Z10')],
        ['contenedor_norm', inText('contenedor_norm', r.contenedor_norm, 'ECMU...')],
        ['tarimas', inNum('tarimas', r.tarimas)],
        ['upcs', inText('upcs', r.upcs, '')],
        ['cantidades', inText('cantidades', r.cantidades, '')],
        ['estatus', estSel],
        ['notas', inText('notas', r.notas, '')],
        ['acciones', btnSave]
      ];

      let tr = '<tr>';
      for(const [k,v] of rowCells){
        if(!visible.includes(k)) continue;
        tr += td(k, String(v));
      }
      tr += '</tr>';
      html += tr;
    }

    el('tbodyLog').innerHTML = html || `<tr><td class="muted" colspan="20">Sin resultados.</td></tr>`;
    applyColsLog();

    const body = el('tbodyLog');
    body.oninput = (ev)=>{
      const t = ev.target;
      if(!t || !t.dataset) return;
      const field = t.dataset.log;
      const id = t.dataset.id;
      if(!field || !id) return;

      const val = (t.type==='number') ? (t.value===''? null : Number(t.value)) : t.value;
      _queueSaveLog(id, {[field]: val});
    };
    body.onchange = body.oninput;

    body.onclick = (ev)=>{
      const t = ev.target;
      if(!t || !t.dataset) return;
      if(t.dataset.logAct==='save'){
        _saveLogNow(t.dataset.id);
      }
    };
  }

  function _queueSaveLog(id, patch){
    const prev = _logSaveTimers.get(id);
    if(prev) clearTimeout(prev);
    const timer = setTimeout(()=>_saveLogPatch(id, patch), 700);
    _logSaveTimers.set(id, timer);
  }

  async function _saveLogNow(id){
    await _saveLogPatch(id, {});
  }

  async function _saveLogPatch(id, patch){
    try{
      await ensureSupa();
      if(!supa) return;
      if(!authUser){
        alert('Para guardar LOGÍSTICA necesitas iniciar sesión (ADMIN).');
        return;
      }
      const pull = (field)=>{
        const elIn = document.querySelector(`[data-log="${field}"][data-id="${CSS.escape(String(id))}"]`);
        if(!elIn) return null;
        if(elIn.type==='number') return elIn.value==='' ? null : Number(elIn.value);
        return elIn.value;
      };

      const payload = {
        hora_cita: pull('hora_cita'),
        anden: pull('anden'),
        contenedor_norm: _normCont(pull('contenedor_norm')||''),
        tarimas: pull('tarimas'),
        upcs: pull('upcs'),
        cantidades: pull('cantidades'),
        estatus: pull('estatus'),
        notas: pull('notas'),
        updated_at: new Date().toISOString(),
        ...patch
      };

      const r = await supa.from('logistica_embarques').update(payload).eq('id', id);
      if(r.error) throw r.error;
      // small refresh
      // no reload needed, but keep data consistent:
      // await reloadLogistica();
    }catch(err){
      console.error(err);
      alert(`Error al guardar LOGÍSTICA: ${err?.message||err}`);
    }
  }

  async function addLogistica(){
    try{
      await ensureSupa();
      if(!supa) return;
      if(!authUser){
        alert('Para agregar embarques necesitas iniciar sesión (ADMIN).');
        return;
      }
      const fecha = el('logAddFecha').value || ymd(new Date());
      const payload = {
        cita_ymd: fecha,
        hora_cita: (el('logAddHora').value||'').trim() || null,
        anden: (el('logAddAnden').value||'').trim() || null,
        contenedor_norm: _normCont((el('logAddCont').value||'').trim()),
        tarimas: el('logAddTar').value==='' ? null : Number(el('logAddTar').value),
        upcs: (el('logAddUpcs').value||'').trim() || null,
        cantidades: (el('logAddCant').value||'').trim() || null,
        estatus: el('logAddEstatus').value || 'PROGRAMADO',
        notas: null,
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString(),
      };
      const r = await supa.from('logistica_embarques').insert(payload);
      if(r.error) throw r.error;

      // limpiar
      el('logAddHora').value = '';
      el('logAddAnden').value = '';
      el('logAddCont').value = '';
      el('logAddTar').value = '';
      el('logAddUpcs').value = '';
      el('logAddCant').value = '';
      el('logAddEstatus').value = 'PROGRAMADO';

      await reloadLogistica();
    }catch(err){
      console.error(err);
      alert(`Error al agregar embarque: ${err?.message||err}`);
    }
  }

// Clock
  function tick(){ el('clock').textContent = new Date().toLocaleString('es-MX',{hour12:false}); }
  setInterval(tick, 1000); tick();

  // Eventos
  el('tabBoard').addEventListener('click', ()=>setTab('board'));
  if(el('btnExport')) el('btnExport').addEventListener('click', exportBoardToExcel);
  el('tabAdmin').addEventListener('click', ()=>setTab('admin'));
  if(el('tabScreen')) el('tabScreen').addEventListener('click', ()=>setTab('screen'));
  if(el('tabSummary')) el('tabSummary').addEventListener('click', ()=>setTab('summary'));
  if(el('tabDashboard')) el('tabDashboard').addEventListener('click', ()=>setTab('dashboard'));
  if(el('tabSVA')) el('tabSVA').addEventListener('click', ()=>setTab('sva'));
  if(el('tabLogistica')) el('tabLogistica').addEventListener('click', ()=>setTab('logistica'));
  el('toScreen').addEventListener('click', ()=>setTab('screen'));

  // Subvistas: botones en ADMIN
  if(el('btnAdminPorLlegar')) el('btnAdminPorLlegar').addEventListener('click', ()=>{ initSubViews(); setTab('porllegar'); });
  if(el('btnAdminHistorico')) el('btnAdminHistorico').addEventListener('click', ()=>{ initSubViews(); setTab('historico'); });

  if(el('btnBackPorLlegar')) el('btnBackPorLlegar').addEventListener('click', ()=>setTab('admin'));
  if(el('btnBackHistorico')) el('btnBackHistorico').addEventListener('click', ()=>setTab('admin'));

  if(el('toggleColsPorLlegar')) el('toggleColsPorLlegar').addEventListener('click', ()=>{ el('colsPorLlegarCard').classList.toggle('hidden'); });
  if(el('toggleColsHistorico')) el('toggleColsHistorico').addEventListener('click', ()=>{ el('colsHistoricoCard').classList.toggle('hidden'); });

  if(el('btnReloadPorLlegar')) el('btnReloadPorLlegar').addEventListener('click', reloadPorLlegar);
  if(el('btnReloadHistorico')) el('btnReloadHistorico').addEventListener('click', reloadHistorico);

  // filtros Por llegar
  if(el('btnPorLlegarHoy')) el('btnPorLlegarHoy').addEventListener('click', ()=>{ 
    const t = ymd(); el('porLlegarStart').value = t; el('porLlegarEnd').value = t; reloadPorLlegar();
  });
  if(el('porLlegarSearch')){
    el('porLlegarSearch').addEventListener('input', ()=>{ clearTimeout(_porLlegarTimer); _porLlegarTimer = setTimeout(reloadPorLlegar, 250); });
    el('porLlegarSearch').addEventListener('blur', ()=>{ clearTimeout(_porLlegarTimer); _porLlegarTimer = setTimeout(reloadPorLlegar, 10); });
  }
  if(el('porLlegarStart')) el('porLlegarStart').addEventListener('change', ()=>{ clearTimeout(_porLlegarTimer); _porLlegarTimer = setTimeout(reloadPorLlegar, 50); });
  if(el('porLlegarEnd')) el('porLlegarEnd').addEventListener('change', ()=>{ clearTimeout(_porLlegarTimer); _porLlegarTimer = setTimeout(reloadPorLlegar, 50); });

  // filtros Histórico
  if(el('btnHistoricoHoy')) el('btnHistoricoHoy').addEventListener('click', ()=>{ 
    const t = ymd(); el('historicoStart').value = t; el('historicoEnd').value = t; reloadHistorico();
  });

  // filtros SVA
  if(el('toggleColsSVA')) el('toggleColsSVA').addEventListener('click', ()=>_toggleCard('colsSVACard'));
  if(el('btnReloadSVA')) el('btnReloadSVA').addEventListener('click', reloadSVA);
  if(el('btnSVAHoy')) el('btnSVAHoy').addEventListener('click', ()=>{ const t = ymd(); el('svaStart').value = t; el('svaEnd').value = t; reloadSVA(); });
  if(el('svaSearch')) el('svaSearch').addEventListener('input', ()=>{ clearTimeout(_svaTimer); _svaTimer = setTimeout(reloadSVA, 80); });
  if(el('svaStart')) el('svaStart').addEventListener('change', ()=>reloadSVA());
  if(el('svaEnd')) el('svaEnd').addEventListener('change', ()=>reloadSVA());
  if(el('svaProcCorr')) el('svaProcCorr').addEventListener('change', ()=>reloadSVA());
  if(el('svaProcUVA')) el('svaProcUVA').addEventListener('change', ()=>reloadSVA());
  if(el('svaProcTIHI')) el('svaProcTIHI').addEventListener('change', ()=>reloadSVA());
  if(el('svaIncluyeDescarga')) el('svaIncluyeDescarga').addEventListener('change', ()=>reloadSVA());

  // filtros LOGÍSTICA
  if(el('toggleColsLog')) el('toggleColsLog').addEventListener('click', ()=>_toggleCard('colsLogCard'));
  if(el('btnReloadLog')) el('btnReloadLog').addEventListener('click', reloadLogistica);
  if(el('btnLogHoy')) el('btnLogHoy').addEventListener('click', ()=>{ const t = ymd(); el('logStart').value = t; el('logEnd').value = t; reloadLogistica(); });
  if(el('logSearch')) el('logSearch').addEventListener('input', ()=>{ clearTimeout(_logTimer); _logTimer = setTimeout(reloadLogistica, 80); });
  if(el('logStart')) el('logStart').addEventListener('change', ()=>reloadLogistica());
  if(el('logEnd')) el('logEnd').addEventListener('change', ()=>reloadLogistica());
  if(el('btnLogAdd')) el('btnLogAdd').addEventListener('click', addLogistica);
  if(el('logAddFecha') && !el('logAddFecha').value) el('logAddFecha').value = ymd();
  if(el('historicoSearch')){
    el('historicoSearch').addEventListener('input', ()=>{ clearTimeout(_historicoTimer); _historicoTimer = setTimeout(reloadHistorico, 250); });
    el('historicoSearch').addEventListener('blur', ()=>{ clearTimeout(_historicoTimer); _historicoTimer = setTimeout(reloadHistorico, 10); });
  }
  if(el('historicoStart')) el('historicoStart').addEventListener('change', ()=>{ clearTimeout(_historicoTimer); _historicoTimer = setTimeout(reloadHistorico, 50); });
  if(el('historicoEnd')) el('historicoEnd').addEventListener('change', ()=>{ clearTimeout(_historicoTimer); _historicoTimer = setTimeout(reloadHistorico, 50); });


  el('q').addEventListener('input', ()=>renderBoard());
  // CEDIS multi-select handled by initCedisMulti()

  // Estatus multi-select handled by initStatusMulti()
el('dateStart').addEventListener('change', ()=>setWorkRange(el('dateStart').value, el('dateEnd').value));
  el('dateEnd').addEventListener('change', ()=>setWorkRange(el('dateStart').value, el('dateEnd').value));
  el('btnToday').addEventListener('click', ()=>setWorkRange(ymd(), ''));

  el('toggleCols').addEventListener('click', ()=>{ el('colsCard').classList.toggle('hidden'); resizeTableWrap(); });

  el('toggleFullscreen').addEventListener('click', async ()=>{
    try{
      if(!document.fullscreenElement) await document.documentElement.requestFullscreen();
      else await document.exitFullscreen();
    }catch{}
  });

  // Sorting
  document.querySelectorAll('#table thead th[data-key]').forEach(th=>{
    th.addEventListener('click', ()=>{
      const k = th.dataset.key;
      if(sortKey===k) sortDir *= -1;
      else { sortKey=k; sortDir=1; }
      renderBoard();
    });
  });

  // Auth
  el('btnShowAuth').addEventListener('click', openAuthDialog);
  el('authClose').addEventListener('click', closeAuthDialog);
  el('authBackdrop').addEventListener('click', (e)=>{ if(e.target===el('authBackdrop')) closeAuthDialog(); });
  el('btnLogin').addEventListener('click', login);
  el('btnLogout').addEventListener('click', logout);

  // Admin add
  el('btnAdd').addEventListener('click', async ()=>{
    const cedis = (el('f_cedis').value || '').trim();
    const cont = (el('f_contenedor').value || '').trim();
    if(!cedis || !cont){ alert('CEDIS y Contenedor/Unidad son obligatorios'); return; }

    try{
      await addRowCloud({
        cedis,
        cuenta: (el('f_cuenta').value||'').trim(),
        contenedor: cont,
        anden: (el('f_anden').value||'').trim(),
        responsable: (el('f_responsable').value||'').trim(),
        indicacion: (el('f_indicacion').value||'').trim(),
        cajas: (el('f_cajas').value||'').trim(),
        tarimas: (el('f_tarimas').value||'').trim(),
        pallets: (el('f_pallets').value||'').trim(),
        playos_utilizados: (el('f_playos').value||'').trim(),
      });

      ['f_contenedor','f_cuenta','f_anden','f_responsable','f_indicacion','f_cajas','f_tarimas','f_pallets','f_playos'].forEach(id=>el(id).value='');
      setTab('board');
    }catch(e){
      alert('Error al agregar: ' + (e?.message || e));
    }
  });

  // Histórico 2026/01/07 (opcional)
  const btnSeed = el('btnSeed');
  if(btnSeed) btnSeed.addEventListener('click', async ()=>{
    try{
      await ensureSupabase();
      await seedExampleCloud();
    }catch(e){
      alert('No se pudo cargar el histórico: ' + (e?.message || e));
    }
  });

  // Cierre del día (archivar concluidos)
  el('btnCloseDay').addEventListener('click', async ()=>{
    try{
      await ensureSupabase();
      const day = getWorkDate();
      await closeDayCloud(day, false);
    }catch(e){
      alert('No se pudo cerrar el día: ' + (e?.message || e));
    }
  });

  // Desconectar nube
  el('btnReset').addEventListener('click', clearCfg);

  // Modal detalle
  el('modalClose').addEventListener('click', closeDetail);
  el('modalBackdrop').addEventListener('click', (e)=>{ if(e.target===el('modalBackdrop')) closeDetail(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeDetail(); closeCfg(); } });

    // DETAIL_ACTIONS_WIRE: acciones en Detalle (TABLERO)
    el('modalBody').addEventListener('click', async (ev)=>{
      const t = ev.target;
      const id = el('modalBackdrop').dataset.curId;
      if(!id) return;

      if(t && t.id === 'd_apply'){
        const to = el('d_next') ? el('d_next').value : '';
        if(!to){ alert('Selecciona un estatus'); return; }
        try{
          await applyTransitionCloud(id, to);
          openDetail(id);
        }catch(e){
          alert('Error al actualizar: ' + (e?.message || e));
        }
      }

      if(t && t.id === 'd_back_apply'){
        try{
          await rollbackOneStepCloud(id);
          openDetail(id);
        }catch(e){
          alert('Error al regresar un paso: ' + (e?.message || e));
        }
      }

      if(t && t.id === 'd_edit'){
        if(!authUser){ alert('Inicia sesión para editar.'); return; }
        openEdit(id);
      }

      if(t && t.id === 'd_del'){
        if(!authUser){ alert('Inicia sesión para eliminar.'); return; }
        const ok = confirm('¿Eliminar este registro? (se guarda huella)');
        if(!ok) return;
        try{
          await softDelete(id);
          closeDetail();
        }catch(e){
          alert('Error al eliminar: ' + (e?.message || e));
        }
      }
    });


  // Config modal
  el('btnCloud').addEventListener('click', openCfg);
  el('chipCloud').addEventListener('click', openCfg);
  el('cfgClose').addEventListener('click', closeCfg);
  el('cfgBackdrop').addEventListener('click', (e)=>{ if(e.target===el('cfgBackdrop')) closeCfg(); });

  el('cfgSave').addEventListener('click', async ()=>{
    const url = normalizeUrl(el('cfgUrl').value);
    const anon = (el('cfgAnon').value || '').trim();
    if(!url || !anon){ toast('Falta Project URL o anon key.'); return; }
    saveCfg({ url, anon });
    supa = null; // reinit
    authUser = null;
    closeCfg();
    setCloudChip();
    try{
      await ensureSupabase();
      await reloadData(true);
      alert('Conexión guardada.');
    }catch(e){
      alert('Guardado, pero no se pudo conectar: ' + (e?.message || e));
      openCfg();
    }
  });
  el('cfgTest').addEventListener('click', testConnection);
  el('cfgShare').addEventListener('click', async ()=>{
    const url = normalizeUrl(el('cfgUrl').value || (loadCfg()?.url || ''));
    const anon = (el('cfgAnon').value || (loadCfg()?.anon || '')).trim();
    if(!url || !anon){
      toast('Primero pega Project URL y anon key, luego presiona "Copiar link".');
      return;
    }
    const link = makeShareLink({ url, anon });
    await copyText(link);
    el('cfgMsg').textContent = 'Link copiado. Pásalo a tu equipo: al abrirlo se configura automáticamente.';
  });
  el('cfgClear').addEventListener('click', clearCfg);

  // Inicialización
  (function init(){
    // Si abres el tablero con un link tipo ?cfg=..., se guardará la config automáticamente
    applyCfgFromUrl();
    renderFilters();
    renderStatusHelp();
    setCloudChip();
    setAuthUI();

    const wr = getWorkRange();
    if(el('dateStart')) el('dateStart').value = wr.start;
    if(el('dateEnd')) el('dateEnd').value = wr.endRaw || '';

    resizeTableWrap();
    window.addEventListener('resize', resizeTableWrap);
    document.addEventListener('fullscreenchange', resizeTableWrap);

    // intenta conectar; si falta config, abre modal
    reloadData(true);

    // refresco cada 12s (además de realtime)
    setInterval(()=>{ if(!document.hidden) reloadData(false); }, 12000);
  })();


  
  // ------------------- RESUMEN -------------------
  function num0(v){
    if(v===null || v===undefined) return 0;
    const s = String(v).trim();
    if(!s) return 0;
    // acepta "1,234" o "1 234"
    const cleaned = s.replace(/[^\d\.\-]/g,'');
    const n = Number(cleaned);
    return Number.isFinite(n) ? n : 0;
  }

  function renderSummary(){
    if(!el('summaryView')) return;

    const range = getWorkRange();
    const rows = getFilteredRows(); // respeta filtros (CEDIS/Estatus/Fecha/Buscar) + regla de visibles

    const cedisTxt = (cedisFilter.size===0) ? 'CEDIS: Todos' : `CEDIS: ${cedisFilter.size} seleccionados`;
    const estTxt = (statusFilter.size===0) ? 'Estatus: Todos' : `Estatus: ${statusFilter.size} seleccionados`;
    if(el('sumMetaCedis')) el('sumMetaCedis').textContent = cedisTxt;
    if(el('sumMetaEstatus')) el('sumMetaEstatus').textContent = estTxt;
    const fTxt = (range.start===range.end) ? range.start : `${range.start} - ${range.end}`;
    if(el('sumMetaFecha')) el('sumMetaFecha').textContent = `Fecha: ${fTxt.replaceAll('-','/')}`;
    refreshStaffKPIsDebounced();

    const statusOrder = (STATUS||[]).map(s=>({code:s.code,label:s.label})).filter(x=>x.code && x.label);

    // Acumuladores por estatus
    const acc = {};
    statusOrder.forEach(s=>{
      acc[s.code] = {day:0, prev:0, cajas:0, tarimas:0, pallets:0, playos:0};
    });

    for(const r of rows){
      const a = acc[r.status] || (acc[r.status] = {day:0, prev:0, cajas:0, tarimas:0, pallets:0, playos:0});
      const isDay = (range.start===range.end) ? (r.arribo_ymd === range.start) : (r.arribo_ymd >= range.start && r.arribo_ymd <= range.end);
      if(isDay) a.day += 1; else a.prev += 1;
      a.cajas += num0(r.cajas);
      a.tarimas += num0(r.tarimas);
      a.pallets += num0(r.pallets);
      a.playos += num0(r.playos_utilizados);
    }

    // Columnas visibles: solo estatus con info
    const visible = statusOrder.filter(s=>{
      const a = acc[s.code] || {day:0, prev:0, cajas:0, tarimas:0, pallets:0, playos:0};
      return (a.day + a.prev) > 0 || a.cajas > 0 || a.tarimas > 0 || a.pallets > 0 || a.playos > 0;
    });

    const thead = el('theadSummary');
    const tbody = el('tbodySummary');
    const info = el('summaryInfo');

    if(visible.length===0){
      thead.innerHTML = '';
      tbody.innerHTML = '';
      if(info) info.textContent = 'Sin registros con los filtros actuales';
      return;
    }

    // Header
    thead.innerHTML = `
      <tr>
        <th style="min-width:220px">CONTENEDORES POR ESTATUS</th>
        ${visible.map(s=>`<th class="sumHdr ${statusClass(s.code)}">${esc(s.label)}</th>`).join('')}
        <th>GRAN TOTAL</th>
      </tr>
    `;

    function sumRow(key){
      let total = 0;
      for(const s of visible){
        const a = acc[s.code] || {day:0, prev:0, cajas:0, tarimas:0, pallets:0, playos:0};
        if(key==='day') total += a.day;
        else if(key==='prev') total += a.prev;
        else if(key==='total') total += (a.day + a.prev);
        else if(key==='cajas') total += a.cajas;
        else if(key==='tarimas') total += a.tarimas;
        else if(key==='pallets') total += a.pallets;
        else if(key==='playos') total += a.playos;
      }
      return total;
    }

    function cellVal(s, key){
      const a = acc[s.code] || {day:0, prev:0, cajas:0, tarimas:0, pallets:0, playos:0};
      if(key==='day') return a.day;
      if(key==='prev') return a.prev;
      if(key==='total') return (a.day + a.prev);
      if(key==='cajas') return a.cajas;
      if(key==='tarimas') return a.tarimas;
      if(key==='pallets') return a.pallets;
      if(key==='playos') return a.playos;
      return 0;
    }

    const rowsDef = [
      {key:'day', label:'DEL DÍA'},
      {key:'prev', label:'ANTERIORES'},
      {key:'total', label:'TOTAL CONTENEDORES'},
      {key:'cajas', label:'TOTAL CAJAS'},
      {key:'tarimas', label:'TOTAL TARIMAS'},
      {key:'pallets', label:'TOTAL PALLETS'},
      {key:'playos', label:'TOTAL PLAYOS UTILIZADOS'},
    ];

    tbody.innerHTML = (()=>{
      let html = '';
      rowsDef.forEach((rd,i)=>{
        const grand = sumRow(rd.key);
        html += `
        <tr class="${i===0 ? 'sumRowTop':''}">
          <td class="mono" style="font-weight:700">${esc(rd.label)}</td>
          ${visible.map(s=>{
            const v = cellVal(s, rd.key);
            const txt = (rd.key==='cajas' || rd.key==='tarimas' || rd.key==='pallets' || rd.key==='playos') ? String(Math.round(v)) : String(v);
            return `<td class="mono" style="text-align:center">${esc(txt)}</td>`;
          }).join('')}
          <td class="mono" style="text-align:center;font-weight:800">${esc(String(Math.round(grand)))}</td>
        </tr>
      `;

        // Debajo de TOTAL PALLETS
        if(rd.key==='pallets'){
          const tp = Number(_staffKpiCache.plantilla || 0);
          const tm = Number(_staffKpiCache.maniobra || 0);
          html += `
        <tr>
          <td class="mono" style="font-weight:700">TOTAL PLANTILLA</td>
          ${visible.map(_=>'<td class="mono" style="text-align:center"></td>').join('')}
          <td class="mono" style="text-align:center;font-weight:800">${esc(String(Math.round(tp)))}</td>
        </tr>
        <tr>
          <td class="mono" style="font-weight:700">TOTAL MANIOBRA</td>
          ${visible.map(_=>'<td class="mono" style="text-align:center"></td>').join('')}
          <td class="mono" style="text-align:center;font-weight:800">${esc(String(Math.round(tm)))}</td>
        </tr>
      `;
        }
      });
      return html;
    })();

    if(info) info.textContent = `Contenedores visibles: ${rows.length} · Estatus con datos: ${visible.length}`;
  }
  // ------------------------------------------------


  // ------------------- PANTALLA (rotación) -------------------
  let screenTimer = null;
  let screenOffset = 0;

  function getFilteredRows(){
    const range = getWorkRange();
const q = (el('q')?.value || '').trim();
    const cSet = cedisFilter;
    const stSet = statusFilter;

    let rows = (STATE.rows || []).slice();
    rows = rows.filter(r=>isVisible(r, range));
    if(cSet && cSet.size) rows = rows.filter(r=>cSet.has(r.cedis));
    if(stSet && stSet.size) rows = rows.filter(r=>stSet.has(r.status));
    if(q) rows = rows.filter(r=>matches(r, q));
    rows.sort(cmp);
    return rows;
  }

  function renderAllViews(){
    // Re-render whichever view is active
    const isScreen = !el('screenView').classList.contains('hidden');
    const isSummary = !!el('summaryView') && !el('summaryView').classList.contains('hidden');
    const isDashboard = !!el('dashboardView') && !el('dashboardView').classList.contains('hidden');

    renderBoard();
    if(isScreen) renderScreen();
    if(isSummary) renderSummary();
    if(isDashboard) renderDashboard();
  }

    // ------------------- DASHBOARD -------------------
  let dashCajas = null;
  let dashTiempo = null;
  let dashIndic = null;

  function dashEnsureCharts(){
    if(!window.echarts) return false;
    const c1 = el('chartCajas');
    const c2 = el('chartTiempo');
    const c3 = el('chartIndicaciones');
    if(c1 && !dashCajas) dashCajas = echarts.init(c1);
    if(c2 && !dashTiempo) dashTiempo = echarts.init(c2);
    if(c3 && !dashIndic) dashIndic = echarts.init(c3);
    return true;
  }

  function dashResize(){
    try{ dashCajas && dashCajas.resize(); }catch(_e){}
    try{ dashTiempo && dashTiempo.resize(); }catch(_e){}
    try{ dashIndic && dashIndic.resize(); }catch(_e){}
  }

  window.addEventListener('resize', ()=>{
    try{
      if(el('dashboardView') && !el('dashboardView').classList.contains('hidden')) dashResize();
    }catch(_e){}
  });

  function normIndic(v){
    const s = String(v ?? '').trim();
    return s ? s : 'SIN INDICACIÓN';
  }

  function isConcluido(r){
    return r && r.status === 'DESCARGA_CONCL';
  }

  function isBloqueo(r){
    const st = String(r?.status ?? '');
    const ind = String(r?.indicacion ?? '');
    return /BLOQ|HOLD|FUMIG/i.test(st) || /BLOQ|HOLD|FUMIG/i.test(ind);
  }

  function parseISOms(s){
    const t = Date.parse(s);
    return Number.isFinite(t) ? t : NaN;
  }

  function round2(n){
    return Math.round((n + Number.EPSILON) * 100) / 100;
  }

  function renderDashboard(){
    const view = el('dashboardView');
    if(!view) return;

    const range = getWorkRange();
    const dateTxt = (range.start===range.end) ? range.start : `${range.start} a ${range.end}`;

    const cTxt = (cedisFilter && cedisFilter.size) ? `CEDIS: ${cedisFilter.size} seleccionados` : 'CEDIS: Todos';
    const sTxt = (statusFilter && statusFilter.size) ? `Estatus: ${statusFilter.size} seleccionados` : 'Estatus: Todos';

    if(el('dashMetaCedis')) el('dashMetaCedis').textContent = cTxt;
    if(el('dashMetaEstatus')) el('dashMetaEstatus').textContent = sTxt;
    if(el('dashMetaFecha')) el('dashMetaFecha').textContent = 'Fecha: ' + dateTxt;

    const rows = getFilteredRows();

    // KPI's
    const recibidos = rows.length;
    const concluidos = rows.filter(isConcluido).length; // definición A (DESCARGA_CONCL)
    const pendientes = Math.max(0, recibidos - concluidos);
    const bloqueos = rows.filter(isBloqueo).length;

    const kpiEl = el('dashKpisGrid');
    if(kpiEl){
      kpiEl.innerHTML = [
        ['Recibidos', recibidos],
        ['Concluidos', concluidos],
        ['Pendientes', pendientes],
        ['Bloqueos / Hold-Fumig', bloqueos],
      ].map(([label,val]) => `
        <div class="dashKpiTile">
          <div class="dashKpiNum">${esc(String(val))}</div>
          <div class="dashKpiLabel">${esc(String(label))}</div>
        </div>
      `).join('');
    }

    if(!dashEnsureCharts()) return;

    // ---------------- Cuadrante 2: Cajas descargadas vs pendientes (barra apilada) ----------------
    try{
      let cajasConcl = 0;
      let cajasPend = 0;
      for(const r of rows){
        const c = toInt(r.cajas);
        if(isConcluido(r)) cajasConcl += c;
        else cajasPend += c;
      }

      dashCajas.setOption({
        tooltip:{trigger:'axis', axisPointer:{type:'shadow'}},
        legend:{top:0, textStyle:{color:'#9fb0c3'}},
        grid:{left:55,right:20,top:40,bottom:30},
        xAxis:{
          type:'category',
          data:['Cajas'],
          axisLabel:{color:'#9fb0c3'},
          axisLine:{lineStyle:{color:'#223044'}}
        },
        yAxis:{
          type:'value',
          axisLabel:{color:'#9fb0c3'},
          splitLine:{lineStyle:{color:'rgba(34,48,68,0.45)'}},
          axisLine:{lineStyle:{color:'#223044'}}
        },
        series:[
          {name:'Concluidas', type:'bar', stack:'total', data:[cajasConcl], barMaxWidth:60},
          {name:'Pendientes', type:'bar', stack:'total', data:[cajasPend], barMaxWidth:60},
        ]
      }, true);
    }catch(e){ console.warn(e); }

    // ---------------- Cuadrante 3: Tiempo por contenedor (Arribo → Fin; en proceso usa "ahora") ----------------
    try{
      const nowMs = Date.now();
      const xCats = [];
      const serieConcl = [];
      const serieProc = [];
      const info = [];

      rows.forEach((r, idx) => {
        const no = String(idx + 1);
        xCats.push(no);

        const a = parseISOms(r.arribo_at);
        const f = parseISOms(r.fin_at);

        if(!Number.isFinite(a)){
          serieConcl.push(null);
          serieProc.push(null);
          info.push({no, cont:r.contenedor, arr:null, fin:null, ms:null});
          return;
        }

        if(Number.isFinite(f)){
          const ms = Math.max(0, f - a);
          serieConcl.push(round2(ms/3600000));
          serieProc.push(null);
          info.push({no, cont:r.contenedor, arr:r.arribo_at, fin:r.fin_at, ms});
        } else {
          const ms = Math.max(0, nowMs - a);
          serieConcl.push(null);
          serieProc.push(round2(ms/3600000));
          info.push({no, cont:r.contenedor, arr:r.arribo_at, fin:null, ms});
        }
      });

      const zoomEnd = (rows.length>18) ? Math.min(100, Math.round(18/rows.length*100)) : 100;

      dashTiempo.setOption({
        tooltip:{
          trigger:'axis',
          axisPointer:{type:'shadow'},
          formatter:(params)=>{
            if(!params || !params.length) return '';
            const i = params[0].dataIndex;
            const it = info[i] || {};
            const hh = (it.ms==null) ? '—' : round2(it.ms/3600000);
            const finTxt = it.fin ? it.fin : (it.arr ? 'EN PROCESO' : '—');
            return `
              <div style="font-weight:900;margin-bottom:4px">NO ${esc(String(it.no ?? ''))} — ${esc(String(it.cont ?? ''))}</div>
              <div><span style="color:#9fb0c3">Arribo:</span> ${esc(String(it.arr ?? '—'))}</div>
              <div><span style="color:#9fb0c3">Fin:</span> ${esc(String(finTxt))}</div>
              <div><span style="color:#9fb0c3">Tiempo (h):</span> <b>${esc(String(hh))}</b></div>
            `;
          }
        },
        legend:{top:0, textStyle:{color:'#9fb0c3'}},
        grid:{left:60,right:20,top:40,bottom:45},
        xAxis:{
          type:'category',
          data:xCats,
          axisLabel:{color:'#9fb0c3'},
          axisLine:{lineStyle:{color:'#223044'}},
          name:'NO',
          nameTextStyle:{color:'#9fb0c3', padding:[20,0,0,0]}
        },
        yAxis:{
          type:'value',
          name:'Horas',
          nameTextStyle:{color:'#9fb0c3'},
          axisLabel:{color:'#9fb0c3'},
          splitLine:{lineStyle:{color:'rgba(34,48,68,0.45)'}},
          axisLine:{lineStyle:{color:'#223044'}}
        },
        dataZoom: (rows.length>18) ? [
          {type:'inside', start:0, end:zoomEnd},
          {type:'slider', height:18, bottom:18, start:0, end:zoomEnd}
        ] : [],
        series:[
          {name:'Concluido', type:'bar', data:serieConcl, barMaxWidth:18, emphasis:{focus:'series'}},
          {name:'En proceso', type:'bar', data:serieProc, barMaxWidth:18, emphasis:{focus:'series'}},
        ]
      }, true);
    }catch(e){ console.warn(e); }

    // ---------------- Cuadrante 4: Indicación (conteo de contenedores) ----------------
    try{
      const map = new Map();
      for(const r of rows){
        const key = normIndic(r.indicacion);
        map.set(key, (map.get(key)||0) + 1);
      }

      const items = Array.from(map.entries()).sort((a,b)=>b[1]-a[1]);
      const labels = items.map(x=>x[0]);
      const vals = items.map(x=>x[1]);

      const zoomEnd = (labels.length>10) ? Math.min(100, Math.round(10/labels.length*100)) : 100;

      dashIndic.setOption({
        tooltip:{trigger:'axis', axisPointer:{type:'shadow'}},
        grid:{left:150,right:20,top:20,bottom:30},
        xAxis:{
          type:'value',
          axisLabel:{color:'#9fb0c3'},
          splitLine:{lineStyle:{color:'rgba(34,48,68,0.45)'}},
          axisLine:{lineStyle:{color:'#223044'}}
        },
        yAxis:{
          type:'category',
          data:labels,
          axisLabel:{color:'#9fb0c3'},
          axisLine:{lineStyle:{color:'#223044'}}
        },
        dataZoom: (labels.length>10) ? [
          {type:'inside', yAxisIndex:0, start:0, end:zoomEnd},
          {type:'slider', yAxisIndex:0, width:12, right:6, start:0, end:zoomEnd}
        ] : [],
        series:[{type:'bar', data:vals, barMaxWidth:18, emphasis:{focus:'series'}}]
      }, true);
    }catch(e){ console.warn(e); }

    setTimeout(dashResize, 0);
  }
  // ------------------------------------------------

  // ------------------- Exportar a Excel (tabla visible en TABLERO) -------------------
  async function exportBoardToExcel(){
    const table = el('table');
    if(!table){
      alert('No hay tabla para exportar.');
      return;
    }

    // Solo columnas visibles
    const ths = Array.from(table.querySelectorAll('thead th')).filter(th=>!th.classList.contains('hidden-col'));
    const keys = ths.map(th=>th.getAttribute('data-key') || '');
    const headers = ths.map(th=>th.innerText.trim());

    const rows = Array.from(table.querySelectorAll('tbody tr'));
    const data = rows.map(tr=>{
      const tds = Array.from(tr.querySelectorAll('td')).filter(td=>!td.classList.contains('hidden-col'));
      return tds.map(td=>td.innerText.trim());
    });

    if(!headers.length){
      alert('No hay columnas visibles para exportar.');
      return;
    }

    const escXml = (s)=>String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

    const html = `<!doctype html>
<html><head><meta charset="utf-8"></head><body>
<table border="1">
  <thead><tr>${headers.map(h=>`<th>${escXml(h)}</th>`).join('')}</tr></thead>
  <tbody>
    ${data.map(r=>`<tr>${r.map(c=>`<td>${escXml(c)}</td>`).join('')}</tr>`).join('')}
  </tbody>
</table>
</body></html>`;

    const blob = new Blob([html], {type:'application/vnd.ms-excel;charset=utf-8'});
    const wr = getWorkRange();
    const dPart = (wr.start===wr.end) ? wr.start : `${wr.start}_a_${wr.end}`;
    const stamp = nowLocalIso().replace(/[:T]/g,'-').slice(0,19);
    const filename = `Arribos_Cedis_${dPart}_${stamp}.xls`.replaceAll('/','-');

    try{
      if(window.showSaveFilePicker){
        const handle = await window.showSaveFilePicker({
          suggestedName: filename,
          types: [{ description: 'Excel', accept: { 'application/vnd.ms-excel': ['.xls'] } }],
        });
        const writable = await handle.createWritable();
        await writable.write(blob);
        await writable.close();
      }else{
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(()=>URL.revokeObjectURL(url), 2000);
      }
    }catch(err){
      // cancelado por el usuario o no soportado
      if(err && (err.name === 'AbortError')) return;
      console.error(err);
      alert('No se pudo exportar el archivo.');
    }
  }


  function renderScreen(){
    const rows = getFilteredRows();
    const total = rows.length;
    const pageSize = 9;

    const wr = getWorkRange();
    const dateStr = ((wr.start===wr.end) ? wr.start : `${wr.start} - ${wr.end}`).replaceAll('-', '/');
    const cedisTxt = (cedisFilter.size===0) ? 'CEDIS: Todos' : `CEDIS: ${cedisFilter.size} seleccionados`;
    const estTxt = (statusFilter.size===0) ? 'Estatus: Todos' : `Estatus: ${statusFilter.size} seleccionados`;
    const smc = el('screenMetaCedis'); if(smc) smc.textContent = cedisTxt;
    const sme = el('screenMetaEstatus'); if(sme) sme.textContent = estTxt;
    const smf = el('screenMetaFecha'); if(smf) smf.textContent = dateStr ? `Fecha: ${dateStr}` : '';

    if(total===0){
      el('tbodyScreen').innerHTML = '';
      el('screenInfo').textContent = 'Sin registros con los filtros actuales';
      applyColsToScreen();
      return;
    }

    // wrap offset
    if(screenOffset >= total) screenOffset = 0;
    const end = Math.min(total, screenOffset + pageSize);
    const slice = rows.slice(screenOffset, end);

    el('screenInfo').textContent = `Mostrando ${screenOffset+1}-${end} de ${total}`;

    el('tbodyScreen').innerHTML = slice.map((r, idx)=>`
      <tr data-id="${r.id}">
        <td data-key="folio" class="mono">${screenOffset + idx + 1}</td>
        <td data-key="contenedor" class="mono"><div class="clamp2">${esc(r.contenedor)}</div></td>
        <td data-key="cuenta">${esc(r.cuenta)}</td>
        <td data-key="cedis">${esc(r.cedis)}</td>
        <td data-key="status">${statusPill(r.status)}</td>
        <td data-key="fecha" class="mono">${fmtYMD(r.arribo_ymd)}</td>
        <td data-key="indicacion">${indicacionHTML(r.indicacion)}</td>
        <td data-key="anden" class="mono">${esc(r.anden||'')}</td>
        <td data-key="arribo_at" class="mono">${fmtHM(r.arribo_at)}</td>
        <td data-key="asignacion_at" class="mono">${fmtHM(r.asignacion_at)}</td>
        <td data-key="responsable">${esc(r.responsable||'')}</td>
        <td data-key="inicio_at" class="mono">${fmtHM(r.inicio_at)}</td>
        <td data-key="fin_at" class="mono">${fmtHM(r.fin_at)}</td>
        <td data-key="descarga_concl_fecha" class="mono">${fmtYMD(r.descarga_concl_ymd||"")}</td>
        <td data-key="liberado_fecha" class="mono">${fmtYMD(r.liberado_ymd||"")}</td>
        <td data-key="cajas" class="mono">${esc(r.cajas||'')}</td>
        <td data-key="tarimas" class="mono">${esc(r.tarimas||'')}</td>
        <td data-key="pallets" class="mono">${esc(r.pallets||'')}</td>
      </tr>
    `).join('');

    applyColsToScreen();
  }

  function startScreen(){
    stopScreen();
    screenOffset = 0;
    renderScreen();
    screenTimer = setInterval(()=>{
      const total = getFilteredRows().length;
      if(total<=9){ renderScreen(); return; }
      screenOffset += 9;
      if(screenOffset >= total) screenOffset = 0;
      renderScreen();
    }, 10000);
  }

  function stopScreen(){
    if(screenTimer){ clearInterval(screenTimer); screenTimer=null; }
  }

  function applyColsToScreen(){
    const selected = new Set(loadCols());
    document.querySelectorAll('#tableScreen thead th[data-key]').forEach(th=>{
      const key = th.dataset.key;
      th.classList.toggle('hidden-col', !selected.has(key));
    });
    document.querySelectorAll('#tbodyScreen td[data-key]').forEach(td=>{
      const key = td.dataset.key;
      td.classList.toggle('hidden-col', !selected.has(key));
    });
  }
  // -----------------------------------------------------------


  // ------------------- ASISTENCIA (ADMIN) -------------------
  const LS_ATT_ROSTER = 'fids_att_roster_v1';
  const LS_ATT_DAY_PREFIX = 'fids_att_day_v1';

  function _attSafeParse(s, def){
    try{ return JSON.parse(s); }catch(_e){ return def; }
  }
  function _attKey(cedis, date){ return `${LS_ATT_DAY_PREFIX}:${cedis}:${date}`; }

  function _attTodayYMD(){ return ymd(); } // usa fecha local
  function _attDispDate(ymdStr){ return String(ymdStr||''); }
  function _attNowHHMM(){
    const d = new Date();
    const hh = String(d.getHours()).padStart(2,'0');
    const mm = String(d.getMinutes()).padStart(2,'0');
    return `${hh}:${mm}`;
  }
  function _attHHMMFromTS(ts){
    try{
      const d = new Date(ts);
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      return `${hh}:${mm}`;
    }catch(_e){ return ''; }
  }
  function _attLocalDateTimeISO(dateYMD, hhmm){
    // dateYMD: YYYY-MM-DD, hhmm: HH:MM (local)
    try{
      const [y,m,d] = dateYMD.split('-').map(n=>parseInt(n,10));
      const [hh,mm] = hhmm.split(':').map(n=>parseInt(n,10));
      const dt = new Date(y, (m||1)-1, d||1, hh||0, mm||0, 0, 0);
      return dt.toISOString();
    }catch(_e){ return nowLocalIso ? nowLocalIso() : (new Date()).toISOString(); }
  }

  function _attLoadRosterMap(){
    let map = _attSafeParse(localStorage.getItem(LS_ATT_ROSTER) || "{}", {});
    const has = map && Object.keys(map).length;
    if(!has){
      // compat: versiones anteriores (no romper históricos en el mismo navegador)
      const legacyKeys = ['fids_att_roster','att_roster_v1','attendance_roster_v1','roster_map_v1'];
      for(const k of legacyKeys){
        const m2 = _attSafeParse(localStorage.getItem(k) || "{}", {});
        if(m2 && Object.keys(m2).length){
          map = m2;
          // migra a la llave actual
          localStorage.setItem(LS_ATT_ROSTER, JSON.stringify(map));
          break;
        }
      }
    }
    return map || {};
  }
  function _attSaveRosterMap(map){
    localStorage.setItem(LS_ATT_ROSTER, JSON.stringify(map||{}));
  }
  function _attGetRosterLocal(cedis){
    const map = _attLoadRosterMap();
    const arr = Array.isArray(map[cedis]) ? map[cedis] : [];
    return arr.map(x=>String(x).trim()).filter(Boolean);
  }
  function _attSetRosterLocal(cedis, names){
    const map = _attLoadRosterMap();
    map[cedis] = names;
    _attSaveRosterMap(map);
  }


      async function _attGetRoster(cedis){
        const local = _attGetRosterLocal(cedis);
        try{
          const sb = await _attGetSupabaseSilent();
          if(!sb) return local;
          const r = await sb.from('attendance_roster')
            .select('person')
            .eq('cedis', cedis)
            .eq('active', true)
            .order('person', {ascending:true});
          if(r.error){
            if(!_attSchemaMissing(r.error)) console.warn(r.error);
            return local;
          }
          const arr = (r.data||[]).map(x=>String(x.person||'').trim()).filter(Boolean);
          if(arr.length){
            _attSetRosterLocal(cedis, arr);
            return arr;
          }
          return local;
        }catch(e){
          if(!_attSchemaMissing(e)) console.warn(e);
          return local;
        }
      }

      async function _attSaveRosterCloud(cedis, names){
        try{
          const sb = await _attGetSupabaseSilent();
          if(!sb) return false;
          if(!(authUser && authUser.email)){
            toast('Para guardar plantilla en nube, inicia sesión (modo Admin).');
            return false;
          }
          const nowIso = nowLocalIso ? nowLocalIso() : (new Date()).toISOString();

          const cur = await sb.from('attendance_roster')
            .select('person,active')
            .eq('cedis', cedis);

          if(cur.error){
            if(!_attSchemaMissing(cur.error)) toast(`No se pudo leer plantilla en nube: ${cur.error.message||cur.error}`);
            return false;
          }

          const existing = new Map((cur.data||[]).map(r=>[String(r.person||'').trim(), !!r.active]));
          const setNew = new Set(names.map(n=>String(n).trim()).filter(Boolean));
          const toDeactivate = [];
          for(const [p, active] of existing.entries()){
            if(active && !setNew.has(p)) toDeactivate.push(p);
          }

          const up = names.map(p=>({cedis, person:p, active:true, updated_at: nowIso, updated_by: authUser.email}));
          const u = await sb.from('attendance_roster').upsert(up, {onConflict:'cedis,person'});
          if(u.error){
            if(!_attSchemaMissing(u.error)) toast(`No se pudo guardar plantilla en nube: ${u.error.message||u.error}`);
            return false;
          }

          if(toDeactivate.length){
            const d = await sb.from('attendance_roster')
              .update({active:false, updated_at: nowIso, updated_by: authUser.email})
              .eq('cedis', cedis)
              .in('person', toDeactivate);
            if(d.error && !_attSchemaMissing(d.error)) console.warn(d.error);
          }

          const added = names.filter(p=>!existing.has(p));
          const removed = toDeactivate;
          for(const p of added) _attPersistEventCloud('roster_add', p, '', 'activo');
          for(const p of removed) _attPersistEventCloud('roster_remove', p, 'activo', 'inactivo');

          return true;
        }catch(e){
          if(!_attSchemaMissing(e)) console.warn(e);
          return false;
        }
      }

  function _attLoadLocalDay(cedis, date){
    let raw = localStorage.getItem(_attKey(cedis,date));
    if(!raw){
      // compat: intenta prefijos anteriores de la misma máquina/navegador
      const legacyPrefixes = ['fids_att_day','att_day_v1','attendance_day_v1','fids_att_day_v0'];
      for(const p of legacyPrefixes){
        const k = `${p}:${cedis}:${date}`;
        raw = localStorage.getItem(k);
        if(raw){
          // migra a la llave actual
          localStorage.setItem(_attKey(cedis,date), raw);
          break;
        }
      }
    }
    const def = {people:{}, maneuvers:{rodriguez:'', hernandez:'', zuniga:''}, events:[]};
    const obj = _attSafeParse(raw||"", def) || def;
    if(!obj.people) obj.people = {};
    if(!obj.maneuvers) obj.maneuvers = {rodriguez:'', hernandez:''};
    if(!Array.isArray(obj.events)) obj.events = [];
    return obj;
  }
  function _attSaveLocalDay(cedis, date, obj){
    localStorage.setItem(_attKey(cedis,date), JSON.stringify(obj||{}));
  }

  function _attEscape(s){
    return String(s||'').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));
  }
  function _attSchemaMissing(err){
    const msg = (err && (err.message || err.error_description || err.toString())) || "";
    return /schema cache|does not exist|relation .* does not exist|Could not find/i.test(msg);
  }

  async function _attGetSupabaseSilent(){
    try{
      if(typeof loadCfg !== 'function') return null;
      const cfg = loadCfg();
      if(!cfg || !cfg.url || !cfg.anon) return null;
      if(!window.supabase || typeof ensureSupabase !== 'function') return null;
      return await ensureSupabase();
    }catch(_e){
      return null;
    }
  }

  async function _attLoadCloudDay(sb, cedis, date){
    const out = {people:{}, maneuvers:{rodriguez:'', hernandez:'', zuniga:''}, events:[]};

    // entries
    const r1 = await sb.from('attendance_entries').select('person,present,arrival_at').eq('cedis', cedis).eq('work_date', date);
    if(r1.error) throw r1.error;
    (r1.data||[]).forEach(row=>{
      out.people[row.person] = {
        present: !!row.present,
        arrival: row.arrival_at ? _attHHMMFromTS(row.arrival_at) : ''
      };
    });

    // maneuvers (opcional)
    try{
      const r2 = await sb.from('attendance_maneuvers').select('manobra_rodriguez,manobra_hernandez,manobra_zuniga').eq('cedis', cedis).eq('work_date', date).maybeSingle();
      if(!r2.error && r2.data){
        out.maneuvers.rodriguez = (r2.data.manobra_rodriguez ?? '').toString();
        out.maneuvers.hernandez = (r2.data.manobra_hernandez ?? '').toString();
        out.maneuvers.zuniga = (r2.data.manobra_zuniga ?? '').toString();
      }
    }catch(_e){}

    // bitácora (opcional)
    try{
      const r3 = await sb.from('attendance_events')
        .select('event_at,field,person,old_value,new_value,event_by')
        .eq('cedis', cedis).eq('work_date', date)
        .order('event_at',{ascending:false}).limit(30);
      if(!r3.error){
        out.events = (r3.data||[]).map(ev=>{
          const who = ev.person ? `${ev.person}: ` : '';
          const by = ev.event_by ? ` (${ev.event_by})` : '';
          const msg = `${who}${ev.field}: ${(ev.old_value??'')} → ${(ev.new_value??'')}${by}`;
          return {t: ev.event_at, msg};
        });
      }
    }catch(_e){}

    return out;
  }

  let _attUIReady = false;
  let _attRosterForceOpen = false;
  let _attCurrent = {cedis:null, date:null, roster:[], day:null};

  function _attRenderAudit(events){
    const host = el('att_audit');
    if(!host) return;
    if(!events || !events.length){
      host.innerHTML = `<div class="muted" style="font-size:12px">Sin movimientos registrados.</div>`;
      return;
    }
    host.innerHTML = events.slice(0,30).map(ev=>{
      const when = ev.t ? _attEscape(_attHHMMFromTS(ev.t)) : '';
      const d = ev.t ? _attEscape(String(ev.t).split('T')[0]||'') : '';
      return `<div class="att-audit-item"><div class="when">${d} ${when}</div><div class="msg">${_attEscape(ev.msg)}</div></div>`;
    }).join('');
  }

  function _attUpdateCount(){
    const pill = el('att_count');
    if(!pill) return;
    const day = _attCurrent.day || {people:{}};
    const n = Object.values(day.people||{}).filter(v=>v && v.present).length;
    pill.textContent = String(n);
  }

  function _attRenderTable(){
    const tbody = el('att_body');
    if(!tbody) return;

    const cedis = _attCurrent.cedis;
    const date = _attCurrent.date;
    const roster = _attCurrent.roster || [];
    const day = _attCurrent.day || {people:{}};

    tbody.innerHTML = '';

    if(!cedis || !date){
      tbody.innerHTML = `<tr><td colspan="3" class="muted" style="font-size:12px;padding:12px">Selecciona CEDIS y fecha.</td></tr>`;
      return;
    }

    // nombres = plantilla + cualquiera que ya tenga registro (local o nube)
    const set = new Set();
    for(const n of roster) if(n) set.add(String(n).trim());
    for(const n of Object.keys(day.people||{})) if(n) set.add(String(n).trim());

    const rosterClean = roster.map(n=>String(n||'').trim()).filter(Boolean);
    const extras = Array.from(set).filter(n=>!rosterClean.includes(n)).sort((a,b)=>a.localeCompare(b,'es'));
    const names = [...new Set([...rosterClean, ...extras])];

    if(!names.length){
      tbody.innerHTML = `<tr><td colspan="3" class="muted" style="font-size:12px;padding:12px">Sin registros de asistencia para este día. (Puedes cargar plantilla con “Editar plantilla”.)</td></tr>`;
      return;
    }

    names.forEach(name=>{
      const st = (day.people && day.people[name]) ? day.people[name] : {present:false, arrival:''};

      const tr = document.createElement('tr');

      const td0 = document.createElement('td');
      const wrap = document.createElement('div');
      wrap.className = 'att-present';

      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.checked = !!st.present;
      cb.addEventListener('change', ()=>{
        lab.textContent = cb.checked ? 'Sí' : '';
        inp.disabled = !cb.checked;
        if(cb.checked && !inp.value) inp.value = _attNowHHMM();
        _attTogglePerson(name, cb.checked, inp.value);
      });

      const lab = document.createElement('span');
      lab.className = 'muted';
      lab.style.fontSize = '12px';
      lab.textContent = cb.checked ? 'Sí' : '';

      wrap.appendChild(cb);
      wrap.appendChild(lab);
      td0.appendChild(wrap);

      const td1 = document.createElement('td');
      td1.innerHTML = `<div class="att-name">${_attEscape(name)}</div>`;

      const td2 = document.createElement('td');
      td2.className = 'att-time';

      const inp = document.createElement('input');
      inp.className = 'input';
      inp.type = 'time';
      inp.step = 60;
      inp.value = st.arrival || '';
      inp.style.width = '130px';
      inp.disabled = !cb.checked;
      let _tmr = null;
      const _deb = ()=>{ clearTimeout(_tmr); _tmr = setTimeout(()=>_attSetArrival(name, inp.value), 350); };
      inp.addEventListener('input', _deb);
      inp.addEventListener('blur', ()=>_attSetArrival(name, inp.value));
      inp.addEventListener('change', ()=>_attSetArrival(name, inp.value));

      td2.appendChild(inp);

      tr.appendChild(td0);
      tr.appendChild(td1);
      tr.appendChild(td2);

      tbody.appendChild(tr);
    });
  }


  // ---- ASISTENCIA: Guardado completo (Plantilla) ----
  // Guarda TODA la plantilla (presente + hora) leyendo el estado actual de la tabla de asistencia.
  async function _attPersistPeopleFromUI(){
    const cedis = _attCurrent.cedis;
    const date = _attCurrent.date;
    if(!cedis || !date) return;

    const tbody = el('att_body');
    if(!tbody) return;

    const day = _attLoadLocalDay(cedis, date);
    const prevPeople = {...(day.people||{})};

    const payloads = [];
    const rows = Array.from(tbody.querySelectorAll('tr'));

    for(const tr of rows){
      const nameEl = tr.querySelector('.att-name');
      const cb = tr.querySelector('input[type="checkbox"]');
      const ti = tr.querySelector('input[type="time"]');

      const name = nameEl ? String(nameEl.textContent||'').trim() : '';
      if(!name) continue;

      const present = !!(cb && cb.checked);
      const arrival = (present && ti && ti.value) ? String(ti.value).trim() : '';

      const prev = prevPeople[name] || {present:false, arrival:''};

      if(!!prev.present !== !!present){
        _attPushLocalEvent(day, `${name}: presente ${prev.present?'Sí':'No'} → ${present?'Sí':'No'}`);
        _attPersistEventCloud('present', name, prev.present?'Sí':'No', present?'Sí':'No');
      }
      if((prev.arrival||'') !== (arrival||'')){
        _attPushLocalEvent(day, `${name}: hora ${prev.arrival||'-'} → ${arrival||'-'}`);
        _attPersistEventCloud('arrival', name, prev.arrival||'', arrival||'');
      }

      day.people[name] = {present, arrival};

      const arrival_at = (present && arrival) ? _attLocalDateTimeISO(date, arrival) : null;
      payloads.push({
        cedis, work_date: date, person: name,
        present,
        arrival_at,
        updated_at: (nowLocalIso ? nowLocalIso() : (new Date()).toISOString()),
        updated_by: (authUser && authUser.email) ? authUser.email : null
      });
    }

    _attSaveLocalDay(cedis, date, day);
    _attCurrent.day = day;

    _attUpdateCount();
    _attRenderAudit(day.events||[]);

    // nube: upsert en lote
    try{
      const sb = await _attGetSupabaseSilent();
      if(sb && payloads.length){
        const r = await sb.from('attendance_entries').upsert(payloads, {onConflict:'cedis,work_date,person'});
        if(r.error){
          if(!_attSchemaMissing(r.error)) toast(`No se pudo guardar asistencia: ${r.error.message||r.error}`);
        }
      }
    }catch(_e){}

    try{ refreshStaffKPIsDebounced(); }catch(_e){}
  }

  async function _attTogglePerson(name, isPresent, hhmm){
    const cedis = _attCurrent.cedis;
    const date = _attCurrent.date;
    if(!cedis || !date) return;

    const day = _attLoadLocalDay(cedis, date);
    const prev = day.people[name] || {present:false, arrival:''};

    // Si activan y no mandan hora, asigna hora actual
    const nextArrival = (isPresent ? (hhmm || prev.arrival || _attNowHHMM()) : '');
    const next = {present: !!isPresent, arrival: nextArrival};

    await _attPersistPerson(name, prev, next);

    try{ refreshStaffKPIsDebounced(); }catch(_e){}
  }

  async function _attSetArrival(name, hhmm){
    const cedis = _attCurrent.cedis;
    const date = _attCurrent.date;
    if(!cedis || !date) return;

    const day = _attLoadLocalDay(cedis, date);
    const prev = day.people[name] || {present:false, arrival:''};

    // Solo si está presente
    if(!prev.present) return;

    const next = {present:true, arrival:(hhmm||'').toString().trim()};
    await _attPersistPerson(name, prev, next);

    try{ refreshStaffKPIsDebounced(); }catch(_e){}
  }



async function _attPersistEventCloud(field, person, oldValue, newValue){
    try{
      const sb = await _attGetSupabaseSilent();
      if(!sb) return;
      const payload = {
        cedis: _attCurrent.cedis,
        work_date: _attCurrent.date,
        person: person || null,
        field,
        old_value: (oldValue===undefined || oldValue===null) ? null : String(oldValue),
        new_value: (newValue===undefined || newValue===null) ? null : String(newValue),
        event_at: (nowLocalIso ? nowLocalIso() : (new Date()).toISOString()),
        event_by: (authUser && authUser.email) ? authUser.email : null
      };
      const r = await sb.from('attendance_events').insert(payload);
      if(r.error && !_attSchemaMissing(r.error)) console.warn(r.error);
    }catch(_e){}
  }

  async function _attPersistPerson(name, oldRec, nextRec){
    const cedis = _attCurrent.cedis;
    const date = _attCurrent.date;
    if(!cedis || !date) return;

    const day = _attLoadLocalDay(cedis, date);
    const prev = day.people[name] || {present:false, arrival:''};

    day.people[name] = {present: !!nextRec.present, arrival: nextRec.arrival || ''};

    // bitácora local + nube (si existe)
    if(!!prev.present !== !!nextRec.present){
      const msg = `${name}: presente ${prev.present?'Sí':'No'} → ${nextRec.present?'Sí':'No'}`;
      _attPushLocalEvent(day, msg);
      _attPersistEventCloud('present', name, prev.present?'Sí':'No', nextRec.present?'Sí':'No');
    }
    if((prev.arrival||'') !== (nextRec.arrival||'')){
      const msg = `${name}: hora ${prev.arrival||'-'} → ${nextRec.arrival||'-'}`;
      _attPushLocalEvent(day, msg);
      _attPersistEventCloud('arrival', name, prev.arrival||'', nextRec.arrival||'');
    }

    _attSaveLocalDay(cedis, date, day);
    _attCurrent.day = day;

    _attUpdateCount();
    _attRenderAudit(day.events||[]);

    // nube: upsert principal
    try{
      const sb = await _attGetSupabaseSilent();
      if(!sb) return;

      const arrival_at = (nextRec.present && nextRec.arrival) ? _attLocalDateTimeISO(date, nextRec.arrival) : null;
      const payload = {
        cedis, work_date: date, person: name,
        present: !!nextRec.present,
        arrival_at,
        updated_at: (nowLocalIso ? nowLocalIso() : (new Date()).toISOString()),
        updated_by: (authUser && authUser.email) ? authUser.email : null
      };

      const r = await sb.from('attendance_entries').upsert(payload, {onConflict:'cedis,work_date,person'});
      if(r.error){
        if(!_attSchemaMissing(r.error)) toast(`No se pudo guardar asistencia: ${r.error.message||r.error}`);
      }
    }catch(_e){}
    try{ refreshStaffKPIsDebounced(); }catch(_e){}
  }

  async function _attPersistManeuvers(){
    const cedis = _attCurrent.cedis;
    const date = _attCurrent.date;
    if(!cedis || !date) return;

    const ro = el('att_man_rodriguez');
    const he = el('att_man_hernandez');
    const zu = el('att_man_zuniga');
    if(!ro || !he || !zu) return;

    const vro = (ro.value||'').toString().trim();
    const vhe = (he.value||'').toString().trim();
    const vzu = (zu.value||'').toString().trim();

    const day = _attLoadLocalDay(cedis, date);
    const prev = {...(day.maneuvers||{rodriguez:'',hernandez:'',zuniga:''})};

    day.maneuvers = {rodriguez: vro, hernandez: vhe, zuniga: vzu};
    if((prev.rodriguez||'') !== (vro||'')){
      _attPushLocalEvent(day, `MANIOBRA RODRIGUEZ: ${prev.rodriguez||'0'} → ${vro||'0'}`);
      _attPersistEventCloud('manobra_rodriguez', null, prev.rodriguez||'0', vro||'0');
    }
    if((prev.hernandez||'') !== (vhe||'')){
      _attPushLocalEvent(day, `MANIOBRA HERNANDEZ: ${prev.hernandez||'0'} → ${vhe||'0'}`);
      _attPersistEventCloud('manobra_hernandez', null, prev.hernandez||'0', vhe||'0');
    }
    if((prev.zuniga||'') !== (vzu||'')){
      _attPushLocalEvent(day, `MANIOBRA ZUÑIGA: ${prev.zuniga||'0'} → ${vzu||'0'}`);
      _attPersistEventCloud('manobra_zuniga', null, prev.zuniga||'0', vzu||'0');
    }

    _attSaveLocalDay(cedis, date, day);
    _attCurrent.day = day;
    _attRenderAudit(day.events||[]);

    // nube
    try{
      const sb = await _attGetSupabaseSilent();
      if(!sb) return;

      const payload = {
        cedis, work_date: date,
        manobra_rodriguez: (vro===''? null : parseInt(vro,10)),
        manobra_hernandez: (vhe===''? null : parseInt(vhe,10)),
        manobra_zuniga: (vzu===''? null : parseInt(vzu,10)),
        updated_at: (nowLocalIso ? nowLocalIso() : (new Date()).toISOString()),
        updated_by: (authUser && authUser.email) ? authUser.email : null
      };
      const r = await sb.from('attendance_maneuvers').upsert(payload, {onConflict:'cedis,work_date'});
      if(r.error){
        if(!_attSchemaMissing(r.error)) toast(`No se pudo guardar maniobras: ${r.error.message||r.error}`);
      }
    }catch(_e){}
    try{ refreshStaffKPIsDebounced(); }catch(_e){}
  }

  async function _attReload(){
    if(!_attUIReady) return;

    const sel = el('att_cedis');
    if(!sel) return;

    const cedis = sel.value || (CEDIS_LIST && CEDIS_LIST[0]) || '';

    // lee rango desde UI (inicio/fin). Si no hay fin, usa inicio.
    const stEl = el('att_start') || el('att_date');
    const enEl = el('att_end');

    let start = (stEl && stEl.value) ? String(stEl.value).trim() : '';
    let end = (enEl && enEl.value) ? String(enEl.value).trim() : '';

    const normalize = (v)=>{
      if(!v) return '';
      v = String(v).trim();
      // compat: versiones que mostraban YYYY/MM/DD
      if(v.includes('/')) v = v.replaceAll('/','-');
      // si trae tiempo, recorta
      if(v.includes('T')) v = v.split('T')[0];
      return v;
    };
    start = normalize(start);
    end = normalize(end);

    if(!start) start = _attTodayYMD();
    if(!end) end = start;

    if(stEl) stEl.value = start;
    if(enEl) enEl.value = end;

    _attCurrent.cedis = cedis;
    _attCurrent.date = start;
    _attCurrent.range = {start, end};

    const showRangePanel = (on)=>{
      const p = el('att_range_panel');
      if(p) p.classList.toggle('hidden', !on);
      const tw = el('att_table_wrap');
      if(tw) tw.classList.toggle('hidden', on);
      const mg = el('att_maneuvers_grid');
      if(mg) mg.classList.toggle('hidden', on);
      const ad = el('att_audit_details');
      if(ad) ad.classList.toggle('hidden', on);
    };

    const setRangeLabel = ()=>{
      const lab = el('att_range_label');
      if(lab) lab.textContent = `${start.replaceAll('-','/')}  →  ${end.replaceAll('-','/')}`;
    };

    // roster (siempre)
    const roster = await _attGetRoster(cedis);
    _attCurrent.roster = roster;

    const editor = el('att_roster_editor');
    if(editor){
      const ta = el('att_roster_text');
      if(_attRosterForceOpen){
        editor.classList.remove('hidden');
        if(ta) ta.value = (roster||[]).join('\n');
      }else{
        if(roster.length){
          editor.classList.add('hidden');
          if(ta) ta.value = (roster||[]).join('\n');
        }else{
          editor.classList.remove('hidden');
          if(ta) ta.value = '';
        }
      }
    }

    // set toggle label
    const tb = el('att_roster_toggle');
    if(tb) tb.textContent = _attRosterForceOpen ? 'Ocultar plantilla' : 'Editar plantilla';

    // -------- RANGO (solo consulta) --------
    if(start !== end){
      showRangePanel(true);
      setRangeLabel();

      const tbody = el('att_range_body');
      if(tbody) tbody.innerHTML = '';

      const presentByDate = {};
      const maniByDate = {};

      // intenta nube (Supabase)
      try{
        const sb = await _attGetSupabaseSilent();
        if(sb){
          // presentes
          let q1 = sb.from('attendance_entries')
            .select('work_date')
            .eq('present', true)
            .eq('cedis', cedis)
            .gte('work_date', start)
            .lte('work_date', end);
          const r1 = await q1;
          if(!r1.error){
            for(const row of (r1.data||[])){
              const d = row.work_date;
              if(!d) continue;
              presentByDate[d] = (presentByDate[d]||0) + 1;
            }
          }else if(!_attSchemaMissing(r1.error)){
            console.warn(r1.error);
          }

          // maniobras (suma 3)
          let q2 = sb.from('attendance_maneuvers')
            .select('work_date,manobra_rodriguez,manobra_hernandez,manobra_zuniga')
            .eq('cedis', cedis)
            .gte('work_date', start)
            .lte('work_date', end);
          const r2 = await q2;
          if(!r2.error){
            for(const row of (r2.data||[])){
              const d = row.work_date;
              if(!d) continue;
              const a = parseInt(row.manobra_rodriguez||0,10) || 0;
              const b = parseInt(row.manobra_hernandez||0,10) || 0;
              const c = parseInt(row.manobra_zuniga||0,10) || 0;
              maniByDate[d] = (maniByDate[d]||0) + a + b + c;
            }
          }else if(!_attSchemaMissing(r2.error)){
            console.warn(r2.error);
          }
        }
      }catch(_e){}

      // fallback local (si no hubo nube)
      const hasCloudData = Object.keys(presentByDate).length || Object.keys(maniByDate).length;
      if(!hasCloudData){
        try{
          const sd = _ymdToDate(start);
          const ed = _ymdToDate(end);
          if(sd && ed){
            for(let d = new Date(sd.getFullYear(), sd.getMonth(), sd.getDate()); d <= ed; d.setDate(d.getDate()+1)){
              const y = _dateToYMD(d);
              const day = _attLoadLocalDay(cedis, y);
              const n = Object.values(day.people||{}).filter(v=>v && v.present).length;
              presentByDate[y] = n;
              const mv = day.maneuvers||{};
              const tot = (parseInt(mv.rodriguez||0,10)||0)+(parseInt(mv.hernandez||0,10)||0)+(parseInt(mv.zuniga||0,10)||0);
              maniByDate[y] = tot;
            }
          }
        }catch(_e){}
      }

      // render tabla rango
      if(tbody){
        const sd = _ymdToDate(start);
        const ed = _ymdToDate(end);
        const dates = [];
        if(sd && ed){
          for(let d = new Date(sd.getFullYear(), sd.getMonth(), sd.getDate()); d <= ed; d.setDate(d.getDate()+1)){
            dates.push(_dateToYMD(d));
          }
        }

        const totalPresentes = dates.reduce((acc, d)=>acc + (presentByDate[d]||0), 0);
        if(el('att_count')) el('att_count').textContent = String(totalPresentes);

        tbody.innerHTML = dates.map(d=>{
          const p = presentByDate[d]||0;
          const m = maniByDate[d]||0;
          return `<tr class="rowHover" data-date="${_attEscape(d)}" style="cursor:pointer">
            <td>${_attEscape(d.replaceAll('-','/'))}</td>
            <td style="font-weight:900">${p}</td>
            <td style="font-weight:900">${m}</td>
          </tr>`;
        }).join('');

        // click para abrir detalle del día
        Array.from(tbody.querySelectorAll('tr[data-date]')).forEach(tr=>{
          tr.addEventListener('click', ()=>{
            const d = tr.getAttribute('data-date');
            if(stEl) stEl.value = d;
            if(enEl) enEl.value = d;
            _attReload();
          });
        });
      }

      // en rango, no mostramos detalle del día
      _attCurrent.day = {people:{}, maneuvers:{rodriguez:'',hernandez:'',zuniga:''}, events:[]};
      _attRenderAudit([]);
      return;
    }

    // -------- DÍA (editable) --------
    showRangePanel(false);

    const date = start;

    // load local first
    let day = _attLoadLocalDay(cedis, date);

    // try cloud merge (si existe tabla)
    try{
      const sb = await _attGetSupabaseSilent();
      if(sb){
        const cloud = await _attLoadCloudDay(sb, cedis, date);
        // merge (cloud gana si trae datos)
        const cloudHas = Object.keys(cloud.people||{}).length > 0 || (cloud.maneuvers && (cloud.maneuvers.rodriguez || cloud.maneuvers.hernandez || cloud.maneuvers.zuniga)) || (cloud.events && cloud.events.length);
        if(cloudHas){
          day.people = {...(day.people||{}), ...(cloud.people||{})};
          day.maneuvers = {...(day.maneuvers||{}), ...(cloud.maneuvers||{})};
          if(cloud.events && cloud.events.length){
            day.events = cloud.events;
          }
          _attSaveLocalDay(cedis, date, day);
        }
      }
    }catch(e){
      if(!_attSchemaMissing(e)) console.warn(e);
    }

    _attCurrent.day = day;

    // prefill maneuvers
    if(el('att_man_rodriguez')) el('att_man_rodriguez').value = (day.maneuvers && day.maneuvers.rodriguez) ? day.maneuvers.rodriguez : '';
    if(el('att_man_hernandez')) el('att_man_hernandez').value = (day.maneuvers && day.maneuvers.hernandez) ? day.maneuvers.hernandez : '';
    if(el('att_man_zuniga')) el('att_man_zuniga').value = (day.maneuvers && day.maneuvers.zuniga) ? day.maneuvers.zuniga : '';

    _attUpdateCount();
    _attRenderAudit(day.events||[]);
    _attRenderTable();
  }

function initAttendanceUI(){
    try{
      const card = el('attendanceCard');
      if(!card) return;

      const date = _attTodayYMD();
      // Inicializa rango (inicio/fin)
      if(el('att_start')) el('att_start').value = date;
      if(el('att_end')) el('att_end').value = date;
      // compat (si existiera un campo viejo)
      if(el('att_date')) el('att_date').value = _attDispDate(date);

      const st = el('att_start');
      const en = el('att_end');
      if(st) st.addEventListener('change', _attReload);
      if(en) en.addEventListener('change', _attReload);

      const hoyBtn = el('att_today');
      if(hoyBtn){
        hoyBtn.addEventListener('click', ()=>{
          const t = _attTodayYMD();
          if(st) st.value = t;
          if(en) en.value = t;
          _attReload();
        });
      }

      const updBtn = el('att_update');
      if(updBtn){
        updBtn.addEventListener('click', async ()=>{
          // Fuerza guardado completo: plantilla + maniobra
          await _attPersistPeopleFromUI();
          try{ await _attPersistManeuvers(); }catch(_e){}
          toast('Asistencia actualizada.');
          try{ refreshStaffKPIsDebounced(); }catch(_e){}
        });
      }


      const sel = el('att_cedis');
      if(sel){
        sel.innerHTML = (CEDIS_LIST||[]).map(c=>`<option value="${_attEscape(c)}">${_attEscape(c)}</option>`).join('');
        // default: toma CEDIS actual de captura rápida si existe
        const aCedis = el('aCedis');
        sel.value = (aCedis && aCedis.value) ? aCedis.value : ((CEDIS_LIST && CEDIS_LIST[0]) || '');
        sel.addEventListener('change', _attReload);

        if(aCedis){
          aCedis.addEventListener('change', ()=>{
            if(sel.value !== aCedis.value){
              sel.value = aCedis.value;
              _attReload();
            }
          });
        }
      }

      const saveRosterBtn = el('att_roster_save');
      if(saveRosterBtn){
        saveRosterBtn.addEventListener('click', async ()=>{
          const sel = el('att_cedis');
          const cedis = sel ? sel.value : '';
          const ta = el('att_roster_text');
          const raw = ta ? ta.value : '';
          const names = raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
          if(!names.length){
            toast('Pega al menos un nombre para guardar la plantilla.');
            return;
          }
          _attSetRosterLocal(cedis, names);
          const okCloud = await _attSaveRosterCloud(cedis, names);
          toast(okCloud ? 'Plantilla guardada en nube.' : 'Plantilla guardada (nube no disponible).');
          _attReload();
        });
      }

      const ro = el('att_man_rodriguez');
      const he = el('att_man_hernandez');
      const zu = el('att_man_zuniga');

      // Guarda también en input + blur (con debounce) para evitar que se quede en cero si no salen del campo.
      let manTimer = null;
      const manDebounced = ()=>{
        clearTimeout(manTimer);
        manTimer = setTimeout(_attPersistManeuvers, 300);
      };

      if(ro){
        ro.addEventListener('change', _attPersistManeuvers);
        ro.addEventListener('input', manDebounced);
        ro.addEventListener('blur', _attPersistManeuvers);
      }
      if(he){
        he.addEventListener('change', _attPersistManeuvers);
        he.addEventListener('input', manDebounced);
        he.addEventListener('blur', _attPersistManeuvers);
      }
      if(zu){
        zu.addEventListener('change', _attPersistManeuvers);
        zu.addEventListener('input', manDebounced);
        zu.addEventListener('blur', _attPersistManeuvers);
      }

      const toggleRosterBtn = el('att_roster_toggle');
      if(toggleRosterBtn){
        toggleRosterBtn.addEventListener('click', ()=>{
          _attRosterForceOpen = !_attRosterForceOpen;
          const editor = el('att_roster_editor');
          const ta = el('att_roster_text');
          if(editor){
            if(_attRosterForceOpen){
              editor.classList.remove('hidden');
              if(ta) ta.value = (_attCurrent.roster||[]).join('\n');
              toggleRosterBtn.textContent = 'Ocultar plantilla';
            }else{
              editor.classList.add('hidden');
              toggleRosterBtn.textContent = 'Editar plantilla';
            }
          }
        });
      }

      _attUIReady = true;
      _attReload();
    }catch(e){
      console.warn('initAttendanceUI error', e);
    }
  }


  // Inicializa subvistas (Por llegar / Histórico)
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', initSubViews); } else { initSubViews(); }


  // Inicializa Asistencia (ADMIN)
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', initAttendanceUI); } else { initAttendanceUI(); }



  // =================== SVA DETALLE: maquilas múltiples + producción por hora ===================
  const SVA_HOUR_START = 8;  // 08:00
  const SVA_HOUR_END   = 20; // 20:00 (último periodo inicia 19:00)
  function _svaHours(startHour){
    const sRaw = Number.isFinite(startHour) ? startHour : SVA_HOUR_START;
    const s = Math.max(0, Math.min(23, Math.floor(sRaw)));
    const a=[];
    for(let h=s; h<SVA_HOUR_END; h++) a.push(h);
    return a;
  }

  function _svaKeyParts(key){
    const [contenedor_norm, arribo_ymd, proceso] = String(key||'').split('|');
    return { contenedor_norm, arribo_ymd, proceso };
  }

  function _svaTotalCajasFromShipment(sh){
    const candidates = [sh?.cajas, sh?.cajas_total, sh?.total_cajas, sh?.cajas_totales, sh?.cajasTotales];
    for(const v of candidates){
      const n = Number(v);
      if(Number.isFinite(n) && n>0) return n;
    }
    return 0;
  }

    // Alias: Productividad (modal)
  async function openSvaProductividad(key, focusMaq){
    return openSvaDetail(key, focusMaq);
  }

async function openSvaDetail(key, focusMaq){
    try{
      await ensureSupa();
      const r = _findSvaRow(key);
      if(!r){ toastErr('No se encontró el renglón SVA.'); return; }
      if(!supa){ toastErr('Nube no conectada.'); return; }

      const { contenedor_norm, arribo_ymd, proceso } = _svaKeyParts(key);
      const totalCajas = _svaTotalCajasFromShipment(r.sh);

      el('modalTitle').textContent = `SVA · PRODUCTIVIDAD · ${contenedor_norm} · ${proceso}`;
      const today = _todayYMD();
      const workYmd = (el('svaDetWorkDate')?.value) || today;
      const startTime = (r.inicio_proc ? _isoToHM(r.inicio_proc) : '08:00');
      const startHour = (()=>{ const h = Number(String(startTime||'').split(':')[0]); return Number.isFinite(h)?h:SVA_HOUR_START; })();

      // UI base
      el('modalBody').innerHTML = `
        <div class="row"><div class="k">Contenedor</div><div class="v">${esc(contenedor_norm||'')}</div></div>
        <div class="row"><div class="k">Proceso</div><div class="v">${esc(proceso||'')}</div></div>
        <div class="row"><div class="k">Arribo</div><div class="v">${esc(arribo_ymd||'')}</div></div>
        <div class="row"><div class="k">Total cajas</div><div class="v"><b id="svaDetTotalCajas">${totalCajas||0}</b></div></div>
        <div class="row"><div class="k">Avance general</div><div class="v"><b id="svaDetPct">—</b> <span class="muted" id="svaDetProdMeta" style="font-size:12px"></span></div></div>

        <div class="sep" style="margin:10px 0;border-top:1px solid rgba(255,255,255,.08)"></div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:end">
          <div style="min-width:220px">
            <div class="muted" style="font-size:12px;margin-bottom:6px">Día de producción</div>
            <input type="date" class="input" id="svaDetWorkDate" value="${esc(workYmd)}">
          </div>
          <div style="min-width:200px">
            <div class="muted" style="font-size:12px;margin-bottom:6px">Hora inicio (del proceso)</div>
            <input type="time" class="input" id="svaDetStartTime" value="${esc(startTime)}">
          </div>

          <div style="flex:1;min-width:260px">
            <div class="muted" style="font-size:12px;margin-bottom:6px">Agregar maquila</div>
            <div style="display:flex;gap:8px">
              <input class="input" id="svaDetNewMaq" placeholder="Ej. VALRANI">
              <input class="input" id="svaDetNewPers" type="number" min="0" step="1" placeholder="Personal" style="max-width:140px">
              <button class="btn secondary" id="svaDetAddMaq">Agregar</button>
            </div>
          
          <div style="flex:1;min-width:320px">
            <div class="muted" style="font-size:12px;margin-bottom:6px">Captura rápida (cualquier intervalo)</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <select class="input" id="svaDetQuickMaq" style="min-width:180px"></select>
              <input class="input" id="svaDetQuickTime" type="time" value="${esc(startTime)}" style="max-width:150px">
              <input class="input" id="svaDetQuickCajas" type="number" min="0" step="1" placeholder="Cajas" style="max-width:140px">
              <button class="btn secondary" id="svaDetQuickAdd">Agregar</button>
            </div>
            <div class="muted" style="font-size:12px;margin-top:6px">Tip: captura cuando quieras; se suma a la hora correspondiente.</div>
          </div>

</div>

          <div style="display:flex;gap:8px">
            <button class="btn" id="svaDetSave" ${authUser?'':'disabled'}>Guardar</button>
            <button class="btn secondary" id="svaDetReload">Recargar</button>
          </div>
        </div>

        ${authUser ? '' : '<div class="muted" style="margin-top:8px;font-size:12px">Inicia sesión en <b>ADMIN</b> para capturar y guardar producción.</div>'}

        <div class="sep" style="margin:12px 0;border-top:1px solid rgba(255,255,255,.08)"></div>

        <div id="svaDetMaqWrap"></div>

        <div class="sep" style="margin:12px 0;border-top:1px solid rgba(255,255,255,.08)"></div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between">
          <div>
            <div style="font-weight:900">Huella (últimos 20 movimientos)</div>
            <div class="muted" style="font-size:12px">Cada cambio guarda hora y usuario.</div>
          </div>
          <button class="btn secondary" id="svaDetLoadLog">Actualizar huella</button>
        </div>
        <div id="svaDetLog" style="margin-top:10px"></div>
      `;

      el('modalBackdrop').classList.remove('hidden');

      const state = { key, contenedor_norm, arribo_ymd, proceso, totalCajas, workYmd, startHour, startTime, focusMaq: (focusMaq ? String(focusMaq).trim().toUpperCase() : null), maquilas: [], prod: new Map() };

      // bind
      el('svaDetWorkDate').onchange = async ()=>{
        state.workYmd = el('svaDetWorkDate').value || _todayYMD();
        await _svaDetLoad(state);
      };
      el('svaDetStartTime').onchange = ()=>{
        state.startTime = el('svaDetStartTime').value || '08:00';
        const h = Number(String(state.startTime||'').split(':')[0]);
        state.startHour = Number.isFinite(h) ? h : SVA_HOUR_START;
        _svaDetRender(state);
        _svaDetRefreshAgg(state);
      };
      el('svaDetAddMaq').onclick = async ()=>{
        const m = (el('svaDetNewMaq').value||'').trim().toUpperCase();
        const p = (el('svaDetNewPers').value||'').trim();
        if(!m){ toastErr('Indica la maquila.'); return; }
        const pers = p===''? null : Number(p);
        state.maquilas = state.maquilas.filter(x=>x.maquila!==m);
        state.maquilas.push({ maquila: m, personal: (Number.isFinite(pers)?pers:null) });
        el('svaDetNewMaq').value=''; el('svaDetNewPers').value='';
        _svaDetRender(state);
        _svaDetQuickUpdate(state);
      
      // Captura rápida
      const _svaDetQuickFill = ()=>{
        const sel = el('svaDetQuickMaq');
        if(!sel) return;
        const prev = sel.value;
        sel.innerHTML = (state.maquilas||[]).map(x=>`<option value="${esc(x.maquila)}">${esc(x.maquila)}</option>`).join('') || '<option value="">(sin maquilas)</option>';
        if(prev && [...sel.options].some(o=>o.value===prev)) sel.value = prev;
      };

      el('svaDetQuickAdd')?.addEventListener('click', ()=>{
        try{
          const maq = (el('svaDetQuickMaq')?.value||'').trim().toUpperCase();
          if(!maq){ toastErr('Selecciona maquila.'); return; }
          const cajas = Number((el('svaDetQuickCajas')?.value||'').trim()||0);
          if(!Number.isFinite(cajas) || cajas<=0){ toastErr('Indica cajas (>0).'); return; }
          const t = (el('svaDetQuickTime')?.value||state.startTime||'08:00');
          let hour = Number(String(t).split(':')[0]);
          if(!Number.isFinite(hour)) hour = state.startHour;
          const hours = _svaHours(state.startHour);
          if(hour < hours[0]) hour = hours[0];
          if(hour > hours[hours.length-1]) hour = hours[hours.length-1];

          const k = `${maq}|${hour}`;
          const cur = Number(state.prod.get(k) || 0);
          state.prod.set(k, cur + cajas);

          // refleja en input de la tabla
          const inp = document.querySelector(`input.svaDetCajas[data-maq="${CSS.escape(maq)}"][data-hour="${hour}"]`);
          if(inp){ inp.value = String(cur + cajas); }

          el('svaDetQuickCajas').value = '';
          _svaDetRefreshAgg(state);
          toastOk(`+${cajas} cajas (${maq} @ ${String(hour).padStart(2,'0')}:00)`);
        }catch(e){ console.warn(e); }
      });
};
      el('svaDetSave').onclick = async ()=>{ await _svaDetSave(state); };
      el('svaDetReload').onclick = async ()=>{ await _svaDetLoad(state); };
      el('svaDetLoadLog').onclick = async ()=>{ await _svaDetLoadLog(state); };

      await _svaDetLoad(state);
      if(state.focusMaq) _svaDetFocusMaq(state.focusMaq);
      await _svaDetLoadLog(state);
    }catch(err){
      console.error(err);
      toastErr('Error al abrir detalle SVA.');
    }
  }

  async function _svaDetLoad(state){
    if(!supa) return;
    // cargar maquilas
    const mq = await supa.from('sva_reprocesos_maquilas')
      .select('maquila,personal')
      .eq('contenedor_norm', state.contenedor_norm)
      .eq('arribo_ymd', state.arribo_ymd)
      .eq('proceso', state.proceso);

    if(mq.error){ console.warn(mq.error); }
    state.maquilas = (mq.data||[]).map(x=>({maquila:(x.maquila||'').toUpperCase(), personal:x.personal==null?null:Number(x.personal)}));
    _svaDetQuickUpdate(state);

    // cargar producción por hora (por día seleccionado)
    state.prod = new Map();
    const pr = await supa.from('sva_prod_hora')
      .select('maquila,work_ymd,hour_start,cajas')
      .eq('contenedor_norm', state.contenedor_norm)
      .eq('arribo_ymd', state.arribo_ymd)
      .eq('proceso', state.proceso)
      .eq('work_ymd', state.workYmd);

    if(pr.error){ console.warn(pr.error); }
    for(const row of (pr.data||[])){
      const k = `${(row.maquila||'').toUpperCase()}|${row.hour_start}`;
      state.prod.set(k, Number(row.cajas||0));
    }

    _svaDetRender(state);
    _svaDetQuickUpdate(state);
    await _svaDetRefreshAgg(state);
  }

  
  function _svaDetQuickUpdate(state){
    try{
      const sel = el('svaDetQuickMaq');
      if(!sel) return;
      const prev = sel.value;
      const opts = (state.maquilas||[]).map(x=>{
        const v = String(x.maquila||'').toUpperCase();
        return `<option value="${esc(v)}">${esc(v)}</option>`;
      }).join('');
      sel.innerHTML = opts || '<option value="">(sin maquilas)</option>';
      if(prev && [...sel.options].some(o=>o.value===prev)) sel.value = prev;
    }catch(e){ console.warn(e); }
  }

function _svaDetRender(state){
    const wrap = el('svaDetMaqWrap');
    if(!wrap) return;

    if(!state.maquilas.length){
      wrap.innerHTML = `<div class="muted">Sin maquilas capturadas. Agrega una arriba.</div>`;
      return;
    }

    const hours = _svaHours(state.startHour);

    let html = '';
    for(const m of state.maquilas){
      const name = m.maquila;
      html += `
        <div class="card" data-sva-maq-card="${esc(name)}" style="padding:12px;margin-bottom:10px">
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between">
            <div style="font-weight:900">${esc(name)}</div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <div class="muted" style="font-size:12px">Personal</div>
              <input class="input svaDetPers" data-maq="${esc(name)}" type="number" min="0" step="1" value="${m.personal==null?'':esc(String(m.personal))}" style="max-width:120px">
              <button class="btn danger tiny svaDetDelMaq" data-maq="${esc(name)}">Quitar</button>
            </div>
          </div>

          <div style="margin-top:10px;overflow:auto">
            <table class="table" style="min-width:520px">
              <thead>
                <tr>
                  <th>PERIODO</th>
                  <th>CAJAS (por hora)</th>
                  <th>ACUMULADA</th>
                </tr>
              </thead>
              <tbody>
                ${hours.map(h=>{
                  const k = `${name}|${h}`;
                  const v = state.prod.get(k) ?? '';
                  const period = String(h).padStart(2,'0')+':00 - '+String(h+1).padStart(2,'0')+':00';
                  return `
                    <tr>
                      <td>${period}</td>
                      <td>
                        <input class="input svaDetCajas" data-maq="${esc(name)}" data-hour="${h}" type="number" min="0" step="1" value="${v===''?'':esc(String(v))}" style="max-width:160px">
                      </td>
                      <td class="muted" data-acc="${esc(name)}" data-hour="${h}">—</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>

          <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;margin-top:8px">
            <div class="muted" style="font-size:12px">Total maquila: <b data-total="${esc(name)}">0</b> cajas</div>
            <div class="muted" style="font-size:12px">Avance maquila (vs total contenedor): <b data-pct="${esc(name)}">0%</b></div>
          </div>
        </div>
      `;
    }

    wrap.innerHTML = html;

    // bind events
    wrap.querySelectorAll('.svaDetDelMaq').forEach(btn=>{
      btn.onclick = ()=>{
        const maq = btn.dataset.maq;
        state.maquilas = state.maquilas.filter(x=>x.maquila!==maq);
        // limpiar prod de esa maquila
        for(const k of [...state.prod.keys()]){
          if(k.startsWith(maq+'|')) state.prod.delete(k);
        }
        _svaDetRender(state);
        _svaDetQuickUpdate(state);
        _svaDetRefreshAgg(state);
      };
    });

    wrap.querySelectorAll('.svaDetPers').forEach(inp=>{
      inp.oninput = ()=>{
        const maq = inp.dataset.maq;
        const v = inp.value.trim();
        const pers = v===''? null : Number(v);
        const it = state.maquilas.find(x=>x.maquila===maq);
        if(it) it.personal = Number.isFinite(pers)?pers:null;
      };
    });

    wrap.querySelectorAll('.svaDetCajas').forEach(inp=>{
      inp.oninput = ()=>{
        const maq = inp.dataset.maq;
        const h = Number(inp.dataset.hour);
        const v = inp.value.trim();
        const n = v===''? 0 : Number(v);
        if(!Number.isFinite(n) || n<0) return;
        state.prod.set(`${maq}|${h}`, n);
        _svaDetRefreshAgg(state);
      };
    });

    _svaDetRefreshAgg(state);
  }

  function _svaDetFocusMaq(maq){
    try{
      const m = String(maq||'').trim().toUpperCase();
      if(!m) return;
      const card = document.querySelector(`[data-sva-maq-card="${CSS.escape(m)}"]`);
      if(card){
        card.classList.add('svaFocus');
        card.scrollIntoView({behavior:'smooth', block:'start'});
        setTimeout(()=>card.classList.remove('svaFocus'), 1400);
      }
    }catch(e){ console.warn(e); }
  }

  async function _svaDetRefreshAgg(state){
    // acumulados por maquila (día)
    const totalCajas = state.totalCajas || 0;
    const hours = _svaHours(state.startHour);
    let grand = 0;

    for(const m of state.maquilas){
      let acc = 0;
      for(const h of hours){
        const v = Number(state.prod.get(`${m.maquila}|${h}`) || 0);
        acc += v;
        const cell = document.querySelector(`[data-acc="${CSS.escape(m.maquila)}"][data-hour="${h}"]`);
        if(cell) cell.textContent = acc ? String(acc) : '';
      }
      grand += acc;
      const tcell = document.querySelector(`[data-total="${CSS.escape(m.maquila)}"]`);
      if(tcell) tcell.textContent = String(acc);

      const pct = (totalCajas>0) ? Math.round((acc/totalCajas)*100) : 0;
      const pcell = document.querySelector(`[data-pct="${CSS.escape(m.maquila)}"]`);
      if(pcell) pcell.textContent = `${pct}%`;
    }

    // avance general acumulado (todas maquilas, día seleccionado)
    const pctG = (totalCajas>0) ? Math.round((grand/totalCajas)*100) : 0;
    const meta = el('svaDetProdMeta');
    if(meta) meta.textContent = totalCajas>0 ? `(${grand} / ${totalCajas} cajas)` : `(${grand} cajas)`;
    const pctEl = el('svaDetPct');
    if(pctEl) pctEl.textContent = totalCajas>0 ? `${pctG}%` : '—';
  }

  async function _svaDetSave(state){
    try{
      if(!authUser){ toastErr('Inicia sesión en ADMIN para guardar.'); return; }
      await ensureSupa();
      if(!supa) { toastErr('Nube no conectada.'); return; }

      const { contenedor_norm, arribo_ymd, proceso } = state;
      const work_ymd = state.workYmd || _todayYMD();

      // 1) upsert maquilas
      if(state.maquilas.length){
        const payload = state.maquilas.map(m=>({
          contenedor_norm, arribo_ymd, proceso,
          maquila: m.maquila,
          personal: m.personal
        }));
        const up = await supa.from('sva_reprocesos_maquilas').upsert(payload);
        if(up.error) throw up.error;
      }

      // 2) upsert producción por hora
      const hours = _svaHours(state.startHour);
      const prodPayload = [];
      for(const m of state.maquilas){
        for(const h of hours){
          const cajas = Number(state.prod.get(`${m.maquila}|${h}`) || 0);
          prodPayload.push({
            contenedor_norm, arribo_ymd, proceso, maquila: m.maquila,
            work_ymd, hour_start: h, cajas
          });
        }
      }
      if(prodPayload.length){
        const up2 = await supa.from('sva_prod_hora').upsert(prodPayload);
        if(up2.error) throw up2.error;
      }

      // 3) recalcular avance general del día y reflejar en sva_reprocesos
      const totalCajas = state.totalCajas || 0;
      let grand = 0;
      for(const m of state.maquilas){
        for(const h of hours){
          grand += Number(state.prod.get(`${m.maquila}|${h}`) || 0);
        }
      }
      // avance acumulado (todas las capturas) para el renglón del contenedor
      let grandAll = grand;
      try{
        const agg = await supa.from('sva_prod_hora')
          .select('cajas')
          .eq('contenedor_norm', contenedor_norm)
          .eq('arribo_ymd', arribo_ymd)
          .eq('proceso', proceso);
        if(!agg.error){
          grandAll = (agg.data||[]).reduce((a,r)=>a + Number(r.cajas||0), 0);
        }
      }catch(e){ console.warn(e); }

      const avance_pct = (totalCajas>0) ? Math.round((grandAll/totalCajas)*100) : null;
      const maquilasTxt = state.maquilas.map(m=>m.maquila).join(', ');
      const persTxt = state.maquilas.map(m=>`${m.maquila}:${m.personal??''}`).join(', ');

      // actualiza registro maestro
      const up3 = await supa.from('sva_reprocesos').upsert([{
        contenedor_norm, arribo_ymd, proceso,
        maquilas: maquilasTxt || null,
        personal_maquila: persTxt || null,
        avance_pct: avance_pct,
        updated_at: new Date().toISOString()
      }]);
      if(up3.error) console.warn(up3.error); // no bloquea

      // 4) huella (log)
      try{
        const lg = await supa.from('sva_reprocesos_log').insert([{
          contenedor_norm, arribo_ymd, proceso,
          action: 'SAVE_DETALLE',
          field: 'prod_hora',
          old_value: null,
          new_value: `${work_ymd}: ${grand} cajas (acum: ${grandAll})`,
          changed_by: authUser?.id || null
        }]);
        if(lg.error) console.warn(lg.error);
      }catch(e){ console.warn(e); }

      // refrescar renglón
      await reloadSVA();
      toastOk('Guardado.');
      await _svaDetLoadLog(state);
    }catch(err){
      console.error(err);
      toastErr('No se pudo guardar detalle SVA.');
    }
  }

  async function _svaDetLoadLog(state){
    try{
      if(!supa) return;
      const r = await supa.from('sva_reprocesos_log')
        .select('changed_at,action,field,new_value,changed_by')
        .eq('contenedor_norm', state.contenedor_norm)
        .eq('arribo_ymd', state.arribo_ymd)
        .eq('proceso', state.proceso)
        .order('changed_at', { ascending:false })
        .limit(20);

      if(r.error){ console.warn(r.error); return; }
      const rows = r.data || [];
      const host = el('svaDetLog');
      if(!host) return;
      if(!rows.length){
        host.innerHTML = `<div class="muted">Sin huella todavía.</div>`;
        return;
      }
      host.innerHTML = `
        <div style="overflow:auto">
          <table class="table" style="min-width:620px">
            <thead><tr><th>HORA</th><th>ACCIÓN</th><th>DETALLE</th><th>USUARIO</th></tr></thead>
            <tbody>
              ${rows.map(x=>`
                <tr>
                  <td>${esc(_isoToYMDLocal(x.changed_at))} ${esc(_isoToHM(x.changed_at))}</td>
                  <td>${esc(x.action||'')}</td>
                  <td>${esc(x.new_value||x.field||'')}</td>
                  <td class="muted">${esc(x.changed_by||'')}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }catch(err){
      console.warn(err);
    }
  }

</script>
</body>
</html>

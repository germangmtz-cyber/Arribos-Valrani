<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Arribos CEDIS — Admin (SVA + Logística) v3 fix</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#111827; --muted:#94a3b8; --text:#e5e7eb;
      --line:#243041; --accent:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --chip:#0f172a; --btn:#1f2937;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:var(--sans); background:linear-gradient(180deg,#070a0f, #0b0f14 45%, #070a0f); color:var(--text)}
    a{color:inherit}
    .wrap{max-width:1200px; margin:0 auto; padding:16px 16px 60px}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 0 14px}
    h1{font-size:18px; margin:0; letter-spacing:.2px}
    .sub{font-size:12px; color:var(--muted); margin-top:2px}
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{
      border:1px solid var(--line); background:rgba(17,24,39,.65);
      padding:8px 10px; border-radius:12px; cursor:pointer;
      color:var(--muted); font-size:13px; user-select:none
    }
    .tab.active{color:var(--text); border-color:rgba(34,197,94,.55); box-shadow:0 0 0 2px rgba(34,197,94,.12) inset}
    .card{
      background:rgba(17,24,39,.75);
      border:1px solid var(--line); border-radius:18px;
      padding:14px; box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .kpis{display:grid; grid-template-columns:repeat(4,minmax(160px,1fr)); gap:10px}
    .kpi{padding:12px; border-radius:16px; border:1px solid var(--line); background:rgba(15,23,42,.55)}
    .kpi .label{font-size:12px; color:var(--muted)}
    .kpi .val{font-size:22px; font-weight:700; margin-top:4px}
    .kpi .hint{font-size:12px; color:var(--muted); margin-top:3px}
    .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:end}
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
    input, select, textarea{
      width:100%; padding:9px 10px; border-radius:12px;
      border:1px solid var(--line); background:#0b1220; color:var(--text);
      outline:none
    }
    textarea{min-height:74px; resize:vertical}
    input[type="date"]{padding:8px 10px}
    .btn{
      background:var(--btn); border:1px solid var(--line); color:var(--text);
      padding:9px 12px; border-radius:12px; cursor:pointer; font-size:13px;
    }
    .btn:hover{filter:brightness(1.08)}
    .btn.green{background:rgba(34,197,94,.18); border-color:rgba(34,197,94,.45)}
    .btn.orange{background:rgba(245,158,11,.16); border-color:rgba(245,158,11,.45)}
    .btn.red{background:rgba(239,68,68,.14); border-color:rgba(239,68,68,.45)}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:5px 8px; border-radius:999px; border:1px solid var(--line); background:rgba(15,23,42,.55); color:var(--muted); font-size:12px}
    .pill.good{border-color:rgba(34,197,94,.45); color:#bbf7d0}
    .pill.warn{border-color:rgba(245,158,11,.45); color:#fde68a}
    .pill.bad{border-color:rgba(239,68,68,.45); color:#fecaca}
    .grid{display:grid; grid-template-columns:1.4fr .6fr; gap:12px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} .kpis{grid-template-columns:repeat(2,minmax(160px,1fr))} }
    table{width:100%; border-collapse:separate; border-spacing:0}
    th, td{padding:10px 10px; border-bottom:1px solid var(--line); vertical-align:top; font-size:13px}
    th{color:var(--muted); font-weight:600; font-size:12px; text-align:left}
    tr:hover td{background:rgba(15,23,42,.25)}
    .muted{color:var(--muted)}
    .mono{font-family:var(--mono)}
    .right{text-align:right}
    .small{font-size:12px}
    .example td{opacity:.75}
    .footerNote{margin-top:10px; color:var(--muted); font-size:12px}
    .hr{height:1px; background:var(--line); margin:12px 0}
    .hidden{display:none !important}
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:rgba(15,23,42,.55); color:var(--text); font-size:12px}
    .chip input{width:auto; margin:0}
    .toast{position:fixed; left:16px; bottom:16px; padding:10px 12px; border-radius:14px;
      border:1px solid var(--line); background:rgba(17,24,39,.92); color:var(--text);
      box-shadow:0 20px 60px rgba(0,0,0,.35); max-width:520px; display:none
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Arribos CEDIS — Admin <span class="mono muted">v3_fix</span></h1>
        <div class="sub">Incluye: fix <span class="mono">escapeHtml</span>, lógica SVA con <span class="mono">fin_descarga_at</span> y Logística con rango hoy→+30, fila EJEMPLO y auto-ajuste del rango al agregar.</div>
      </div>
      <div class="tabs" role="tablist" aria-label="Secciones">
        <div class="tab active" data-tab="sva">SVA</div>
        <div class="tab" data-tab="logistica">LOGÍSTICA</div>
        <div class="tab" data-tab="admin">ADMIN</div>
      </div>
    </header>

    <!-- SVA -->
    <section id="tab-sva" class="card">
      <div class="row" style="align-items:flex-start; justify-content:space-between">
        <div>
          <div class="pill">Fuente: <span class="mono" id="sva-source">local</span></div>
        </div>
        <div class="chips" aria-label="Filtros SVA">
          <label class="chip"><input type="checkbox" id="sva-k-corrug" checked> CORRUG</label>
          <label class="chip"><input type="checkbox" id="sva-k-uva" checked> UVA</label>
          <label class="chip"><input type="checkbox" id="sva-k-tihi" checked> TI HI</label>
        </div>
      </div>

      <div class="hr"></div>

      <div class="kpis" style="margin-bottom:12px">
        <div class="kpi">
          <div class="label">SVA (Total)</div>
          <div class="val" id="sva-kpi-total">0</div>
          <div class="hint">Coinciden con filtros de texto</div>
        </div>
        <div class="kpi">
          <div class="label">Pendientes</div>
          <div class="val" id="sva-kpi-pend">0</div>
          <div class="hint">Sin <span class="mono">fin_descarga_at</span> ni <span class="mono">fin_at</span></div>
        </div>
        <div class="kpi">
          <div class="label">Concluidos</div>
          <div class="val" id="sva-kpi-done">0</div>
          <div class="hint">Con <span class="mono">fin_descarga_at</span> (fallback: <span class="mono">fin_at</span>)</div>
        </div>
        <div class="kpi">
          <div class="label">Última actualización</div>
          <div class="val" id="sva-kpi-upd" style="font-size:14px; font-weight:600">—</div>
          <div class="hint">Hora local CDMX</div>
        </div>
      </div>

      <div class="grid">
        <div>
          <table aria-label="Tabla SVA">
            <thead>
              <tr>
                <th>Contenedor</th>
                <th>CEDIS</th>
                <th>Estatus</th>
                <th>Indicaciones</th>
                <th>Descarga</th>
                <th class="right">SVA</th>
              </tr>
            </thead>
            <tbody id="sva-tbody"></tbody>
          </table>
          <div class="footerNote">
            Nota: Si SVA te aparece vacío sin error, revisa que el texto esté en <span class="mono">indicacion</span>. Si tu operación lo captura en otra columna (p.ej. <span class="mono">cuenta</span> u <span class="mono">observaciones</span>), se puede ampliar la detección sin romper nada.
          </div>
        </div>

        <div class="card" style="border-radius:18px; padding:12px">
          <div class="pill warn" style="margin-bottom:10px">Detección SVA</div>
          <div class="small muted">
            Se considera SVA si alguna de estas cadenas aparece (case-insensitive):
          </div>
          <div class="hr"></div>
          <div class="mono small" id="sva-detect-summary">CORRUG · UVA · TI HI</div>
          <div class="hr"></div>
          <div class="small muted">
            La columna “Descarga” se determina así:
          </div>
          <ul class="small muted" style="margin:8px 0 0 18px">
            <li>Si existe <span class="mono">fin_descarga_at</span> → Concluida</li>
            <li>Si no, pero existe <span class="mono">fin_at</span> → Concluida</li>
            <li>Si no existe ninguna → Pendiente</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- LOGÍSTICA -->
    <section id="tab-logistica" class="card hidden">
      <div class="row" style="justify-content:space-between; align-items:center">
        <div class="pill">Fuente: <span class="mono" id="log-source">local</span></div>
        <div class="row" style="gap:8px; align-items:center">
          <button class="btn orange" id="btn-hoy">Hoy</button>
          <button class="btn" id="btn-reload-log">Recargar</button>
        </div>
      </div>

      <div class="hr"></div>

      <div class="controls" style="margin-bottom:12px">
        <div style="min-width:220px">
          <label>Fecha inicio</label>
          <input type="date" id="log-from" />
        </div>
        <div style="min-width:220px">
          <label>Fecha fin</label>
          <input type="date" id="log-to" />
        </div>
        <div style="min-width:240px">
          <label>Buscar (cliente/destino/comentario)</label>
          <input type="text" id="log-q" placeholder="Ej. Liverpool, Monterrey, urg..." />
        </div>
        <div style="min-width:160px">
          <label>&nbsp;</label>
          <button class="btn green" id="btn-apply-log">Aplicar</button>
        </div>
      </div>

      <div class="kpis" style="margin-bottom:12px">
        <div class="kpi">
          <div class="label">Embarques (en rango)</div>
          <div class="val" id="log-kpi-total">0</div>
          <div class="hint">Incluye filtros de búsqueda</div>
        </div>
        <div class="kpi">
          <div class="label">Inicio → fin</div>
          <div class="val" id="log-kpi-range" style="font-size:14px; font-weight:600">—</div>
          <div class="hint">Rango activo</div>
        </div>
        <div class="kpi">
          <div class="label">Última actualización</div>
          <div class="val" id="log-kpi-upd" style="font-size:14px; font-weight:600">—</div>
          <div class="hint">Hora local CDMX</div>
        </div>
        <div class="kpi">
          <div class="label">Estatus</div>
          <div class="val" id="log-kpi-status" style="font-size:14px; font-weight:600">OK</div>
          <div class="hint">Si no hay registros, se muestra EJEMPLO</div>
        </div>
      </div>

      <table aria-label="Tabla logística">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Cliente</th>
            <th>Destino</th>
            <th class="right">Piezas</th>
            <th>Comentario</th>
            <th class="right">Acción</th>
          </tr>
        </thead>
        <tbody id="log-tbody"></tbody>
      </table>

      <div class="footerNote">
        Fix clave: el rango por defecto y botón Hoy cubren <span class="mono">hoy → +30 días</span>, así no “desaparecen” embarques futuros por el filtro.
      </div>
    </section>

    <!-- ADMIN -->
    <section id="tab-admin" class="card hidden">
      <div class="row" style="justify-content:space-between; align-items:center">
        <div class="pill">Modo: <span class="mono">administración</span></div>
        <div class="row" style="gap:8px">
          <button class="btn" id="btn-seed">Cargar datos demo</button>
          <button class="btn red" id="btn-clear">Limpiar localStorage</button>
        </div>
      </div>

      <div class="hr"></div>

      <div class="grid">
        <div class="card" style="border-radius:18px; padding:12px">
          <div class="pill warn" style="margin-bottom:10px">Agregar contenedor (para SVA)</div>
          <div class="row">
            <div style="min-width:180px; flex:1">
              <label>Contenedor</label>
              <input id="c-id" placeholder="MSCU1234567" />
            </div>
            <div style="min-width:140px">
              <label>CEDIS</label>
              <select id="c-cedis">
                <option value="CDMX">CDMX</option>
                <option value="GDL">GDL</option>
                <option value="MTY">MTY</option>
                <option value="QRO">QRO</option>
              </select>
            </div>
            <div style="min-width:160px">
              <label>Estatus</label>
              <select id="c-estatus">
                <option value="ARRIBADO">ARRIBADO</option>
                <option value="EN DESCARGA">EN DESCARGA</option>
                <option value="CONCLUIDO">CONCLUIDO</option>
                <option value="LIBERADO">LIBERADO</option>
                <option value="RECHAZADO">RECHAZADO</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div style="min-width:220px; flex:1">
              <label>Indicaciones (aquí se detecta CORRUG/UVA/TI HI)</label>
              <input id="c-ind" placeholder="Ej. SVA: CORRUG + reetiquetado" />
            </div>
            <div style="min-width:220px">
              <label>Arribo (fecha/hora)</label>
              <input id="c-arribo" type="datetime-local" />
            </div>
          </div>
          <div class="row">
            <div style="min-width:220px">
              <label>Fin descarga (fin_descarga_at)</label>
              <input id="c-fin-desc" type="datetime-local" />
            </div>
            <div style="min-width:220px">
              <label>Fin (fallback fin_at)</label>
              <input id="c-fin" type="datetime-local" />
            </div>
          </div>
          <div class="row">
            <div style="min-width:260px; flex:1">
              <label>Observaciones</label>
              <input id="c-obs" placeholder="Opcional" />
            </div>
            <div style="min-width:160px">
              <label>&nbsp;</label>
              <button class="btn green" id="btn-add-container">Agregar contenedor</button>
            </div>
          </div>
          <div class="footerNote">Si quieres que SVA detecte por otra columna (cuenta/observaciones), se puede expandir el matcher de texto.</div>
        </div>

        <div class="card" style="border-radius:18px; padding:12px">
          <div class="pill warn" style="margin-bottom:10px">Agregar embarque (Logística)</div>
          <div class="row">
            <div style="min-width:200px; flex:1">
              <label>Fecha embarque</label>
              <input id="s-fecha" type="date" />
            </div>
            <div style="min-width:220px; flex:1">
              <label>Cliente</label>
              <input id="s-cliente" placeholder="Ej. Liverpool" />
            </div>
          </div>
          <div class="row">
            <div style="min-width:220px; flex:1">
              <label>Destino</label>
              <input id="s-destino" placeholder="Ej. Monterrey" />
            </div>
            <div style="min-width:140px">
              <label>Piezas</label>
              <input id="s-piezas" type="number" min="0" step="1" placeholder="0" />
            </div>
          </div>
          <div class="row">
            <div style="min-width:260px; flex:1">
              <label>Comentario</label>
              <input id="s-coment" placeholder="Opcional" />
            </div>
            <div style="min-width:160px">
              <label>&nbsp;</label>
              <button class="btn green" id="btn-add-shipment">Agregar embarque</button>
            </div>
          </div>
          <div class="footerNote">
            Fix clave: si agregas un embarque fuera del rango actual, el sistema ajusta automáticamente <span class="mono">log-from/log-to</span> para que lo veas de inmediato.
          </div>
        </div>
      </div>
    </section>

    <div class="toast" id="toast"></div>
  </div>

  <script>
    /***********************
     * Helpers (FIX SVA)
     ***********************/
    function esc(str){
      return String(str ?? "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }
    // FIX: escapeHtml is not defined (alias de esc)
    const escapeHtml = esc;

    function toast(msg){
      const el = document.getElementById("toast");
      el.textContent = msg;
      el.style.display = "block";
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> el.style.display="none", 2600);
    }

    function pad2(n){ return String(n).padStart(2,"0"); }

    // Date helpers: evitar UTC toISOString para filtros (usar local)
    function todayLocalYMD(){
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }
    function addDaysYMD(ymd, days){
      const [y,m,d] = ymd.split("-").map(Number);
      const dt = new Date(y, m-1, d);
      dt.setDate(dt.getDate() + days);
      return `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())}`;
    }
    function ymdToDate(ymd){
      const [y,m,d] = ymd.split("-").map(Number);
      return new Date(y, m-1, d, 0,0,0,0);
    }
    function inYmdRange(ymd, fromYmd, toYmd){
      const t = ymdToDate(ymd).getTime();
      const a = ymdToDate(fromYmd).getTime();
      const b = ymdToDate(toYmd).getTime();
      return t >= a && t <= b;
    }
    function nowLocalStamp(){
      const d = new Date();
      return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()} ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
    }
    function dtLocalValueToIso(dtLocal){
      // input: "YYYY-MM-DDTHH:mm"
      if(!dtLocal) return null;
      // store as ISO-like string without timezone: keep as local stamp
      return dtLocal;
    }

    /***********************
     * Storage (Supabase placeholder + local fallback)
     ***********************/
    const LS = {
      containers: "arribos_containers_v3",
      shipments:  "arribos_shipments_v3"
    };

    // Placeholder (si tienes supabase, aquí conectas; de lo contrario, usa local)
    const SUPABASE = {
      enabled:false,
      // url:"", key:""
    };

    function loadJson(key, fallback){
      try{
        const raw = localStorage.getItem(key);
        if(!raw) return fallback;
        return JSON.parse(raw);
      }catch(e){
        console.warn("loadJson error", key, e);
        return fallback;
      }
    }
    function saveJson(key, data){
      localStorage.setItem(key, JSON.stringify(data));
    }

    async function getContainers(){
      // Aquí iría supabase si lo habilitas.
      return loadJson(LS.containers, []);
    }
    async function getShipments(){
      return loadJson(LS.shipments, []);
    }
    async function upsertContainer(c){
      const all = loadJson(LS.containers, []);
      const idx = all.findIndex(x => x.id === c.id);
      if(idx >= 0) all[idx] = {...all[idx], ...c, updated_at: nowLocalStamp()};
      else all.unshift({...c, created_at: nowLocalStamp(), updated_at: nowLocalStamp()});
      saveJson(LS.containers, all);
      return c;
    }
    async function addShipment(s){
      const all = loadJson(LS.shipments, []);
      const id = s.id || cryptoRandomId();
      all.unshift({...s, id, created_at: nowLocalStamp(), updated_at: nowLocalStamp()});
      saveJson(LS.shipments, all);
      return id;
    }
    async function deleteShipment(id){
      const all = loadJson(LS.shipments, []);
      saveJson(LS.shipments, all.filter(x => x.id !== id));
    }
    function cryptoRandomId(){
      if(window.crypto?.getRandomValues){
        const a = new Uint32Array(3);
        window.crypto.getRandomValues(a);
        return Array.from(a).map(x=>x.toString(16)).join("");
      }
      return String(Math.random()).slice(2) + String(Date.now());
    }

    /***********************
     * Tabs
     ***********************/
    const tabs = document.querySelectorAll(".tab");
    tabs.forEach(t => t.addEventListener("click", () => {
      tabs.forEach(x => x.classList.remove("active"));
      t.classList.add("active");
      const name = t.dataset.tab;
      ["sva","logistica","admin"].forEach(k=>{
        document.getElementById(`tab-${k}`).classList.toggle("hidden", k !== name);
      });
      // refresh when opening
      if(name==="sva") renderSVA();
      if(name==="logistica") renderLogistica();
    }));

    /***********************
     * SVA render
     ***********************/
    function svaKeywords(){
      const keys = [];
      if(document.getElementById("sva-k-corrug").checked) keys.push("CORRUG");
      if(document.getElementById("sva-k-uva").checked) keys.push("UVA");
      if(document.getElementById("sva-k-tihi").checked) keys.push("TI HI");
      return keys;
    }

    function matchesSVA(container, keys){
      const hay = (
        (container.indicacion ?? "") + " " +
        (container.cuenta ?? "") + " " +
        (container.observaciones ?? "")
      ).toUpperCase();
      return keys.some(k => hay.includes(k));
    }

    function descargaConcluida(container){
      // FIX: usar fin_descarga_at (fallback fin_at)
      return Boolean(container.fin_descarga_at || container.fin_at);
    }

    function pillForDescarga(container){
      if(descargaConcluida(container)) return `<span class="pill good">Concluida</span>`;
      return `<span class="pill warn">Pendiente</span>`;
    }

    function svaTag(container, keys){
      const hay = ((container.indicacion ?? "") + " " + (container.cuenta ?? "") + " " + (container.observaciones ?? "")).toUpperCase();
      const hits = keys.filter(k => hay.includes(k));
      if(hits.length===0) return `<span class="pill">—</span>`;
      return `<span class="pill good mono">${escapeHtml(hits.join(" · "))}</span>`;
    }

    async function renderSVA(){
      const keys = svaKeywords();
      document.getElementById("sva-detect-summary").textContent = keys.length ? keys.join(" · ") : "—";
      document.getElementById("sva-source").textContent = SUPABASE.enabled ? "supabase" : "local";

      const all = await getContainers();
      const data = all
        .filter(c => matchesSVA(c, keys))
        .sort((a,b)=> (String(b.arribo_at||"")).localeCompare(String(a.arribo_at||"")));

      let pend = 0, done = 0;
      const tbody = document.getElementById("sva-tbody");
      tbody.innerHTML = "";

      for(const c of data){
        const isDone = descargaConcluida(c);
        if(isDone) done++; else pend++;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="mono">${escapeHtml(c.id || "—")}</td>
          <td>${escapeHtml(c.cedis || "—")}</td>
          <td>${escapeHtml(c.estatus || "—")}</td>
          <td>${escapeHtml(c.indicacion || "")}<div class="small muted">${escapeHtml(c.observaciones || "")}</div></td>
          <td>
            ${pillForDescarga(c)}
            <div class="small muted" style="margin-top:6px">
              <span class="mono">fin_descarga_at:</span> ${escapeHtml(c.fin_descarga_at || "—")}<br/>
              <span class="mono">fin_at:</span> ${escapeHtml(c.fin_at || "—")}
            </div>
          </td>
          <td class="right">${svaTag(c, keys)}</td>
        `;
        tbody.appendChild(tr);
      }

      document.getElementById("sva-kpi-total").textContent = data.length;
      document.getElementById("sva-kpi-pend").textContent = pend;
      document.getElementById("sva-kpi-done").textContent = done;
      document.getElementById("sva-kpi-upd").textContent = nowLocalStamp();

      // empty state (keep table header, show one row)
      if(data.length === 0){
        const tr = document.createElement("tr");
        tr.className = "example";
        tr.innerHTML = `
          <td class="mono">EJEMPLO1234567</td>
          <td>CDMX</td>
          <td>ARRIBADO</td>
          <td><span class="mono">SVA:</span> CORRUG + reetiquetado</td>
          <td><span class="pill warn">Pendiente</span></td>
          <td class="right"><span class="pill good mono">CORRUG</span></td>
        `;
        tbody.appendChild(tr);
      }
    }

    ["sva-k-corrug","sva-k-uva","sva-k-tihi"].forEach(id=>{
      document.getElementById(id).addEventListener("change", renderSVA);
    });

    /***********************
     * LOGÍSTICA render
     ***********************/
    function getLogRange(){
      const from = document.getElementById("log-from").value;
      const to = document.getElementById("log-to").value;
      return {from, to};
    }
    function setLogRange(from, to){
      document.getElementById("log-from").value = from;
      document.getElementById("log-to").value = to;
    }
    function ensureDefaultLogRange(){
      const fromEl = document.getElementById("log-from");
      const toEl = document.getElementById("log-to");
      if(!fromEl.value || !toEl.value){
        const t = todayLocalYMD();
        fromEl.value = t;
        toEl.value = addDaysYMD(t, 30); // FIX: hoy → +30 días
      }
    }

    function logMatchesQuery(s, q){
      if(!q) return true;
      const hay = `${s.cliente||""} ${s.destino||""} ${s.comentario||""}`.toLowerCase();
      return hay.includes(q.toLowerCase());
    }

    async function renderLogistica(){
      ensureDefaultLogRange();
      document.getElementById("log-source").textContent = SUPABASE.enabled ? "supabase" : "local";

      const {from, to} = getLogRange();
      const q = document.getElementById("log-q").value.trim();

      document.getElementById("log-kpi-range").textContent = `${from} → ${to}`;
      document.getElementById("log-kpi-upd").textContent = nowLocalStamp();

      const all = await getShipments();
      const data = all
        .filter(s => s.fecha_embarque && inYmdRange(s.fecha_embarque, from, to))
        .filter(s => logMatchesQuery(s, q))
        .sort((a,b)=> (b.fecha_embarque || "").localeCompare(a.fecha_embarque || ""));

      const tbody = document.getElementById("log-tbody");
      tbody.innerHTML = "";

      if(data.length === 0){
        // FIX: Mostrar fila EJEMPLO (no se guarda)
        document.getElementById("log-kpi-status").textContent = "Sin registros → mostrando EJEMPLO";
        const tr = document.createElement("tr");
        tr.className = "example";
        tr.innerHTML = `
          <td class="mono">${escapeHtml(todayLocalYMD())}</td>
          <td>EJEMPLO (no se guarda)</td>
          <td>CDMX → MTY</td>
          <td class="right">1,250</td>
          <td class="muted">Formato de muestra para validar captura/visualización</td>
          <td class="right"><span class="pill">—</span></td>
        `;
        tbody.appendChild(tr);
      } else {
        document.getElementById("log-kpi-status").textContent = "OK";
        for(const s of data){
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="mono">${escapeHtml(s.fecha_embarque || "—")}</td>
            <td>${escapeHtml(s.cliente || "—")}</td>
            <td>${escapeHtml(s.destino || "—")}</td>
            <td class="right">${escapeHtml(String(s.piezas ?? "—"))}</td>
            <td>${escapeHtml(s.comentario || "")}<div class="small muted">ID: <span class="mono">${escapeHtml(s.id)}</span></div></td>
            <td class="right">
              <button class="btn red small" data-del="${escapeHtml(s.id)}">Eliminar</button>
            </td>
          `;
          tbody.appendChild(tr);
        }
      }

      document.getElementById("log-kpi-total").textContent = data.length;

      // hook delete buttons
      tbody.querySelectorAll("[data-del]").forEach(btn=>{
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-del");
          await deleteShipment(id);
          toast("Embarque eliminado.");
          renderLogistica();
        });
      });
    }

    document.getElementById("btn-hoy").addEventListener("click", () => {
      const t = todayLocalYMD();
      setLogRange(t, addDaysYMD(t, 30)); // FIX: Hoy → +30 días
      renderLogistica();
      toast("Rango ajustado: hoy → +30 días.");
    });
    document.getElementById("btn-apply-log").addEventListener("click", renderLogistica);
    document.getElementById("btn-reload-log").addEventListener("click", renderLogistica);

    /***********************
     * ADMIN actions
     ***********************/
    // set default dt inputs with local now for convenience
    (function initAdminDefaults(){
      const now = new Date();
      const dt = `${now.getFullYear()}-${pad2(now.getMonth()+1)}-${pad2(now.getDate())}T${pad2(now.getHours())}:${pad2(now.getMinutes())}`;
      document.getElementById("c-arribo").value = dt;
      document.getElementById("s-fecha").value = todayLocalYMD();
    })();

    document.getElementById("btn-add-container").addEventListener("click", async () => {
      const id = document.getElementById("c-id").value.trim().toUpperCase();
      if(!id){ toast("Falta Contenedor."); return; }

      const c = {
        id,
        cedis: document.getElementById("c-cedis").value,
        estatus: document.getElementById("c-estatus").value,
        indicacion: document.getElementById("c-ind").value.trim(),
        observaciones: document.getElementById("c-obs").value.trim(),
        arribo_at: dtLocalValueToIso(document.getElementById("c-arribo").value),
        fin_descarga_at: dtLocalValueToIso(document.getElementById("c-fin-desc").value),
        fin_at: dtLocalValueToIso(document.getElementById("c-fin").value),
      };

      await upsertContainer(c);
      toast("Contenedor guardado (local).");
      renderSVA();
    });

    document.getElementById("btn-add-shipment").addEventListener("click", async () => {
      const fecha = document.getElementById("s-fecha").value;
      const cliente = document.getElementById("s-cliente").value.trim();
      const destino = document.getElementById("s-destino").value.trim();
      const piezas = Number(document.getElementById("s-piezas").value || 0);
      const comentario = document.getElementById("s-coment").value.trim();

      if(!fecha){ toast("Falta fecha de embarque."); return; }
      if(!cliente){ toast("Falta cliente."); return; }
      if(!destino){ toast("Falta destino."); return; }

      const id = await addShipment({ fecha_embarque: fecha, cliente, destino, piezas, comentario });

      // FIX: Si el embarque cae fuera del rango, ajustar rango para incluirlo
      ensureDefaultLogRange();
      let {from, to} = getLogRange();
      if(!inYmdRange(fecha, from, to)){
        const min = (ymdToDate(fecha) < ymdToDate(from)) ? fecha : from;
        const max = (ymdToDate(fecha) > ymdToDate(to)) ? fecha : to;
        setLogRange(min, max);
        toast("Embarque agregado y rango ajustado para incluirlo.");
      }else{
        toast("Embarque agregado.");
      }

      // limpiar campos ligeros
      document.getElementById("s-cliente").value = "";
      document.getElementById("s-destino").value = "";
      document.getElementById("s-piezas").value = "";
      document.getElementById("s-coment").value = "";

      // abrir logística y renderizar
      document.querySelector('.tab[data-tab="logistica"]').click();
      renderLogistica();
      console.log("Shipment id:", id);
    });

    document.getElementById("btn-clear").addEventListener("click", () => {
      localStorage.removeItem(LS.containers);
      localStorage.removeItem(LS.shipments);
      toast("localStorage limpiado.");
      renderSVA();
      renderLogistica();
    });

    document.getElementById("btn-seed").addEventListener("click", async () => {
      const t = todayLocalYMD();
      const demoContainers = [
        { id:"MSCU1234567", cedis:"CDMX", estatus:"EN DESCARGA", indicacion:"SVA: CORRUG + reetiquetado", observaciones:"Demo", arribo_at:`${t}T08:10`, fin_descarga_at:"", fin_at:"" },
        { id:"TLLU7654321", cedis:"GDL",  estatus:"CONCLUIDO",  indicacion:"UVA — inspección especial", observaciones:"Demo", arribo_at:`${t}T07:20`, fin_descarga_at:`${t}T12:40`, fin_at:`${t}T13:05` },
        { id:"OOLU5558883", cedis:"MTY",  estatus:"ARRIBADO",   indicacion:"Sin SVA", observaciones:"Demo", arribo_at:`${t}T06:00`, fin_descarga_at:"", fin_at:"" },
        { id:"CMAU9988776", cedis:"QRO",  estatus:"ARRIBADO",   indicacion:"TI HI — requiere tratamiento", observaciones:"Demo", arribo_at:`${t}T09:15`, fin_descarga_at:"", fin_at:"" },
      ];
      saveJson(LS.containers, demoContainers.map(x=>({...x, created_at: nowLocalStamp(), updated_at: nowLocalStamp()})));

      const demoShip = [
        { id: cryptoRandomId(), fecha_embarque: addDaysYMD(t, 0), cliente:"Liverpool", destino:"CDMX → MTY", piezas:1250, comentario:"Ruta 1", created_at: nowLocalStamp(), updated_at: nowLocalStamp() },
        { id: cryptoRandomId(), fecha_embarque: addDaysYMD(t, 3), cliente:"Coppel", destino:"CDMX → GDL", piezas:820, comentario:"Ruta 2", created_at: nowLocalStamp(), updated_at: nowLocalStamp() },
        { id: cryptoRandomId(), fecha_embarque: addDaysYMD(t, 15), cliente:"Amazon", destino:"CDMX → QRO", piezas:500, comentario:"Urgente", created_at: nowLocalStamp(), updated_at: nowLocalStamp() },
      ];
      saveJson(LS.shipments, demoShip);
      toast("Datos demo cargados.");
      renderSVA();
      renderLogistica();
    });

    /***********************
     * Boot
     ***********************/
    (function boot(){
      // defaults for logística
      const t = todayLocalYMD();
      setLogRange(t, addDaysYMD(t, 30)); // FIX: rango por defecto hoy→+30
      renderSVA();
      renderLogistica();
    })();
  </script>
</body>
</html>

-- ============================================================
-- SVA PRODUCTIVIDAD: maquilas + producción por hora + bitácora
-- (select público, escritura solo authenticated)
-- ============================================================

-- 0) (Opcional) Asegura columnas en sva_reprocesos (si ya existen, no pasa nada)
do $$
begin
  begin
    alter table public.sva_reprocesos
      add column if not exists maquilas text,
      add column if not exists personal_maquila text,
      add column if not exists avance_pct integer,
      add column if not exists updated_at timestamptz;
  exception when undefined_table then
    -- si no existe la tabla, ignora (pero tu sistema actual sí la usa)
    null;
  end;
end $$;

-- 1) Tabla: maquilas asignadas por contenedor/proceso
create table if not exists public.sva_reprocesos_maquilas (
  contenedor_norm text not null,
  arribo_ymd date not null,
  proceso text not null,
  maquila text not null,
  personal integer,
  updated_at timestamptz not null default now(),
  primary key (contenedor_norm, arribo_ymd, proceso, maquila)
);

create index if not exists sva_maquilas_key_idx
  on public.sva_reprocesos_maquilas (contenedor_norm, arribo_ymd, proceso);

alter table public.sva_reprocesos_maquilas enable row level security;

drop policy if exists sva_maquilas_select_all on public.sva_reprocesos_maquilas;
drop policy if exists sva_maquilas_write_auth on public.sva_reprocesos_maquilas;

create policy sva_maquilas_select_all
  on public.sva_reprocesos_maquilas
  for select to anon, authenticated
  using (true);

create policy sva_maquilas_write_auth
  on public.sva_reprocesos_maquilas
  for all to authenticated
  using (true)
  with check (true);

-- 2) Tabla: producción por hora (por maquila)
create table if not exists public.sva_prod_hora (
  contenedor_norm text not null,
  arribo_ymd date not null,
  proceso text not null,
  maquila text not null,
  work_ymd date not null,
  hour_start integer not null check (hour_start >= 0 and hour_start <= 23),
  cajas integer not null default 0 check (cajas >= 0),
  updated_at timestamptz not null default now(),
  primary key (contenedor_norm, arribo_ymd, proceso, maquila, work_ymd, hour_start)
);

create index if not exists sva_prod_key_idx
  on public.sva_prod_hora (contenedor_norm, arribo_ymd, proceso, work_ymd);

alter table public.sva_prod_hora enable row level security;

drop policy if exists sva_prod_select_all on public.sva_prod_hora;
drop policy if exists sva_prod_write_auth on public.sva_prod_hora;

create policy sva_prod_select_all
  on public.sva_prod_hora
  for select to anon, authenticated
  using (true);

create policy sva_prod_write_auth
  on public.sva_prod_hora
  for all to authenticated
  using (true)
  with check (true);

-- 3) Bitácora (huella) de cambios
create table if not exists public.sva_reprocesos_log (
  id bigserial primary key,
  contenedor_norm text not null,
  arribo_ymd date not null,
  proceso text not null,
  field text not null,
  old_value text,
  new_value text,
  action text,
  changed_at timestamptz not null default now(),
  changed_by uuid
);

create index if not exists sva_reprocesos_log_key_idx
  on public.sva_reprocesos_log (contenedor_norm, arribo_ymd, proceso, changed_at desc);

alter table public.sva_reprocesos_log enable row level security;

drop policy if exists sva_log_select_auth on public.sva_reprocesos_log;
drop policy if exists sva_log_insert_auth on public.sva_reprocesos_log;

create policy sva_log_select_auth
  on public.sva_reprocesos_log
  for select to authenticated
  using (true);

create policy sva_log_insert_auth
  on public.sva_reprocesos_log
  for insert to authenticated
  with check (true);
